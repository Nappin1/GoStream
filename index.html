<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" type="image/png" href="images/G-icon.png">

    <!-- Relaxed CSP to prevent 'Failed to fetch' errors in preview environments -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src * 'unsafe-inline' 'unsafe-eval' data: gap:;
        style-src * 'unsafe-inline';
        script-src * 'unsafe-inline' 'unsafe-eval';
        img-src * data:;
        font-src * data:;
        connect-src *;
        frame-src *;
        media-src *;
    ">

    <title>Go Stream</title>

    <!-- Cordova script kept as requested, though it may 404 in this web preview -->
    <script src="cordova.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'nav-bp': '1025px' },
                    colors: {
                        'primary': 'var(--color-primary)',
                        'dark-bg': 'var(--bg-main)',
                        'card-bg': 'var(--bg-card)',
                        'nav-bg': 'var(--bg-nav)',
                        'border-color': 'var(--border-color)',
                        'text-main': 'var(--text-main)',
                        'text-muted': 'var(--text-muted)',
                        'input-bg': 'var(--bg-input)'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL VARIABLES & THEME --- */
        :root {
            --color-primary: #cae962;
            --bg-main: #202125;
            --bg-card: #2a2c31;
            --bg-nav: #1a1b1e;
            --bg-input: #111;
            --border-color: #333;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            outline: none;
            box-shadow: none;
            -webkit-tap-highlight-color: transparent;
        }

        button:focus {
            outline: none;
            box-shadow: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Selection */
        ::selection {
            background-color: var(--color-primary);
            color: #000;
        }

        /* Loader */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(128, 128, 128, 0.2);
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden-loader {
            display: none !important;
        }

        /* Nav Link Active State */
        .nav-link.active {
            color: var(--color-primary);
            font-weight: 700;
        }

        .nav-link {
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--color-primary);
        }

        /* Movie Card & Utilities */
        .vline {
            display: inline-block;
            width: 4px;
            background-color: var(--color-primary);
            margin-right: 10px;
            height: 2rem;
            vertical-align: middle;
        }

        .movie-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            overflow: hidden;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        /* Hover effects only for devices that support hover */
        @media (hover: hover) {
            .movie-card:hover {
                transform: scale(1.03);
                box-shadow: 0 10px 20px var(--shadow-color);
                border-color: var(--color-primary);
            }

            .movie-card:hover img {
                opacity: 0.8;
            }

            /* General button hover opacity if not handled by tailwind classes */
            button:hover {
                opacity: 0.9;
            }
        }

        .movie-card img {
            transition: opacity 0.2s ease-in-out;
        }

        .card-info {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 20%, rgba(0, 0, 0, 0));
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            scroll-behavior: smooth;
        }

        .horizontal-scroll-container .movie-card {
            flex-shrink: 0;
            width: 160px;
        }

        .horizontal-scroll-container .movie-card.landscape-card {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
        }

        /* Filter Selects */
        .filter-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 0.875rem;
            /* Adjusted padding for better text alignment with arrow */
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 0.375rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            cursor: pointer;
            outline: none;
            /* Responsive width handling */
            width: 100%;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 640px) {
            .filter-select {
                width: auto;
                min-width: 140px;
                max-width: 200px;
            }
        }

        .filter-select:hover {
            border-color: var(--color-primary);
        }

        /* Bottom Nav Specifics */
        .bottom-nav-item {
            color: #808080;
            transition: color 0.2s, transform 0.2s;
        }

        .bottom-nav-item.active {
            color: #ffffff;
        }

        .bottom-nav-item.active i {
            transform: scale(1.1);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        /* Utilities */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .line-clamp-2 {
            line-clamp: 2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            line-clamp: 3;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            padding: 1.5rem;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }

        /* Carousel Styles */
        .banner-bg-wrapper {
            position: absolute;
            inset: 0;
            transition: opacity 0.8s ease-in-out;
            opacity: 0;
            background-size: cover;
            background-position: center;
        }

        .banner-bg-wrapper.active {
            opacity: 1;
        }

        .carousel-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .carousel-indicator.active {
            background-color: var(--color-primary);
            width: 24px;
            border-radius: 4px;
        }

        .carousel-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .carousel-btn:hover {
            background-color: var(--color-primary);
            color: black;
        }
    </style>
</head>

<body>
    <div id="global-loader" class="hidden-loader">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-primary font-bold tracking-widest animate-pulse">LOADING</p>
        </div>
    </div>

    <nav id="navbar"
        class="fixed top-0 left-0 w-full z-50 bg-black border-b border-border-color transition-colors duration-300 pt-[env(safe-area-inset-top)]">
        <div class="px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <a onclick="router('home')" class="cursor-pointer">
                <h1 class="text-2xl outline-none tracking-tight font-extrabold text-text-main">Go<span
                        class="text-primary">Stream</span></h1>
            </a>
            <div class="hidden nav-bp:flex space-x-6 items-center outline-none">
                <a onclick="router('home')" class="nav-link text-text-main font-medium" data-target="home"><i
                        class="fas fa-house mr-2"></i>HOME</a>
                <a onclick="router('movies')" class="nav-link text-text-main font-medium" data-target="movies"><i
                        class="fas fa-clapperboard mr-2"></i>MOVIES</a>
                <a onclick="router('tv')" class="nav-link text-text-main font-medium" data-target="tv"><i
                        class="fas fa-tv mr-2"></i>TV SHOWS</a>
                <a onclick="router('anime-anilist')" class="nav-link text-text-main font-medium"
                    data-target="anime-anilist"><i class="fas fa-film mr-2"></i>ANIME</a>
                <a onclick="router('watchlist')" class="nav-link text-text-main font-medium" data-target="watchlist"><i
                        class="fas fa-lines-leaning mr-2"></i>LIBRARY</a>

            </div>
            <div class="flex items-center pl-3 space-x-4">
                <button onclick="installApp()" id="nav-install-btn"
                    class="hidden sm:flex items-center gap-2 text-text-muted hover:text-primary transition-colors text-sm font-bold">
                    <i class="fas fa-download"></i> Install
                </button>
                <div class="relative block">
                    <input id="global-search-input" type="text" placeholder="Search movies, people..."
                        class="bg-input-bg border border-border-color text-text-main text-sm rounded-md py-1.5 pl-8 pr-3 w-full focus:outline-none focus:border-primary transition-colors">
                    <i class="fas fa-search text-text-muted absolute left-3 top-1/2 -translate-y-1/2 text-xs"></i>
                </div>
            </div>
        </div>
    </nav>

    <div id="bottom-nav"
        class="nav-bp:hidden fixed bottom-4 left-4 right-4 bg-black/50 backdrop-blur-xl border-2 border-primary rounded-2xl z-50 flex justify-around items-center h-[60px] shadow-2xl">
        <button onclick="router('home')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1" data-target="home"><i
                class="fas fa-house"></i><span class="text-[10px] font-medium tracking-wide">Home</span></button>
        <button onclick="router('movies')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="movies"><i class="fas fa-clapperboard"></i><span
                class="text-[10px] font-medium tracking-wide">Movies</span></button>
        <button onclick="router('tv')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1" data-target="tv"><i
                class="fas fa-tv"></i><span class="text-[10px] font-medium tracking-wide">TV
                Shows</span></button>
        <button onclick="router('anime-anilist')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="anime-anilist"><i class="fas fa-film"></i><span
                class="text-[10px] font-medium tracking-wide">Anime</span></button>
        <button onclick="router('watchlist')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="watchlist"><i class="fas fa-lines-leaning"></i><span
                class="text-[10px] font-medium tracking-wide">Library</span></button>
    </div>

    <!-- Floating FAQ Button -->
    <div class="fixed bottom-24 right-5 z-[55]">
        <!-- First Button (FAQ - lower position) -->
        <button onclick="toggleFAQ()"
            class="relative w-10 h-10 rounded-full bg-card-bg text-white flex border-2 border-primary items-center justify-center shadow-lg hover:scale-110 transition-transform mb-2">
            <i class="fas fa-question text-sm"></i>
        </button>

        <!-- Second Button (Info - upper position) -->
        <button onclick="toggleFAQs()"
            class="relative w-10 h-10 rounded-full bg-card-bg text-white flex border-2 border-primary items-center justify-center shadow-lg hover:scale-110 transition-transform">
            <i class="fas fa-info text-sm"></i>
        </button>
    </div>

    <!-- FAQ Modal -->
    <div id="faq-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="toggleFAQ()" class="absolute top-4 right-4 text-text-muted hover:text-white"><i
                    class="fas fa-times text-lg"></i></button>
            <h2 class="text-xl font-bold text-text-main mb-4 border-b border-border-color pb-2">How to Use</h2>
            <div class="space-y-4 text-sm text-text-muted max-h-[60vh] overflow-y-auto">
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-search mr-2 text-primary"></i>1. Search</h3>
                    <p>Use the search bar at the top to find movies, TV shows, anime, or people. You can also browse by
                        category or use filters.</p>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-play-circle mr-2 text-primary"></i>2. Watch</h3>
                    <p>Click on a poster to view details. To watch, use the player at the top of the details page. If a
                        server doesn't work, try switching servers using the buttons above the player.</p>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-bookmark mr-2 text-primary"></i>3. Library</h3>
                    <p>Click the bookmark icon to add content to your personal library. Your progress is also saved
                        automatically in "Continue Watching".</p>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-download mr-2 text-primary"></i>4. Install</h3>
                    <p>For the best experience, install GoStream as an app.</p>
                    <p>Tap the menu icon (three dots) in the top right, then select <span
                            class="font-bold text-primary">Install App</span> or <span
                            class="font-bold text-primary">Add to Home Screen</span> on mobile.</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-border-color text-center">
                <button onclick="toggleFAQ()"
                    class="bg-primary text-black font-bold py-2 px-6 rounded hover:bg-opacity-80 transition-colors w-full sm:w-auto">Got
                    it!</button>
            </div>
        </div>
    </div>

    <div id="faqs-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="toggleFAQs()" class="absolute top-4 right-4 text-text-muted hover:text-white"><i
                    class="fas fa-times text-lg"></i></button>
            <h2 class="text-xl font-bold text-text-main mb-4 border-b border-border-color pb-2">Third-Party Hosting &
                Copyright Disclaimer</h2>
            <div class="space-y-4 text-sm text-text-muted max-h-[60vh] overflow-y-auto">
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-database mr-2 text-primary"></i>1. No Content
                        Hosting</h3>
                    <p><span class="font-bold text-primary">GoStream</span> acts strictly as a search index and
                        information retrieval tool. The Website does not host, upload, manage, or store any video,
                        audio, or media files on its own servers. All media content accessible through this Website is
                        embedded from external, third-party services.</p>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-network-wired mr-2 text-primary"></i>2.
                        Third-Party
                        Control</h3>
                    <p>Since the Website does not control the underlying media files, we cannot guarantee the
                        availability, accuracy, or permanence of any content. Issues such as:</p>
                    <p>&bull; Broken or dead links (404 errors).</p>
                    <p>&bull; Incorrect video titles or metadata.</p>
                    <p>&bull; Content removal due to DMCA takedowns or inactivity.</p>
                    <p>...are entirely outside the control of <span class="font-bold text-primary">GoStream</span>.
                        These technical issues originate
                        from the third-party file hosts (e.g., vidsrc).</p>
                </div>
                <div class="space-y-1">
                    <h3 class="font-bold text-white"><i class="fas fa-copyright mr-2 text-primary"></i>3. Copyright &
                        Removal Requests</h3>
                    <p>If you have legal concerns regarding copyright, please contact the original file host where the
                        media is stored. <span class="font-bold text-primary">GoStream</span> does not possess the files
                        and therefore cannot remove
                        them from the internet.</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-border-color text-center">
                <button onclick="toggleFAQs()"
                    class="bg-primary text-black font-bold py-2 px-6 rounded hover:bg-opacity-80 transition-colors w-full sm:w-auto">Got
                    it!</button>
            </div>
        </div>
    </div>

    <!-- Install Modal (Fallback) -->
    <div id="install-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="toggleInstallModal()" class="absolute top-4 right-4 text-text-muted hover:text-white"><i
                    class="fas fa-times text-lg"></i></button>
            <h2 class="text-xl font-bold text-text-main mb-4 border-b border-border-color pb-2"><i
                    class="fas fa-download mr-2 text-primary"></i>Install GoStream</h2>
            <div class="space-y-4 text-sm text-text-muted">
                <p>Install GoStream on your device for a fullscreen, app-like experience.</p>

                <div class="bg-input-bg p-3 rounded border border-border-color">
                    <h3 class="font-bold text-white mb-1"><i class="fab fa-apple mr-2"></i>iOS (Safari)</h3>
                    <p>Tap the <span class="font-bold text-primary">Share</span> button in the toolbar, then scroll down
                        and select <span class="font-bold text-primary">Add to Home Screen</span>.</p>
                </div>

                <div class="bg-input-bg p-3 rounded border border-border-color">
                    <h3 class="font-bold text-white mb-1"><i class="fab fa-android mr-2"></i>Android (Chrome)</h3>
                    <p>Tap the menu icon (three dots) in the top right, then select <span
                            class="font-bold text-primary">Install App</span> or <span
                            class="font-bold text-primary">Add to Home Screen</span>.</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-border-color text-center">
                <button onclick="toggleInstallModal()"
                    class="bg-input-bg border border-border-color text-white font-bold py-2 px-6 rounded hover:bg-white/10 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <main id="main-content" class="pt-16 pb-20 min-h-screen">
        <section id="shared-banner"
            class="relative h-[45vh] md:h-[65vh] flex items-end p-0 bg-dark-bg transition-all duration-500 hidden overflow-hidden group">

            <!-- Banner Background Layers -->
            <div id="banner-bg-container" class="absolute inset-0">
                <!-- JS will inject .banner-bg-wrapper divs here -->
            </div>

            <!-- Gradients -->
            <div
                class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent z-10 pointer-events-none">
            </div>
            <div
                class="absolute inset-0 bg-gradient-to-r from-dark-bg via-dark-bg/60 to-transparent z-10 pointer-events-none">
            </div>

            <!-- Carousel Controls -->
            <div
                class="absolute inset-0 z-30 flex justify-between items-center px-4 md:px-8 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                <button onclick="prevBanner()" class="carousel-btn pointer-events-auto"><i
                        class="fas fa-chevron-left"></i></button>
                <button onclick="nextBanner()" class="carousel-btn pointer-events-auto"><i
                        class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Banner Content -->
            <div class="z-20 w-full max-w-4xl relative p-4 md:p-12 mb-8 md:mb-0 fade-in">
                <div id="banner-content" class="transition-opacity duration-500"></div>

                <!-- Indicators -->
                <div id="banner-indicators" class="flex gap-2 mt-6"></div>
            </div>
        </section>

        <section id="view-home" class="view-section px-4 sm:px-6 lg:px-8 py-8 space-y-8 hidden">
            <div id="continue-watching-container" class="discovery-row hidden">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center">
                    <span class="vline"></span>Continue Watching
                    <button onclick="clearHistory()"
                        class="ml-auto text-xs text-text-muted hover:text-primary underline">Clear</button>
                </h2>
                <div id="row-continue-watching" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>

            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Trending Now</h2>
                <div id="row-trending" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Top Rated Movies</h2>
                <div id="row-top-rated" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Popular Action</h2>
                <div id="row-action" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
        </section>

        <section id="view-movies" class="view-section px-4 mt-8 mb-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Movies<sup class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="movies-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-movies" class="results-grid"></div>
            <div id="pag-movies" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-tv" class="view-section px-4 mt-8 mb-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>TV<sup class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="tv-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-tv" class="results-grid"></div>
            <div id="pag-tv" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-anime-anilist" class="view-section hidden w-full px-4 mt-8 mb-4 sm:px-6 lg:px-8">
            <!-- TABS -->
            <div class="flex items-center space-x-6 mb-6 border-b border-white/10 pb-1">
                <button onclick="switchAnilistTab('anime')" id="tab-btn-anime"
                    class="text-lg font-bold text-primary border-b-2 border-primary pb-2 transition-colors">Anime</button>
                <button onclick="switchAnilistTab('va')" id="tab-btn-va"
                    class="text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors">Voice
                    Actors</button>
            </div>

            <!-- TAB CONTENT: ANIME (Existing) -->
            <div id="anilist-tab-anime">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                            class="vline"></span>Anime<sup class="text-xs text-primary ml-2">ANILIST</sup></h2>
                    <div id="anilist-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="grid-anilist" class="results-grid"></div>
                <div id="pag-anilist" class="pagination-controls mt-8 flex justify-center gap-2">
                    <button onclick="changeAnilistPage(-1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-left"></i></button>
                    <span id="anilist-page-num" class="px-3 py-1 text-primary font-bold">1</span>
                    <button onclick="changeAnilistPage(1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- TAB CONTENT: VOICE ACTORS (New) -->
            <div id="anilist-tab-va" class="hidden w-full">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-3xl font-bold text-text-main flex items-center"><span
                            class="vline"></span>Voice Actors<sup class="text-xs text-primary ml-2">ANILIST</sup></h2>
                    <div class="relative w-full md:w-64">
                        <input id="va-search-input" type="text" placeholder="Search Voice Actors..."
                            class="bg-input-bg border border-border-color text-text-main text-sm rounded-md py-2 pl-8 pr-3 w-full focus:outline-none focus:border-primary transition-colors">
                        <i class="fas fa-search text-text-muted absolute left-3 top-1/2 -translate-y-1/2 text-xs"></i>
                    </div>
                </div>
                <div id="grid-anilist-va" class="results-grid"></div>
                <div id="pag-anilist-va" class="pagination-controls mt-8 flex justify-center gap-2">
                    <button onclick="changeAnilistVAPage(-1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-left"></i></button>
                    <span id="anilist-va-page-num" class="px-3 py-1 text-primary font-bold">1</span>
                    <button onclick="changeAnilistVAPage(1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <section id="view-watchlist" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Library<sup class="text-xs text-primary ml-2">TMDB | ANILIST</sup></h2>
            </div>
            <div id="grid-watchlist" class="results-grid"></div>
        </section>

        <section id="view-search" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <h2 class="text-2xl font-bold text-text-main mb-6">Search Results</h2>
            <div id="grid-search" class="results-grid"></div>
        </section>

        <section id="view-details" class="view-section hidden w-full">
            <div id="details-content" class="animate-fade-in"></div>
        </section>

        <section id="view-actor" class="view-section hidden w-full">
            <div id="actor-content" class="animate-fade-in"></div>
        </section>

        <section id="view-anilist-player" class="view-section hidden w-full bg-dark-bg">
            <div id="anilist-info-banner" class="w-full h-[300px] md:h-[400px] bg-cover bg-center relative">
                <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
            </div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                        <img id="anilist-info-img" src=""
                            class="w-[180px] hidden md:block md:w-full mx-auto md:mx-0 rounded shadow-2xl">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white block md:hidden flex items-center gap-2 text-sm font-medium"><i
                                class="fas fa-angles-left mr-2"></i> Back</button>
                        <div class="mb-6 bg-gradient-to-t from-dark-bg to-transparent">
                            <h1 id="anilist-player-title"
                                class="text-2xl md:text-4xl font-extrabold text-white mb-3 leading-tight"></h1>
                            <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-6">
                                <span id="anilist-banner-score" class="text-primary font-bold"></span>
                                <span id="anilist-banner-year"
                                    class="px-2 py-0.5 border border-border-color rounded"></span>
                                <span id="anilist-banner-type" class="uppercase"></span>
                                <span><button id="anilist-watchlist-btn"
                                        class="md:hover:bg-opacity-60 pt-4 py-2 px-3 bg-card-bg text-primary font-bold rounded-md transition-colors"><i
                                            class="material-icons">bookmark_add</i></button></span>
                            </div>
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                                <div id="anilist-info-desc"
                                    class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto pr-2">
                                </div>
                            </div>
                        </div>
                        <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                            <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>
                            <div>
                                <p id="anilist-info-Romaji" class="text-text-main text-xs font-medium italic"></p>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                                <div class="flex justify-between md:hidden"><span
                                        class="text-text-muted text-xs">Format</span>
                                    <p id="anilist-info-Type"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Status</span>
                                    <p id="anilist-info-Status"
                                        class="text-primary text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Episodes</span>
                                    <p id="anilist-info-Episodes"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Season</span>
                                    <p id="anilist-info-Season"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Start
                                        Date</span>
                                    <p id="anilist-info-Date"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Studios</span>
                                    <p id="anilist-info-Studio"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Producers</span>
                                    <p id="anilist-info-Producers"
                                        class="text-text-main text-xs font-medium text-right md:text-left line-clamp-2">
                                    </p>
                                </div>
                            </div>
                            <div><span class="text-text-muted text-xs">Genres</span>
                                <div id="anilist-info-Genres" class="flex flex-wrap gap-1 mt-1"></div>
                            </div>
                            <div class="mb-8 border-t border-border-color pt-2">
                                <h3 class="text-lg font-bold text-text-main mb-3">Cast & Voice Actors</h3>
                                <div id="anilist-cast-grid" class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 pt-4 md:pt-16 min-w-0">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white hidden md:block flex items-center gap-2 text-sm font-medium"><i
                                class="fas fa-angles-left mr-2"></i> Back</button>
                        <div class="mb-8 space-y-4">
                            <div class="rounded-lg overflow-hidden border border-border-color bg-black shadow-xl">
                                <div
                                    class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                                    <div class="flex items-center gap-2 text-primary font-bold"><i
                                            class="fas fa-play-circle"></i> <span id="anilist-player-ep">Episode
                                            1</span></div>
                                    <div id="anime-server-buttons" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="aspect-video relative bg-black"><iframe id="anilist-iframe"
                                        class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
                                <div
                                    class="bg-card-bg px-4 py-3 flex justify-between items-center border-t border-border-color">
                                    <button onclick="changeAnilistEp(-1)"
                                        class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium"><i
                                            class="fas fa-backward mr-1"></i> Prev</button>
                                    <button onclick="changeAnilistEp(1)"
                                        class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">Next
                                        <i class="fas fa-forward ml-1"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-text-main mb-3">Episodes</h3>
                            <div id="anilist-episodes-grid"
                                class="grid grid-cols-5 pt-4 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-40 overflow-y-auto custom-scroll pr-2">
                            </div>
                        </div>

                        <div id="anilist-info-Relations-Container"
                            class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color hidden">
                            <h4 class="text-lg font-bold text-text-main mb-3 border-b border-border-color">Relations
                            </h4>
                            <div id="anilist-info-Relations" class="horizontal-scroll-container p-2">
                            </div>
                        </div>
                        <div
                            class="mt-3 bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                            <h3 class="text-lg font-bold text-text-main mb-3">Recommendations</h3>
                            <div id="anilist-recommendations-grid" class="horizontal-scroll-container p-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-nav-bg py-6 hidden md:block border-t border-border-color mt-auto w-full">
        <div class="container mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <h2 class="text-lg font-bold text-text-main">Go<span class="text-primary">Stream</span></h2>
            </div>
            <p class="text-xs text-text-muted">GoStream does not store any files on our server, we only linked to the
                media which is hosted on 3rd party services.</p>
            <p id="credits" class="block text-sm text-text-muted sm:text-center">Â© <span
                    id="current-year-copyright">GoStream</span>. All rights reserved.</p>
        </div>
    </footer>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <script>
        /**
         * GLOBAL CONFIGURATION & DATA
         */
        // UPDATED API KEY - The previous one was likely revoked or invalid
        const API_KEY = '3fd2be6f0c70a2a598f084ddfb75487c';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_URL = 'https://image.tmdb.org/t/p/original';
        const ANILIST_API_URL = 'https://graphql.anilist.co';

        const MOVIE_SOURCES = [
            { name: '1', url: (id) => `https://vidsrc.cc/v2/embed/movie/${id}?autoPlay=true` },
            { name: '2', url: (id) => `https://vidsrc.icu/embed/movie/${id}` },
            { name: '3', url: (id) => `https://vidlink.pro/movie/${id}` },
            { name: '4', url: (id) => `https://111movies.com/movie/${id}` },
            { name: '5', url: (id) => `https://vidrock.net/movie/${id}?autoplay=true&download=false` },
            { name: '6', url: (id) => `https://player.videasy.net/movie/${id}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const TV_SOURCES = [
            { name: '1', url: (id, s, e) => `https://vidsrc.cc/v2/embed/tv/${id}/${s}/${e}?autoPlay=true` },
            { name: '2', url: (id, s, e) => `https://vidsrc.icu/embed/tv/${id}/${s}/${e}` },
            { name: '3', url: (id, s, e) => `https://vidlink.pro/tv/${id}/${s}/${e}?title=true&poster=true&autoplay=true&nextbutton=true` },
            { name: '4', url: (id, s, e) => `https://111movies.com/tv/${id}/${s}/${e}` },
            { name: '5', url: (id, s, e) => `https://vidrock.net/tv/${id}/${s}/${e}?autoplay=true&download=false&episodeselector=false&enlang` },
            { name: '6', url: (id, s, e) => `https://player.videasy.net/tv/${id}/${s}/${e}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const ANIME_SOURCES = [
            { name: '1', url: (id, ep) => `https://vidsrc.cc/v2/embed/anime/ani${id}/${ep}/sub` },
            { name: '2', url: (id, ep) => `https://vidsrc.icu/embed/anime/${id}/${ep}/0` },
            { name: '3', url: (id, ep) => `https://vidnest.fun/animepahe/${id}/${ep}/SUB` }
        ];

        // Constants for Filters
        const COUNTRIES = [
            { code: '', name: 'All Countries' }, { code: 'CN', name: 'China' }, { code: 'FR', name: 'France' },
            { code: 'HK', name: 'Hongkong' }, { code: 'IN', name: 'India' }, { code: 'JP', name: 'Japan' },
            { code: 'RU', name: 'Russia' }, { code: 'KR', name: 'South Korea' }, { code: 'ES', name: 'Spain' },
            { code: 'TH', name: 'Thailand' }, { code: 'TR', name: 'Turkey' }, { code: 'GB', name: 'United Kingdom' },
            { code: 'US', name: 'United States' }
        ];

        const TMDB_GENRES = [
            { id: '', name: 'All Genres' }, { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 14, name: 'Fantasy' }, { id: 36, name: 'History' }, { id: 27, name: 'Horror' },
            { id: 10402, name: 'Music' }, { id: 9648, name: 'Mystery' }, { id: 10749, name: 'Romance' }, { id: 878, name: 'Sci-Fi' },
            { id: 53, name: 'Thriller' }
        ];

        const MOVIE_GENRES = TMDB_GENRES;
        const TV_GENRES = [
            { id: '', name: 'All Genres' }, { id: 10759, name: 'Action & Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 10762, name: 'Kids' }, { id: 9648, name: 'Mystery' }, { id: 10763, name: 'News' },
            { id: 10764, name: 'Reality' }, { id: 10765, name: 'Sci-Fi & Fantasy' }, { id: 10766, name: 'Soap' }, { id: 10767, name: 'Talk' },
            { id: 10768, name: 'War & Politics' }, { id: 37, name: 'Western' }
        ];

        const TV_STATUS = [
            { value: '', name: 'All Status' }, { value: '0', name: 'Returning Series' }, { value: '3', name: 'Ended' },
            { value: '4', name: 'Canceled' }, { value: '2', name: 'In Production' }, { value: '5', name: 'Pilot' }
        ];

        const MOVIE_STATUS = [
            { value: '', name: 'All Status' }, { value: 'released', name: 'Released' }, { value: 'upcoming', name: 'Upcoming' }
        ];

        const ANILIST_GENRES = [
            'Action', 'Adventure', 'Comedy', 'Drama', 'Ecchi', 'Fantasy', 'Horror', 'Mecha', 'Music', 'Mystery',
            'Psychological', 'Romance', 'Sci-Fi', 'Slice of Life', 'Sports', 'Supernatural', 'Thriller'
        ];

        // Global State
        const appState = {
            currentView: 'home',
            lastView: 'home',
            watchlist: JSON.parse(localStorage.getItem('goStreamWatchlist')) || [],
            continueWatching: JSON.parse(localStorage.getItem('goStreamContinueWatching')) || [],
            bannerInterval: null,
            bannerItems: [],
            bannerIndex: 0,
            tmdb: {
                movies: { page: 1, filters: { sort: 'popularity.desc', genre: '', country: '', status: '', year: '' }, data: [] },
                tv: { page: 1, filters: { sort: 'popularity.desc', genre: '', country: '', status: '', year: '' }, data: [] }
            },
            anilist: {
                currentTab: 'anime', // anime or va
                page: 1,
                filters: { sort: 'TRENDING_DESC', genre: '', country: '', upcoming: '', year: '' },
                data: [],
                hero: [],
                currentAnime: null,
                currentEp: 1,
                currentServerIdx: 0,
                // Voice Actor State
                vaPage: 1,
                vaSearch: '',
                vaData: []
            }
        };

        /**
         * CORE UTILITIES
         */
        const loader = {
            count: 0,
            show: () => {
                loader.count++;
                document.getElementById('global-loader').classList.remove('hidden-loader');
            },
            hide: () => {
                loader.count--;
                if (loader.count <= 0) {
                    loader.count = 0;
                    document.getElementById('global-loader').classList.add('hidden-loader');
                }
            }
        };

        const getPosterUrl = (path) => {
            if (!path) return 'https://placehold.co/500x750/333/FFF?text=No+Image';
            return path.startsWith('http') ? path : IMG_URL + path;
        };

        const getBackdropUrl = (path) => {
            if (!path) return 'https://placehold.co/1920x1080/202125/FFF?text=No+Banner+available';
            return path.startsWith('http') ? path : BACKDROP_URL + path;
        };

        function stopBannerRotation() {
            if (appState.bannerInterval) {
                clearInterval(appState.bannerInterval);
                appState.bannerInterval = null;
            }
        }

        function router(viewName) {
            const tmdbFrame = document.getElementById('tmdb-player');
            const aniFrame = document.getElementById('anilist-iframe');
            if (tmdbFrame) tmdbFrame.src = "";
            if (aniFrame) aniFrame.src = "";

            stopBannerRotation();

            // List of top-level navigation pages
            const mainViews = ['home', 'movies', 'tv', 'anime-anilist', 'watchlist'];

            // 1. Update History Strategy
            // If we are currently on a main view, and we are navigating AWAY to a sub-view (details/search/player)
            // OR simply navigating to another main view, save it as lastView.
            if (mainViews.includes(appState.currentView)) {
                appState.lastView = appState.currentView;
            }

            // 2. Determine Active Tab Highlighting
            // Default target is the view we are going to
            let activeTarget = viewName;

            // If the destination is NOT a main view (e.g. details, search, player, actor),
            // fallback to highlighting the last visited main view.
            if (!mainViews.includes(viewName)) {
                activeTarget = appState.lastView || 'home';
            }

            // Apply classes
            document.querySelectorAll('.nav-link').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.bottom-nav-item').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('shared-banner').classList.add('hidden');

            appState.currentView = viewName;
            window.scrollTo(0, 0);

            switch (viewName) {
                case 'home':
                    document.getElementById('view-home').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    loadHomeData();
                    break;
                case 'movies':
                    document.getElementById('view-movies').classList.remove('hidden');
                    appState.tmdb.movies.page = 1; // Reset pagination
                    renderFilters('movies');
                    loadTMDBSection('movies', '/discover/movie');
                    break;
                case 'tv':
                    document.getElementById('view-tv').classList.remove('hidden');
                    appState.tmdb.tv.page = 1; // Reset pagination
                    renderFilters('tv');
                    loadTMDBSection('tv', '/discover/tv');
                    break;
                case 'anime-anilist':
                    document.getElementById('view-anime-anilist').classList.remove('hidden');
                    renderFilters('anilist');
                    switchAnilistTab(appState.anilist.currentTab); // Load current active tab
                    break;
                case 'watchlist':
                    document.getElementById('view-watchlist').classList.remove('hidden');
                    renderWatchlist();
                    break;
                case 'search':
                    document.getElementById('view-search').classList.remove('hidden');
                    break;
                case 'details':
                    document.getElementById('view-details').classList.remove('hidden');
                    break;
                case 'anilist-player':
                    document.getElementById('view-anilist-player').classList.remove('hidden');
                    break;
                case 'actor':
                    document.getElementById('view-actor').classList.remove('hidden');
                    break;
            }
        }

        /**
         * FEATURE: Continue Watching
         */
        function addToHistory(id, type, title, poster, backdrop, season = null, episode = null) {
            // Remove if exists
            appState.continueWatching = appState.continueWatching.filter(i => i.id !== id);
            // Add to top
            appState.continueWatching.unshift({
                id, type, title, poster, backdrop, season, episode, timestamp: new Date().getTime()
            });
            // Limit to 20
            if (appState.continueWatching.length > 20) appState.continueWatching.pop();

            localStorage.setItem('goStreamContinueWatching', JSON.stringify(appState.continueWatching));
        }

        function clearHistory() {
            appState.continueWatching = [];
            localStorage.removeItem('goStreamContinueWatching');
            renderContinueWatching();
        }

        function renderContinueWatching() {
            const container = document.getElementById('row-continue-watching');
            const wrapper = document.getElementById('continue-watching-container');

            container.innerHTML = '';

            if (appState.continueWatching.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }

            wrapper.classList.remove('hidden');

            appState.continueWatching.forEach(item => {
                // Use backdrop if available, otherwise poster
                let imgUrl;
                if (item.backdrop) {
                    imgUrl = getBackdropUrl(item.backdrop);
                } else {
                    imgUrl = getPosterUrl(item.poster);
                }

                const card = document.createElement('div');
                card.className = 'movie-card cursor-pointer rounded relative group';

                let badge = '';
                if (item.type === 'tv' && item.season) {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">S${item.season} E${item.episode}</div>`;
                } else if (item.type === 'anime') {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">EP ${item.episode}</div>`;
                }

                // Use aspect-video (landscape) to match other home rows
                card.innerHTML = `
                    <div class="aspect-video overflow-hidden relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        ${badge}
                        <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                            <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-3 card-info">
                        <h3 class="text-text-main text-sm font-semibold truncate">${item.title}</h3>
                        <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                            <span class="uppercase text-[10px]">Resume</span>
                            <span class="uppercase border border-border-color px-1 rounded text-[10px]">${item.type}</span>
                        </div>
                    </div>
                `;

                card.onclick = () => {
                    if (item.type === 'anime') {
                        // Pre-load specific anime episode (needs slight mod to openAnilistPlayer)
                        openAnilistPlayer(item.id, item.episode);
                    } else {
                        openDetails(item.id, item.type, item.season, item.episode);
                    }
                };
                container.appendChild(card);
            });
        }


        /**
         * FILTER LOGIC
         */
        function renderFilters(section) {
            const containerId = section === 'anilist' ? 'anilist-filters' : `${section}-filters`;
            const container = document.getElementById(containerId);
            if (!container || container.innerHTML !== '') return;

            // Apply responsive layout classes: Grid on mobile (2 cols), Flex on desktop
            container.className = 'grid grid-cols-2 sm:flex sm:flex-wrap gap-2 w-full sm:w-auto items-center';

            const isAnilist = section === 'anilist';
            const stateRef = isAnilist ? appState.anilist.filters : appState.tmdb[section].filters;

            const sortSelect = document.createElement('select');
            sortSelect.className = 'filter-select';
            if (isAnilist) {
                sortSelect.innerHTML = `
                <option value="TRENDING_DESC">Trending</option>
                <option value="POPULARITY_DESC">Popular</option>
                <option value="SCORE_DESC">Top Rated</option>`;
            } else {
                sortSelect.className = 'hidden';
            }
            sortSelect.value = stateRef.sort;
            sortSelect.onchange = (e) => {
                stateRef.sort = e.target.value;
                resetAndLoad(section);
            };

            const genreSelect = document.createElement('select');
            genreSelect.className = 'filter-select';
            if (isAnilist) {
                genreSelect.innerHTML = `<option value="">All Genres</option>` + ANILIST_GENRES.map(g => `<option value="${g}">${g}</option>`).join('');
            } else if (section === 'movies') {
                genreSelect.innerHTML = MOVIE_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            } else {
                genreSelect.innerHTML = TV_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            }

            genreSelect.value = stateRef.genre;
            genreSelect.onchange = (e) => {
                stateRef.genre = e.target.value;
                resetAndLoad(section);
            };

            const statusSelect = document.createElement('select');
            statusSelect.className = 'filter-select';
            if (section === 'movies') {
                statusSelect.innerHTML = MOVIE_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else if (!isAnilist) {
                statusSelect.innerHTML = TV_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else {
                statusSelect.classList.add('hidden');
            }
            if (!isAnilist) {
                statusSelect.value = stateRef.status;
                statusSelect.onchange = (e) => {
                    stateRef.status = e.target.value;
                    resetAndLoad(section);
                };
            }

            const countrySelect = document.createElement('select');
            countrySelect.className = 'filter-select';
            countrySelect.innerHTML = COUNTRIES.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            countrySelect.value = stateRef.country;
            countrySelect.onchange = (e) => {
                stateRef.country = e.target.value;
                resetAndLoad(section);
            };

            container.append(sortSelect, genreSelect);
            if (!isAnilist) container.append(statusSelect, countrySelect);

            if (isAnilist) {
                const upcomingSelect = document.createElement('select');
                upcomingSelect.className = 'filter-select';
                upcomingSelect.innerHTML = `
                    <option value="">Upcoming: Off</option>
                    <option value="POPULARITY_DESC">Upcoming: Popularity</option>
                    <option value="TRENDING_DESC">Upcoming: Trending</option>
                    <option value="START_DATE">Upcoming: Release Date</option>
                `;
                upcomingSelect.value = stateRef.upcoming;
                upcomingSelect.onchange = (e) => {
                    stateRef.upcoming = e.target.value;
                    resetAndLoad(section);
                };
                container.append(upcomingSelect);
            }

            // --- ADDED YEAR FILTER (Global for Movies/TV/Anime) ---
            const yearSelect = document.createElement('select');
            yearSelect.className = 'filter-select';

            const currentYear = new Date().getFullYear() + 1; // Allow next year for upcoming
            let yearOptions = '<option value="">All Years</option>';
            for (let y = currentYear; y >= 1970; y--) {
                yearOptions += `<option value="${y}">${y}</option>`;
            }
            yearSelect.innerHTML = yearOptions;

            yearSelect.value = stateRef.year;
            yearSelect.onchange = (e) => {
                stateRef.year = e.target.value;
                resetAndLoad(section);
            };
            container.append(yearSelect);
        }

        function resetAndLoad(section) {
            if (section === 'anilist') {
                appState.anilist.page = 1;
                loadAnilistSection();
            } else {
                appState.tmdb[section].page = 1;
                const endpoint = section === 'movies' ? '/discover/movie' : '/discover/tv';
                loadTMDBSection(section, endpoint);
            }
        }

        /**
         * TMDB API
         */
        async function fetchTMDB(endpoint, params = {}, showLoader = true) {
            if (showLoader) loader.show();
            params.api_key = API_KEY;
            const qs = new URLSearchParams(params).toString();
            try {
                const res = await fetch(`${TMDB_BASE_URL}${endpoint}?${qs}`);
                const data = await res.json();
                if (showLoader) loader.hide();
                return data;
            } catch (e) {
                console.error("TMDB Error", e);
                if (showLoader) loader.hide();
                return null;
            }
        }

        async function loadHomeData() {
            // Render Continue Watching first
            renderContinueWatching();

            const container = document.getElementById('row-trending');
            if (container.innerHTML !== '') return;

            // Fetch TMDB Trending
            const trendingTMDBPromise = fetchTMDB('/trending/all/day');

            // Fetch Anilist Trending for Banner
            const anilistQuery = `
            query {
                Page(page: 1, perPage: 6) {
                    media(sort: TRENDING_DESC, type: ANIME, isAdult: false) {
                        id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear
                    }
                }
            }`;
            const anilistPromise = fetchAnilist(anilistQuery);

            const topRatedPromise = fetchTMDB('/movie/top_rated');
            const actionPromise = fetchTMDB('/discover/movie', { with_genres: 28 });

            const [trendingTMDB, anilistData, topRated, action] = await Promise.all([
                trendingTMDBPromise,
                anilistPromise,
                topRatedPromise,
                actionPromise
            ]);

            // Combine for Banner: Top 5 TMDB + Top 5 Anilist
            let bannerCandidates = [];
            if (trendingTMDB && trendingTMDB.results) {
                renderTMDBGrid('row-trending', trendingTMDB.results, null, true);
                bannerCandidates = [...bannerCandidates, ...trendingTMDB.results.slice(0, 6)];
            }

            if (anilistData && anilistData.Page && anilistData.Page.media) {
                const mappedAnilist = anilistData.Page.media.map(mapAnilistToShared);
                bannerCandidates = [...bannerCandidates, ...mappedAnilist];
            }

            // Shuffle once for randomness as requested, but then act as a carousel
            appState.bannerItems = bannerCandidates.sort(() => 0.5 - Math.random());

            if (appState.bannerItems.length > 0) {
                appState.bannerIndex = 0;
                renderBannerIndicators();
                updateSharedBanner();
                startBannerRotation();
            }

            if (topRated) renderTMDBGrid('row-top-rated', topRated.results, null, true);
            if (action) renderTMDBGrid('row-action', action.results, null, true);
        }

        function startBannerRotation() {
            if (appState.bannerInterval) clearInterval(appState.bannerInterval);
            appState.bannerInterval = setInterval(() => {
                nextBanner();
            }, 5000);
        }

        function nextBanner() {
            appState.bannerIndex = (appState.bannerIndex + 1) % appState.bannerItems.length;
            updateSharedBanner();
            startBannerRotation(); // Reset timer on manual interaction
        }

        function prevBanner() {
            appState.bannerIndex = (appState.bannerIndex - 1 + appState.bannerItems.length) % appState.bannerItems.length;
            updateSharedBanner();
            startBannerRotation(); // Reset timer
        }

        function goToBanner(index) {
            appState.bannerIndex = index;
            updateSharedBanner();
            startBannerRotation();
        }

        function renderBannerIndicators() {
            const container = document.getElementById('banner-indicators');
            container.innerHTML = '';
            appState.bannerItems.forEach((_, idx) => {
                const dot = document.createElement('div');
                dot.className = `carousel-indicator ${idx === 0 ? 'active' : ''}`;
                dot.onclick = () => goToBanner(idx);
                container.appendChild(dot);
            });
        }

        function updateSharedBanner() {
            const item = appState.bannerItems[appState.bannerIndex];
            if (!item) return;

            const bgUrl = getBackdropUrl(item.backdrop_path);
            const container = document.getElementById('banner-bg-container');

            // Background Fade Logic
            const newBg = document.createElement('div');
            newBg.className = 'banner-bg-wrapper';
            newBg.style.backgroundImage = `url(${bgUrl})`;
            container.appendChild(newBg);

            // Force reflow
            void newBg.offsetWidth;
            newBg.classList.add('active');

            // Remove old backgrounds
            if (container.children.length > 1) {
                setTimeout(() => {
                    if (container.children.length > 1) {
                        container.removeChild(container.firstElementChild);
                    }
                }, 800); // Match CSS transition duration
            }

            const title = item.title || item.name;
            const desc = item.overview || 'No description available.';
            const type = item.media_type || 'movie';
            const safeTitle = title.replace(/'/g, "");
            const vote = item.vote_average || 0;
            const date = item.release_date || item.first_air_date || '';
            const year = date.split('-')[0] || '';

            const contentDiv = document.getElementById('banner-content');

            // Fade out content slightly before changing
            contentDiv.style.opacity = '0';

            setTimeout(() => {
                contentDiv.innerHTML = `
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-4 drop-shadow-xl text-white line-clamp-2">${title}</h1>
                    <p class="text-gray-300 text-sm md:text-lg mb-6 drop-shadow-md line-clamp-3">${desc}</p>
                    <div class="flex">
                        <button class="bg-gray-600 md:hover:bg-opacity-60 text-white font-bold py-2 px-5 rounded-l-md transition-colors" onclick="openDetailsWrapper(${item.id}, '${type}')">
                            <i class="fas fa-play mr-2"></i> Play Now
                        </button>
                        <button id="banner-watchlist-btn-${item.id}" class="md:hover:bg-opacity-60 pt-4 py-2 px-3 bg-card-bg text-primary font-bold rounded-r-md transition-colors" onclick="toggleWatchlist(${item.id}, '${type}', '${safeTitle}', '${item.poster_path}', 'banner-watchlist-btn-${item.id}', ${vote}, '${year}')">
                            <i class="material-icons">bookmark_add</i>
                        </button>
                    </div>
                `;
                contentDiv.style.opacity = '1';
                updateWatchlistButtonState(item.id, `banner-watchlist-btn-${item.id}`);
            }, 300); // Short delay for content fade

            // Update Indicators
            const dots = document.querySelectorAll('.carousel-indicator');
            dots.forEach((d, i) => {
                if (i === appState.bannerIndex) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        async function loadTMDBSection(key, endpoint, extraParams = {}) {
            const stateRef = appState.tmdb[key];
            const gridId = `grid-${key}`;
            const grid = document.getElementById(gridId);

            loader.show();

            const params = {
                page: stateRef.page,
                sort_by: stateRef.filters.sort,
                language: 'en-US',
                'vote_count.gte': 0,
                ...extraParams
            };

            const today = new Date().toISOString().split('T')[0];

            if (stateRef.filters.status) {
                if (key === 'movies') {
                    if (stateRef.filters.status === 'upcoming') {
                        params['primary_release_date.gte'] = today;
                    } else if (stateRef.filters.status === 'released') {
                        params['primary_release_date.lte'] = today;
                    }
                } else {
                    params.with_status = stateRef.filters.status;
                }
            }

            if ((stateRef.filters.sort.includes('date') || stateRef.filters.sort.includes('first_air_date'))) {
                if (stateRef.filters.status !== 'upcoming') {
                    if (key === 'movies') params['primary_release_date.lte'] = today;
                    else params['first_air_date.lte'] = today;
                }
                delete params['vote_count.gte'];
                params['vote_count.gte'] = 0;
            }

            if (stateRef.filters.genre) params.with_genres = stateRef.filters.genre;
            if (stateRef.filters.country) params.with_origin_country = stateRef.filters.country;

            // --- ADDED YEAR FILTER LOGIC ---
            if (stateRef.filters.year) {
                if (key === 'movies') params.primary_release_year = stateRef.filters.year;
                else params.first_air_date_year = stateRef.filters.year;
            }

            const data = await fetchTMDB(endpoint, params, false);

            grid.innerHTML = '';
            if (data && data.results && data.results.length > 0) {
                // Banner is now handled separately in loadHomeData for the Home view.
                // For sub-pages (Movies/TV), we usually don't have a banner, but if we did, we'd update it here.
                // Since shared-banner is hidden in sub-views per router logic, we skip banner update here.

                await renderTMDBGrid(gridId, data.results, key === 'movies' ? 'movie' : 'tv');

                renderPagination(`pag-${key}`, stateRef.page, data.total_pages, (p) => {
                    stateRef.page = p;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    loadTMDBSection(key, endpoint, extraParams);
                });
            } else {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No results found.</p>';
            }
            loader.hide();
        }

        /**
         * ANILIST API
         */
        async function fetchAnilist(query, variables = {}) {
            loader.show();
            try {
                const res = await fetch(ANILIST_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });
                const json = await res.json();
                loader.hide();
                return json.data;
            } catch (e) {
                console.error("Anilist Error", e);
                loader.hide();
                return null;
            }
        }

        function mapAnilistToShared(anime) {
            return {
                id: anime.id,
                title: anime.title.english || anime.title.romaji,
                name: anime.title.english || anime.title.romaji,
                overview: anime.description,
                backdrop_path: anime.bannerImage || anime.coverImage.extraLarge,
                poster_path: anime.coverImage.extraLarge,
                vote_average: (anime.averageScore || 0) / 10,
                media_type: 'anime',
                release_date: anime.seasonYear ? String(anime.seasonYear) : 'N/A',
                status: anime.status
            };
        }

        // --- NEW: Tab Switching Logic for Anime Section ---
        function switchAnilistTab(tab) {
            appState.anilist.currentTab = tab;
            const animeTab = document.getElementById('anilist-tab-anime');
            const vaTab = document.getElementById('anilist-tab-va');
            const btnAnime = document.getElementById('tab-btn-anime');
            const btnVa = document.getElementById('tab-btn-va');

            if (tab === 'anime') {
                animeTab.classList.remove('hidden');
                vaTab.classList.add('hidden');

                // Active Styles
                btnAnime.classList.add('text-primary', 'border-b-2', 'border-primary');
                btnAnime.classList.remove('text-text-muted', 'hover:text-white');

                // Inactive Styles
                btnVa.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btnVa.classList.add('text-text-muted', 'hover:text-white');

                // Reset Pagination & Load Data
                appState.anilist.page = 1;
                loadAnilistSection();

            } else {
                animeTab.classList.add('hidden');
                vaTab.classList.remove('hidden');

                // Active Styles
                btnVa.classList.add('text-primary', 'border-b-2', 'border-primary');
                btnVa.classList.remove('text-text-muted', 'hover:text-white');

                // Inactive Styles
                btnAnime.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btnAnime.classList.add('text-text-muted', 'hover:text-white');

                // Reset Pagination & Load Data
                appState.anilist.vaPage = 1;
                loadAnilistVoiceActors();
            }
        }

        async function loadAnilistSection() {
            const state = appState.anilist;
            const gridId = 'grid-anilist';
            const grid = document.getElementById(gridId);

            const query = `
            query ($page: Int, $sort: [MediaSort], $genre: String, $country: CountryCode, $status: MediaStatus, $year: Int) {
                Page(page: $page, perPage: 24) {
                    pageInfo { hasNextPage }
                    media(sort: $sort, genre: $genre, countryOfOrigin: $country, status: $status, seasonYear: $year, type: ANIME, isAdult: false) {
                        id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear
                    }
                }
            }`;

            const vars = { page: state.page };

            if (state.filters.upcoming) {
                vars.status = 'NOT_YET_RELEASED';
                vars.sort = state.filters.upcoming;
            } else {
                vars.sort = state.filters.sort;
            }

            if (state.filters.genre) vars.genre = state.filters.genre;
            if (state.filters.country) vars.country = state.filters.country;
            if (state.filters.year) vars.year = parseInt(state.filters.year);

            const data = await fetchAnilist(query, vars);
            if (data && data.Page.media) {
                state.data = data.Page.media;
                const mappedData = state.data.map(mapAnilistToShared);

                renderAnilistGrid(gridId, mappedData);
                document.getElementById('anilist-page-num').innerText = state.page;
            }
        }

        // --- NEW: Voice Actor Loading Logic ---
        async function loadAnilistVoiceActors() {
            const gridId = 'grid-anilist-va';
            const grid = document.getElementById(gridId);
            const state = appState.anilist;

            const query = `
            query ($page: Int, $search: String) {
                Page(page: $page, perPage: 24) {
                    pageInfo { total perPage currentPage lastPage hasNextPage }
                    staff(search: $search, sort: [FAVOURITES_DESC]) {
                        id
                        name { full }
                        image { large }
                        primaryOccupations
                    }
                }
            }`;

            const vars = { page: state.vaPage };
            if (state.vaSearch && state.vaSearch.trim() !== '') {
                vars.search = state.vaSearch;
            }

            const data = await fetchAnilist(query, vars);

            grid.innerHTML = '';
            if (data && data.Page.staff) {
                state.vaData = data.Page.staff;

                if (state.vaData.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No voice actors found.</p>';
                } else {
                    state.vaData.forEach(staff => {
                        const imgUrl = staff.image ? staff.image.large : 'https://placehold.co/300x450/333/FFF?text=No+Image';
                        const occupations = staff.primaryOccupations ? staff.primaryOccupations[0] : 'Voice Actor';

                        // Using createCardHTML adapted for VA
                        // We use 'actor' type to trigger the round icon logic in standard card creation, 
                        // but since createCardHTML is strict about layout, we'll manually create a nice card for VAs or reuse.
                        // Actually, reusing createCardHTML with type 'actor' works well if we tweak the click handler.

                        const card = createCardHTML(
                            staff.id,
                            'actor', // Visual style
                            staff.name.full,
                            imgUrl,
                            null, // No rating 
                            occupations, // Subtext instead of year
                            '',
                            false,
                            null
                        );

                        // OVERRIDE CLICK for Voice Actor
                        card.onclick = () => openVoiceActorDetails(staff.id);

                        grid.appendChild(card);
                    });
                }

                document.getElementById('anilist-va-page-num').innerText = state.vaPage;
            }
        }

        function changeAnilistPage(dir) {
            const currentPage = parseInt(appState.anilist.page) || 1;
            const next = currentPage + dir;
            if (next > 0) {
                appState.anilist.page = next;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                loadAnilistSection();
            }
        }

        // --- NEW: Voice Actor Pagination ---
        function changeAnilistVAPage(dir) {
            const currentPage = parseInt(appState.anilist.vaPage) || 1;
            const next = currentPage + dir;
            if (next > 0) {
                appState.anilist.vaPage = next;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                loadAnilistVoiceActors();
            }
        }

        // --- NEW: Voice Actor Search Listener ---
        const vaSearchInput = document.getElementById('va-search-input');

        vaSearchInput.addEventListener('keydown', (e) => {
            // Check if the key pressed is 'Enter' (key code 13)
            if (e.key === 'Enter') {
                // Prevent the default behavior of the Enter key (like form submission)
                e.preventDefault();

                // Execute the search function immediately
                appState.anilist.vaSearch = e.target.value;
                appState.anilist.vaPage = 1;
                loadAnilistVoiceActors();
                vaSearchInput.value = '';
            }
        });

        // Updated to accept an optional startEpisode
        async function openAnilistPlayer(id, startEpisode = 1) {
            router('anilist-player');
            const state = appState.anilist;

            const query = `query ($id: Int) { Media(id: $id) { id title { romaji english } 
            description 
            coverImage { extraLarge } 
            bannerImage
            episodes
                    nextAiringEpisode { episode }
                    averageScore
                    format
                    duration
                    status
                    season
                    seasonYear
                    studios { nodes { name isAnimationStudio } }
                    startDate { year month day }
                    genres
                    description
                    relations { edges { relationType node { id title { romaji } seasonYear averageScore format status coverImage { extraLarge } } } }
                    recommendations(sort: RATING_DESC, perPage: 10) {
                        nodes {
                            mediaRecommendation {
                                id
                                title { romaji english }
                                coverImage { extraLarge }
                                bannerImage
                                format
                                averageScore
                                status
                                seasonYear
                            }
                        }
                    }
                    characters(page: 1, perPage: 25, sort: [ROLE, FAVOURITES_DESC]) {
                    edges {
                    role
                    voiceActors(language: JAPANESE, sort: [FAVOURITES_DESC]) {
                    id
                    name { full } image { medium } }
                    node { id name { userPreferred } image { medium }
                    }
                    }
                }
            } }`;

            const data = await fetchAnilist(query, { id });
            // FIX START
            if (!data || !data.Media) return;
            const anime = data.Media;
            // FIX END
            state.currentAnime = anime;
            state.currentEp = startEpisode; // Use provided startEpisode

            const bannerUrl = getBackdropUrl(anime.bannerImage || anime.coverImage.extraLarge);
            document.getElementById('anilist-info-banner').style.backgroundImage = `url(${bannerUrl})`;
            document.getElementById('anilist-player-title').innerText = anime.title.english || anime.title.romaji;
            document.getElementById('anilist-info-img').src = anime.coverImage.extraLarge;
            const score = (anime.averageScore || '??') + '% Score';
            document.getElementById('anilist-banner-score').innerText = score;
            document.getElementById('anilist-banner-type').innerText = anime.format || 'TV';
            const yearStr = anime.seasonYear || (anime.startDate && anime.startDate.year ? anime.startDate.year : 'N/A');
            document.getElementById('anilist-banner-year').innerText = yearStr;
            document.getElementById('anilist-info-desc').innerHTML = anime.description;
            document.getElementById('anilist-info-Romaji').innerText = anime.title.romaji;
            document.getElementById('anilist-info-Type').innerText = anime.format;
            document.getElementById('anilist-info-Status').innerText = anime.status ? anime.status.replace(/_/g, ' ') : 'Unknown';
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            document.getElementById('anilist-info-Date').innerText = anime.startDate && anime.startDate.year ? `${months[anime.startDate.month - 1]} ${anime.startDate.day} ${anime.startDate.year}` : '?';

            const currentAired = anime.nextAiringEpisode ? anime.nextAiringEpisode.episode - 1 : (anime.episodes || '?');
            const totalEps = anime.episodes || '?';
            document.getElementById('anilist-info-Episodes').innerText = `${currentAired} / ${totalEps}`;

            const seas = anime.season ? anime.season.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : '';
            document.getElementById('anilist-info-Season').innerText = `${seas} ${anime.seasonYear || ''}`;

            const studios = [];
            const producers = [];
            if (anime.studios && anime.studios.nodes) {
                anime.studios.nodes.forEach(s => {
                    if (s.isAnimationStudio) studios.push(s.name);
                    else producers.push(s.name);
                });
            }
            document.getElementById('anilist-info-Studio').innerText = studios.join(', ') || 'N/A';
            document.getElementById('anilist-info-Producers').innerText = producers.slice(0, 4).join(', ') || 'N/A';

            const genreContainer = document.getElementById('anilist-info-Genres');
            genreContainer.innerHTML = '';
            if (anime.genres) {
                anime.genres.forEach(g => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-0.5 bg-input-bg border border-border-color rounded text-[10px] text-text-muted";
                    span.innerText = g;
                    genreContainer.appendChild(span);
                });
            }

            const relContainer = document.getElementById('anilist-info-Relations-Container');
            const relList = document.getElementById('anilist-info-Relations');
            relList.innerHTML = '';

            if (anime.relations && anime.relations.edges && anime.relations.edges.length > 0) {
                const validRelations = anime.relations.edges.filter(r => r.node.format !== 'MANGA' && r.node.format !== 'NOVEL' && r.node.format !== 'MUSIC' && r.node.format !== 'ONE_SHOT');

                if (validRelations.length > 0) {
                    relContainer.classList.remove('hidden');

                    // Update Title
                    const relHeader = relContainer.querySelector('h4');
                    if (relHeader) relHeader.innerText = `${anime.title.english || anime.title.romaji} Relations`;

                    validRelations.forEach(edge => {
                        // Use createCardHTML with isHorizontal = false for vertical cards
                        const imgUrl = edge.node.coverImage?.extraLarge || 'https://placehold.co/160x240?text=No+Img';
                        const relYear = edge.node.seasonYear || (edge.node.startDate ? edge.node.startDate.year : '');
                        const relVote = edge.node.averageScore ? edge.node.averageScore / 10 : null; // Normalize to 10 scale

                        const card = createCardHTML(
                            edge.node.id,
                            'anime',
                            edge.node.title.romaji,
                            imgUrl,
                            relVote,
                            relYear,
                            `<div class="absolute top-2 right-2 bg-card-bg text-white text-[10px] font-bold px-2 py-0.5 rounded border border-primary uppercase shadow-md z-10">${edge.relationType.replace(/_/g, ' ')}</div>`,
                            false,
                            null
                        );
                        relList.appendChild(card);
                    });
                } else {
                    relContainer.classList.add('hidden');
                }
            } else {
                relContainer.classList.add('hidden');
            }

            const watchlistBtn = document.getElementById('anilist-watchlist-btn');
            // Pass vote and year to toggleWatchlist
            const safeTitle = (anime.title.english || anime.title.romaji).replace(/'/g, "");
            watchlistBtn.onclick = () => toggleWatchlist(anime.id, 'anime', safeTitle, anime.coverImage.extraLarge, 'anilist-watchlist-btn', (anime.averageScore || 0) / 10, yearStr);
            updateWatchlistButtonState(anime.id, 'anilist-watchlist-btn');

            const serverBtnContainer = document.getElementById('anime-server-buttons');
            serverBtnContainer.innerHTML = '';
            ANIME_SOURCES.forEach((src, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === state.currentServerIdx ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                btn.innerHTML = `<i class="fas fa-server mr-2"></i> ${src.name.split(/\s+/).slice(0, 2).join(" ")}`;
                btn.onclick = () => {
                    state.currentServerIdx = idx;
                    Array.from(serverBtnContainer.children).forEach(b => {
                        b.classList.remove('bg-primary', 'text-black');
                        b.classList.add('bg-input-bg', 'text-text-muted');
                    });
                    btn.classList.remove('bg-input-bg', 'text-text-muted');
                    btn.classList.add('bg-primary', 'text-black');
                    playAnilistEp(state.currentEp);
                };
                serverBtnContainer.appendChild(btn);
            });

            const castGrid = document.getElementById('anilist-cast-grid');
            castGrid.className = 'flex overflow-x-auto space-x-4 pb-4';
            castGrid.innerHTML = '';

            if (anime.characters && anime.characters.edges) {
                anime.characters.edges.forEach(charEdge => {
                    if (charEdge.voiceActors && charEdge.voiceActors.length > 0) {
                        charEdge.voiceActors.forEach(va => {
                            const el = document.createElement('div');
                            el.className = "flex flex-col gap-2 min-w-[80px] cursor-pointer group";
                            el.onclick = () => openVoiceActorDetails(va.id);
                            const roleDisplay = charEdge.role.charAt(0).toUpperCase() + charEdge.role.slice(1).toLowerCase();
                            el.innerHTML = `
                            <div class="aspect-square rounded-full overflow-hidden border border-border-color w-20 h-20 mx-auto group-hover:border-primary transition-colors">
                                <img src="${va.image.medium}" class="w-full h-full object-cover" alt="Voice Actor Image">
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-text-main font-semibold truncate group-hover:text-primary transition-colors" title="${va.name.full}">${va.name.full}</p>
                                <p class="text-[10px] text-text-muted truncate" title="${charEdge.node.name.userPreferred} (${roleDisplay})">
                                    ${charEdge.node.name.userPreferred} | ${roleDisplay}
                                </p>
                            </div>
                        `;
                            castGrid.appendChild(el);
                        });
                    }
                });
            }

            const recsGrid = document.getElementById('anilist-recommendations-grid');
            recsGrid.innerHTML = '';
            const recHeader = recsGrid.previousElementSibling; // The H3 tag

            if (anime.recommendations && anime.recommendations.nodes && anime.recommendations.nodes.length > 0) {
                if (recHeader) recHeader.innerText = "Recommendations";
                const recItems = anime.recommendations.nodes
                    .map(n => n.mediaRecommendation)
                    .filter(m => m)
                    .map(mapAnilistToShared);
                renderAnilistGrid('anilist-recommendations-grid', recItems, true);
            } else {
                // FALLBACK: Get by Genre
                if (anime.genres && anime.genres.length > 0) {
                    const genre = anime.genres[0];
                    if (recHeader) recHeader.innerText = "Recommendation based in Genre";
                    const fbQuery = `query ($genre: String) { Page(page: 1, perPage: 12) { media(genre: $genre, type: ANIME, sort: TRENDING_DESC) { id title { romaji english } coverImage { extraLarge } format averageScore status seasonYear } } }`;
                    const fbData = await fetchAnilist(fbQuery, { genre });
                    if (fbData && fbData.Page.media) {
                        const recItems = fbData.Page.media.map(mapAnilistToShared);
                        renderAnilistGrid('anilist-recommendations-grid', recItems, true);
                    } else {
                        recsGrid.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                    }
                } else {
                    recsGrid.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                }
            }

            const epGrid = document.getElementById('anilist-episodes-grid');
            epGrid.innerHTML = '';

            if (anime.status === 'NOT_YET_RELEASED') {
                epGrid.innerHTML = '<p class="text-xs text-gray-500">Not Yet Aired</p>';
                return;
            }

            let maxEps = anime.episodes || 12;
            if (anime.nextAiringEpisode) {
                maxEps = anime.nextAiringEpisode.episode - 1;
            }

            if (maxEps === 0) epGrid.innerHTML = '<p class="text-xs text-gray-500">No aired episodes yet.</p>';

            for (let i = 1; i <= maxEps; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative group';
                const btn = document.createElement('button');
                btn.className = `w-full p-2 rounded border border-border-color text-xs md:hover:border-primary md:hover:text-primary ${i === 1 ? 'bg-primary text-black' : 'bg-input-bg text-text-muted'}`;
                btn.innerText = i;
                btn.onclick = () => playAnilistEp(i);
                wrapper.appendChild(btn);

                if (anime.status === 'RELEASING' && i === maxEps) {
                    const badge = document.createElement('sup');
                    badge.className = "absolute -top-0.5 -right-0.5 text-[9px] text-primary font-bold bg-black rounded z-10 shadow-sm";
                    badge.innerText = "NEW";
                    wrapper.appendChild(badge);
                }
                epGrid.appendChild(wrapper);
            }
            if (maxEps > 0) playAnilistEp(state.currentEp); // Play the requested episode
        }

        function playAnilistEp(ep) {
            appState.anilist.currentEp = ep;
            document.getElementById('anilist-player-ep').innerText = `Episode ${ep}`;
            const source = ANIME_SOURCES[appState.anilist.currentServerIdx];
            const url = source.url(appState.anilist.currentAnime.id, ep);

            document.getElementById('anilist-iframe').src = url;

            // SAVE HISTORY
            addToHistory(
                appState.anilist.currentAnime.id,
                'anime',
                appState.anilist.currentAnime.title.english || appState.anilist.currentAnime.title.romaji,
                appState.anilist.currentAnime.coverImage.extraLarge,
                appState.anilist.currentAnime.bannerImage, // backdrop
                null,
                ep
            );

            const wrappers = document.getElementById('anilist-episodes-grid').children;
            Array.from(wrappers).forEach(wrapper => {
                const b = wrapper.querySelector('button');
                if (!b) return;
                const btnEpNum = parseInt(b.innerText);
                if (btnEpNum === ep) {
                    b.classList.remove('bg-input-bg', 'text-text-muted');
                    b.classList.add('bg-primary', 'text-black');
                } else {
                    b.classList.add('bg-input-bg', 'text-text-muted');
                    b.classList.remove('bg-primary', 'text-black');
                }
            });
        }

        function changeAnilistEp(dir) {
            const next = appState.anilist.currentEp + dir;
            if (next > 0) playAnilistEp(next);
        }

        /**
         * SEARCH
         */
        const searchInput = document.getElementById('global-search-input');
        const handleSearch = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val.length > 0) {
                    performSearch(val);
                    e.target.value = '';
                }
            }
        }
        searchInput.addEventListener('keypress', handleSearch);

        async function performSearch(query) {
            router('search');
            const grid = document.getElementById('grid-search');
            grid.innerHTML = '<p class="text-gray-400">Searching...</p>';

            const anilistQuery = `query ($search: String) { Page(page: 1, perPage: 10) { media(search: $search, type: ANIME, isAdult: false) { id title { romaji english } coverImage { extraLarge } format averageScore episodes } } }`;
            const anilistPromise = fetchAnilist(anilistQuery, { search: query });
            const tmdbPromise = fetchTMDB('/search/multi', { query });

            const [anilistRes, tmdbRes] = await Promise.all([anilistPromise, tmdbPromise]);

            searchInput.value = '';
            grid.innerHTML = '';

            if (anilistRes && anilistRes.Page.media) {
                const animeItems = anilistRes.Page.media.map(mapAnilistToShared);
                renderAnilistGrid('grid-search', animeItems, false, true);
            }

            if (tmdbRes && tmdbRes.results) {
                // Modified filter: allow Person, Movie, TV, but EXCLUDE Anime from TMDB results
                const filtered = tmdbRes.results.filter(i => {
                    const isMedia = i.media_type === 'movie' || i.media_type === 'tv' || i.media_type === 'person';
                    // TMDB Anime Detection: Genre 16 (Animation) + Country JP
                    const isAnime = i.genre_ids && i.genre_ids.includes(16) && i.origin_country && i.origin_country.includes('JP');

                    // Allow everything that is Media/Person, BUT if it is anime, block it (unless it's a person, people aren't 'anime')
                    if (i.media_type === 'person') return true;
                    return isMedia && !isAnime;
                });
                await renderTMDBGrid('grid-search', filtered, null, false, true);
            }

            if (grid.children.length === 0) grid.innerHTML = '<p class="text-gray-400">No results found.</p>';
        }

        /**
         * RENDERERS
         */
        function openDetailsWrapper(id, type) {
            if (type === 'anime') openAnilistPlayer(id);
            else openDetails(id, type);
        }

        async function fetchAndDetermineStatus(type, id) {
            try {
                const details = await fetchTMDB(`/${type}/${id}`, {}, false);
                return details.status;
            } catch (error) {
                console.error(`Error fetching status for ${type} ID ${id}:`, error);
                return null;
            }
        }

        async function renderTMDBGrid(containerId, items, typeOverride, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            for (const item of items) {
                // If person, use profile_path, else poster_path
                const imgPath = item.poster_path || item.profile_path;
                if (!imgPath) continue;

                // --- NEW ANIME FILTER: Do not render items that are likely anime ---
                // Only check for non-person items. People don't have genre_ids.
                if (item.media_type !== 'person') {
                    if (item.genre_ids && item.genre_ids.includes(16) && item.origin_country && item.origin_country.includes('JP')) {
                        continue;
                    }
                }

                const title = item.title || item.name;
                if (/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f\u3131-\uD79D\uAC00-\uD7A3]/.test(title)) continue;

                const type = typeOverride || (item.media_type || 'movie');
                const date = item.release_date || item.first_air_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(imgPath);
                }

                // Handling for Person Type
                if (type === 'person') {
                    const card = createCardHTML(item.id, 'actor', title, posterUrl, item.popularity, '', '', false, 'Actor');
                    // Override click for actors
                    card.onclick = () => openActorDetails(item.id);
                    container.appendChild(card);
                    continue;
                }

                const tmdbStatus = await fetchAndDetermineStatus(type, item.id);
                let displayStatus = tmdbStatus || item.status;

                if (!displayStatus && (item.release_date || item.first_air_date)) {
                    const releaseDate = new Date(item.release_date || item.first_air_date);
                    const now = new Date();
                    displayStatus = releaseDate > now ? 'Upcoming' : 'Released';
                }

                const statusBadge = displayStatus ? `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] px-2 py-1 font-bold rounded border border-primary uppercase shadow-md z-10">${displayStatus.replace(/_/g, ' ')}</div>` : '';
                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal, item.overview);
                container.appendChild(card);
            }
        }

        function renderAnilistGrid(containerId, items, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            items.forEach(item => {
                if (!item.poster_path) return;
                const title = item.title || item.name;
                const type = 'anime';
                const date = item.release_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Banner/Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(item.poster_path);
                }

                const statusBadge = item.status ? `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] px-2 py-1 font-bold rounded border border-primary uppercase shadow-md z-10">${item.status.replace(/_/g, ' ')}</div>` : '';
                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal, item.overview);
                container.appendChild(card);
            });
        }

        function createCardHTML( id,type, title, posterUrl, vote, year, statusBadge, isHorizontal, overview ) {
            const card = document.createElement('div');
            const widthClass = isHorizontal ? 'landscape-card' : '';
            card.className = `movie-card rounded cursor-pointer relative group ${widthClass}`;

            const aspectClass = isHorizontal ? 'aspect-video' : 'aspect-[2/3]';

            // â Normalize vote (handles numbers & numeric strings)
            const numericVote = vote !== null && vote !== undefined && !isNaN(vote) ? Number(vote) : null;

            // â Display logic
            const voteDisplay =
                numericVote !== null && numericVote > 0 ? numericVote.toFixed(1) : 'NR';

            card.innerHTML = `
                <div class="${aspectClass} overflow-hidden relative">
                <img src="${posterUrl}" class="w-full h-full object-cover">

                ${statusBadge || ''}

                ${ type !== 'actor' ? ` <div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-2 py-1 border border-primary rounded font-bold z-10 flex items-center gap-1">
                    ${type === 'season' ? '' : ''} ${voteDisplay} </div> `  : `
                <div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-2 py-1 border border-primary rounded font-bold z-10">
                    <i class="fas fa-user"></i>
                </div> ` }

                <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                    <i class="mdi ${
                    type === 'actor'
                        ? 'mdi-account-search'
                        : 'mdi-play-circle'
                } text-primary text-5xl drop-shadow-lg"></i>
                </div>

                <div class="absolute bottom-0 left-0 w-full p-3 card-info">
                    <h3 class="text-text-main text-sm font-semibold truncate md:hover:text-primary transition-colors" title="${title}">
                        ${title}
                    </h3>
                    <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                        <span>${year || ''}</span>
                        <span class="uppercase border border-border-color px-1 rounded text-[10px] truncate max-w-[80px]">
                        ${type}
                        </span>
                    </div>
                </div>
            </div> `;

            card.title = title;
            card.onclick = () => openDetailsWrapper(id, type);
            return card;
        }

        function renderPagination(containerId, current, total, callback) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const max = Math.min(total, 500);
            if (max <= 1) return;

            const prev = document.createElement('button');
            prev.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.disabled = current === 1;
            prev.onclick = () => callback(current - 1);

            const next = document.createElement('button');
            next.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.disabled = current === max;
            next.onclick = () => callback(current + 1);

            const pageSpan = document.createElement('span');
            pageSpan.className = "px-3 py-1 text-primary font-bold";
            pageSpan.innerText = `${current} / ${max}`;

            container.append(prev, pageSpan, next);
        }

        // Updated openDetails to accept season/episode args for history resume
        // Updated openDetails to accept season/episode args for history resume
        async function openDetails(id, type, startSeason = 1, startEpisode = 1) {
            router('details');
            const container = document.getElementById('details-content');
            container.innerHTML = '';
            loader.show();

            const [details, credits, recommendations] = await Promise.all([
                fetchTMDB(`/${type}/${id}`),
                fetchTMDB(`/${type}/${id}/credits`),
                fetchTMDB(`/${type}/${id}/recommendations`)
            ]);

            if (!details) { container.innerHTML = 'Error loading'; return; }

            // Collection logic...
            let collectionData = null;
            if (type === 'movie' && details.belongs_to_collection) {
                collectionData = await fetchTMDB(`/collection/${details.belongs_to_collection.id}`);
            }

            const title = details.title || details.name;
            const backdrop = getBackdropUrl(details.backdrop_path);
            const poster = getPosterUrl(details.poster_path);
            const runtime = details.runtime || (details.episode_run_time ? details.episode_run_time[0] : '?') + 'm';

            const cast = credits && credits.cast ? credits.cast.slice(0, 15) : [];
            let castHtml = '<div class="flex overflow-x-auto gap-4 pb-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">';
            if (cast.length > 0) {
                castHtml += cast.map(c => {
                    const profile = c.profile_path ? `${IMG_URL}${c.profile_path}` : 'https://placehold.co/100x100/333/555?text=No+Img';
                    return `
                        <div class="flex-shrink-0 w-24 text-center cursor-pointer group" onclick="openActorDetails(${c.id})">
                            <img src="${profile}" alt="${c.name}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 border-2 border-border-color group-hover:border-primary transition-colors">
                            <p class="text-xs font-semibold text-text-main truncate group-hover:text-primary transition-colors" title="${c.name}">${c.name}</p>
                            <p class="text-[10px] text-text-muted truncate" title="${c.character}">${c.character}</p>
                        </div>
                    `;
                }).join('');
            } else {
                castHtml += '<p class="text-text-muted text-sm">No cast information available.</p>';
            }
            castHtml += '</div>';

            const releaseDate = details.release_date || details.first_air_date || 'N/A';
            const rawDateString = details.release_date || details.first_air_date || null;
            let relDate = 'N/A';
            if (rawDateString) {
                const dateObject = new Date(rawDateString);
                relDate = dateObject.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
            const status = details.status || 'N/A';
            let genresHtml = '';
            if (details.genres) {
                genresHtml = details.genres.map(g => `<span class="px-2 py-0.5 bg-input-bg border border-border-color rounded text-[10px] text-text-muted">${g.name}</span>`).join('');
            }
            const tagline = details.tagline ? `"${details.tagline}"` : '';

            container.innerHTML = `
                <div class="w-full h-[300px] md:h-[400px] bg-cover bg-center relative" style="background-image: url('${backdrop}')">
                    <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
                </div>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                            <button onclick="router(appState.lastView || 'home')" class="mb-4 block md:hidden text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-angles-left mr-2"></i> Back</button>
                            <img src="${poster}" class="w-[180px] md:w-full mx-auto md:mx-0 hidden md:block rounded shadow-2xl">
                            <div class="mb-6">
                                <h1 class="text-2xl md:text-4xl font-extrabold text-white mb-3 leading-tight">${title}</h1>
                                <p class="text-gray-400 italic text-sm mb-4">${tagline}</p>
                                <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-6">
                                    <span class="text-primary font-bold"><i class="fas fa-star mr-1"></i> ${details.vote_average.toFixed(1)}</span>
                                    <span class="px-2 py-0.5 border border-border-color rounded">${releaseDate.split('-')[0]}</span>
                                    <span class="uppercase">${type}</span>
                                    <span><button id="tmdb-watchlist-btn" onclick="toggleWatchlist(${id}, '${type}', '${title.replace(/'/g, "")}', '${details.poster_path}', 'tmdb-watchlist-btn', ${details.vote_average}, '${releaseDate.split('-')[0]}')" class="md:hover:bg-opacity-60 pt-4 py-2 px-3 bg-card-bg text-primary font-bold rounded-md transition-colors"><i class="material-icons">bookmark_add</i></button></span>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                                    <p class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto">${details.overview}</p>
                                </div>
                            </div>
                            <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                                <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Type</span><p class="text-text-main text-xs font-medium text-right md:text-left uppercase">${type}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Status</span><p class="text-primary text-xs font-medium text-right md:text-left">${status}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Released</span><p class="text-text-main text-xs font-medium text-right md:text-left">${relDate}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Runtime</span><p class="text-text-main text-xs font-medium text-right md:text-left">${runtime}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Production</span><p class="text-text-main text-xs font-medium text-right md:text-left">${details.production_companies?.[0]?.name || 'N/A'}</p></div>
                                </div>
                                    <div class=" border-b border-border-color pb-2"><span class="text-text-muted text-xs">Genres</span><div class="flex flex-wrap gap-1 mt-1">${genresHtml}</div></div>
                                <div class="mb-0"><h3 class="text-lg font-bold text-text-main mb-3">Cast</h3><div class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">${castHtml}</div></div>
                                
                            </div>
                        </div>
                        <div class="flex-1 pt-4 md:pt-16 min-w-0">
                            <button onclick="router(appState.lastView || 'home')" class="mb-4 hidden md:block text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-angles-left mr-2"></i> Back</button>
                            <div class="mb-8 space-y-4">
                                <div class="rounded-lg overflow-hidden border border-border-color bg-black shadow-xl">
                                    <div class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                                        <div class="flex items-center gap-2">
                                            <span class="text-primary font-bold"><i class="fas fa-play-circle"></i> Player</span>
                                            ${type === 'tv' ? `<span id="tv-player-info" class="text-xs text-text-muted border border-border-color rounded px-2 py-0.5">S${startSeason} E${startEpisode}</span>` : ''}
                                        </div>
                                        <div class="flex gap-2" id="server-buttons"></div>
                                    </div>
                                    <div class="aspect-video relative bg-black"><iframe id="tmdb-player" src="" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>
                                </div>
                                ${type === 'tv' ? `
                                <div class="bg-card-bg px-4 py-3 flex justify-between items-center border-t border-border-color mt-0 rounded-b-lg border-x border-b">
                                    <button id="btn-tv-prev" class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium"><i class="fas fa-backward mr-1"></i> Prev</button>
                                    <button id="btn-tv-next" class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">Next <i class="fas fa-forward ml-1"></i></button>
                                </div>
                                ` : ''}
                            </div>

                            <!-- TV SHOW SEASONS & EPISODES CONTAINER -->
                             ${type === 'tv' ? `
                                <div class="mb-8">
                                    <h3 class="text-lg font-bold text-text-main mb-3">Episodes <span id="tv-season-title" class="text-sm font-normal text-text-muted ml-2">Season ${startSeason}</span></h3>
                                    <div id="tv-episodes-grid" class="grid grid-cols-5 pt-4 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-60 overflow-y-auto custom-scroll pr-2"></div>
                                </div>
                                
                                <div id="tv-seasons-container" class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                                    <h4 class="text-lg font-bold text-text-main mb-3 border-b border-border-color">Other Seasons</h4>
                                    <div id="tv-seasons-list" class="horizontal-scroll-container p-2"></div>
                                </div>
                             ` : ''}


                            <div id="tmdb-collection-container" class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color ${collectionData ? '' : 'hidden'}">
                                <h4 class="text-lg font-bold text-text-main mb-3 border-b border-border-color">${collectionData ? collectionData.name : 'Relations'}</h4>
                                <div id="tmdb-collection-list" class="horizontal-scroll-container p-2"></div>
                            </div>
                            <div
                            class="mt-3 bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                            <h3 id="tmdb-rec-title" class="text-lg font-bold text-text-main mb-3">Recommendations</h3><div id="tmdb-recommendations" class="horizontal-scroll-container p-2"></div></div>
                        </div>
                    </div>
                </div>
            `;

            updateWatchlistButtonState(id, 'tmdb-watchlist-btn');

            // --- TV Episode Navigation Logic ---
            if (type === 'tv') {
                const changeTvEpisode = (dir) => {
                    const nextEp = ep + dir;
                    const grid = document.getElementById('tv-episodes-grid');
                    if (!grid) return;
                    
                    // Find the button corresponding to the next episode
                    const buttons = grid.querySelectorAll('button');
                    for (let btn of buttons) {
                        if (parseInt(btn.innerText) === nextEp) {
                            btn.click();
                            // Optional: Scroll the button into view inside the grid
                            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                            return;
                        }
                    }
                };

                document.getElementById('btn-tv-prev').onclick = () => changeTvEpisode(-1);
                document.getElementById('btn-tv-next').onclick = () => changeTvEpisode(1);
            }
            // -----------------------------------

            const recContainer = document.getElementById('tmdb-recommendations');
            const recTitle = document.getElementById('tmdb-rec-title');

            if (recommendations && recommendations.results && recommendations.results.length > 0) {
                renderTMDBGrid('tmdb-recommendations', recommendations.results, type, true);
            } else {
                // FALLBACK: Get by Genre
                if (details.genres && details.genres.length > 0) {
                    const genreIds = details.genres.slice(0, 2).map(g => g.id).join(',');
                    if (recTitle) recTitle.innerText = "Recommendation based in Genre";
                    const fbData = await fetchTMDB(`/discover/${type}`, { with_genres: genreIds });
                    if (fbData && fbData.results) {
                        renderTMDBGrid('tmdb-recommendations', fbData.results, type, true);
                    } else {
                        recContainer.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                    }
                } else {
                    recContainer.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                }
            }

            // Populate Collection if exists
            if (collectionData && collectionData.parts && collectionData.parts.length > 0) {
                const sortedParts = collectionData.parts.sort((a, b) => {
                    return new Date(a.release_date || '9999-12-31') - new Date(b.release_date || '9999-12-31');
                });
                const colContainer = document.getElementById('tmdb-collection-list');
                sortedParts.forEach(part => {
                    const imgUrl = part.poster_path ? IMG_URL + part.poster_path : 'https://placehold.co/160x240?text=No+Img';
                    const card = createCardHTML(
                        part.id,
                        'movie',
                        part.title,
                        imgUrl,
                        part.vote_average,
                        part.release_date ? part.release_date.split('-')[0] : '',
                        '', // No specific status badge for collection items typically
                        false, // Vertical
                        part.overview
                    );
                    colContainer.appendChild(card);
                });
            }

            let season = startSeason;
            let ep = startEpisode;

            const serverContainer = document.getElementById('server-buttons');
            const SOURCES = type === 'movie' ? MOVIE_SOURCES : TV_SOURCES;

            // Setup Server Buttons
            const renderServerButtons = () => {
                 serverContainer.innerHTML = '';
                 SOURCES.forEach((src, idx) => {
                    const btn = document.createElement('button');
                    btn.innerHTML = `<i class="fas fa-server mr-1"></i> ${src.name}`;
                    // Use a generic 'active' class check logic if needed, but simple toggle works
                    // We default to idx 0 active on load
                    const isActive = (iframe.src.includes(src.name) || idx === 0 && iframe.src === ""); 
                    btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === 0 ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                    
                    btn.onclick = () => {
                        Array.from(serverContainer.children).forEach(b => {
                            b.className = 'px-3 py-1 rounded text-xs font-bold bg-input-bg text-text-muted hover:text-white transition-colors';
                        });
                        btn.className = 'px-3 py-1 rounded-sm text-xs font-bold bg-primary text-black transition-colors';
                        updatePlayerSource(src, id, type, season, ep, details.poster_path, title, details.backdrop_path);
                    }
                    serverContainer.appendChild(btn);
                });
            }

            const iframe = document.getElementById('tmdb-player');
            renderServerButtons(); // Initial render

            if (type === 'tv') {
                // TV SHOW SPECIFIC LOGIC
                
                // 1. Fetch episodes for current season (startSeason)
                const loadSeasonData = async (seasonNum) => {
                    season = seasonNum;
                    document.getElementById('tv-season-title').innerText = `Season ${seasonNum}`;
                    if(document.getElementById('tv-player-info')) document.getElementById('tv-player-info').innerText = `S${seasonNum} E${ep}`;

                    // Update Seasons List (exclude current)
                    renderSeasonsList(details.seasons, seasonNum);

                    loader.show();
                    const seasonData = await fetchTMDB(`/tv/${id}/season/${seasonNum}`);
                    loader.hide();

                    const epGrid = document.getElementById('tv-episodes-grid');
                    epGrid.innerHTML = '';

                    if (seasonData && seasonData.episodes && seasonData.episodes.length > 0) {
                         const today = new Date();
                         seasonData.episodes.forEach(e => {
                            if (!e.air_date || new Date(e.air_date) > today) return; // Skip unaired

                            const wrapper = document.createElement('div');
                            wrapper.className = 'relative group';
                            const btn = document.createElement('button');
                            // Highlight if it's the current playing episode
                            const isCurrent = (e.episode_number == ep);
                            btn.className = `w-full p-2 rounded border border-border-color text-xs md:hover:border-primary md:hover:text-primary ${isCurrent ? 'bg-primary text-black' : 'bg-input-bg text-text-muted'}`;
                            btn.innerText = e.episode_number;
                            btn.title = e.name;
                            
                            btn.onclick = () => {
                                ep = e.episode_number;
                                // Update player info text
                                if(document.getElementById('tv-player-info')) document.getElementById('tv-player-info').innerText = `S${season} E${ep}`;
                                
                                // Update button styles in grid
                                Array.from(epGrid.children).forEach(child => {
                                    const b = child.querySelector('button');
                                    b.className = 'w-full p-2 rounded border border-border-color text-xs md:hover:border-primary md:hover:text-primary bg-input-bg text-text-muted';
                                });
                                btn.className = 'w-full p-2 rounded border border-border-color text-xs md:hover:border-primary md:hover:text-primary bg-primary text-black';

                                // Play
                                updatePlayerSource(SOURCES[0], id, 'tv', season, ep, details.poster_path, title, details.backdrop_path);
                                
                                // Reset server buttons visual state to first one
                                renderServerButtons();
                            };
                            wrapper.appendChild(btn);
                            epGrid.appendChild(wrapper);
                         });
                    } else {
                        epGrid.innerHTML = '<p class="text-gray-500 col-span-full">No episodes found.</p>';
                    }
                };

                // 2. Render Seasons List
                const renderSeasonsList = (seasons, currentSeasonNum) => {
                    const seasonsContainer = document.getElementById('tv-seasons-list');
                    seasonsContainer.innerHTML = '';
                    const wrapper = document.getElementById('tv-seasons-container');

                    const validSeasons = seasons.filter(s => s.season_number > 0 && s.season_number != currentSeasonNum);
                    
                    if (validSeasons.length === 0) {
                        wrapper.classList.add('hidden');
                        return;
                    }
                    wrapper.classList.remove('hidden');

                    validSeasons.forEach(s => {
                         const imgUrl = s.poster_path ? IMG_URL + s.poster_path : 'https://placehold.co/160x240?text=No+Img';
                         const card = createCardHTML(
                            id, // We keep the TV Show ID
                            'season', // Special type for visuals
                            s.name,
                            imgUrl,
                            s.vote_average ? s.vote_average.toFixed(1) : null, // No vote
                            s.air_date ? s.air_date.split('-')[0] : '', // Year
                            `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] font-bold px-2 py-0.5 rounded border border-primary uppercase shadow-md z-10">${s.episode_count} EPS</div>`,
                            false,
                            null
                        );
                        // Override click to load season
                        card.onclick = () => {
                            ep = 1; // Reset to ep 1 when changing seasons
                            loadSeasonData(s.season_number);
                            updatePlayerSource(SOURCES[0], id, 'tv', s.season_number, 1, details.poster_path, title, details.backdrop_path);
                             renderServerButtons();
                        };
                        seasonsContainer.appendChild(card);
                    });
                };

                // Initial Load for TV
                await loadSeasonData(startSeason);
                updatePlayerSource(SOURCES[0], id, 'tv', startSeason, startEpisode, details.poster_path, title, details.backdrop_path);

            } else {
                // MOVIE
                updatePlayerSource(SOURCES[0], id, 'movie', 1, 1, details.poster_path, title, details.backdrop_path);
            }
            loader.hide();
        }

        async function openActorDetails(id) {
            router('actor');
            const container = document.getElementById('actor-content');
            container.innerHTML = '';
            loader.show();

            const [person, credits, externalIds] = await Promise.all([
                fetchTMDB(`/person/${id}`),
                fetchTMDB(`/person/${id}/combined_credits`),
                fetchTMDB(`/person/${id}/external_ids`)
            ]);

            if (!person) {
                container.innerHTML = '<div class="text-center text-text-muted mt-20">Error loading actor details.</div>';
                loader.hide();
                return;
            }

            const profile = person.profile_path ? IMG_URL + person.profile_path : 'https://placehold.co/300x450/333/FFF?text=No+Image';
            const name = person.name;
            const knownf = person.known_for_department;
            const knownFor = person.known_for_department == "Acting";
            const knownas = person.also_known_as.join(', ') || person.name;
            const birthday = person.birthday;
            const displayBirthday = birthday
                ? new Date(birthday).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                })
                : 'N/A';
            const place = person.place_of_birth || 'N/A';
            const bio = person.biography || 'No biography available.';

            // Sort credits by popularity
            const sortedCredits = credits ? credits.cast.sort((a, b) => b.vote_count - a.vote_count) : [];
            // Remove duplicates
            const uniqueCredits = [];
            const seenIds = new Set();
            sortedCredits.forEach(c => {
                if (!seenIds.has(c.id)) {
                    seenIds.add(c.id);
                    uniqueCredits.push(c);
                }
            });

            // Social Media Links - UPDATED DESIGN
            let socialLinksHtml = '';

            // Changed 'h-50 w-50' to 'h-10 w-10' for a standard size, adjust as needed.
            // Changed 'rounded' to 'rounded-full' for a circular shape.
            const socialBtnClass = 'text-white border-2 border-border-color hover:border-primary text-center mt-2 inline-flex items-center justify-center m-0.5 px-3 py-2 h-10 w-10 rounded-full bg-card-bg text-xs font-bold transition-colors';

            if (externalIds) {
                if (externalIds.imdb_id) {
                    // Removed redundant classes within the specific link definitions
                    socialLinksHtml += `<a href="https://www.imdb.com/name/${externalIds.imdb_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-imdb text-lg"></i></a>`;
                }
                if (externalIds.facebook_id) {
                    socialLinksHtml += `<a href="https://facebook.com/${externalIds.facebook_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-facebook text-lg"></i></a>`;
                }
                if (externalIds.instagram_id) {
                    socialLinksHtml += `<a href="https://instagram.com/${externalIds.instagram_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-instagram text-lg"></i></a>`;
                }
                if (externalIds.twitter_id) {
                    socialLinksHtml += `<a href="https://twitter.com/${externalIds.twitter_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-twitter text-lg"></i></a>`;
                }
                if (externalIds.tiktok_id) {
                    socialLinksHtml += `<a href="https://tiktok.com/@${externalIds.tiktok_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-tiktok text-lg"></i></a>`;
                }
                if (externalIds.youtube_id) {
                    // You didn't finish the last URL, but the class application is correct.
                    socialLinksHtml += `<a href="https://youtube.com/${externalIds.youtube_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-youtube text-lg"></i></a>`;
                }
            }

            container.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <button onclick="router(appState.lastView || 'home')" class="mb-6 text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-angles-left mr-2"></i> Back</button>
                    
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[300px] flex-shrink-0">
                            <img src="${profile}" class="w-[200px] md:w-full mx-auto md:mx-0 rounded-lg shadow-2xl border border-border-color mb-6">
                            <h1 class="text-3xl md:text-5xl text-center block md:hidden font-extrabold text-white">${name}</h1>
                                <div class="gap-2 mb-3 text-center text-primary">${socialLinksHtml || '<span class="text-xs text-text-muted">None social accounts available</span>'}</div>
                            <div class="bg-card-bg p-5 rounded-lg border border-border-color space-y-4">
                                <h3 class="font-bold text-lg text-white border-b border-border-color pb-2">Personal Info</h3>
                                
                                <div><span class="text-text-muted text-xs block">Known For</span><span class="text-sm font-medium">${knownf}</span></div>
                                <div><span class="text-text-muted text-xs block">Gender</span><span class="text-sm font-medium">${person.gender === 1 ? 'Female' : 'Male'}</span></div>
                                <div><span class="text-text-muted text-xs block">Birthday</span><span class="text-sm font-medium">${displayBirthday}</span></div>
                                <div><span class="text-text-muted text-xs block">Place of Birth</span><span class="text-sm font-medium">${place}</span></div>
                                <div><span class="text-text-muted text-xs block">Also known as</span><span class="text-sm font-medium">${knownas}</span></div>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <h1 class="text-3xl md:text-5xl hidden md:block font-extrabold text-white border-b border-border-color mb-6">${name}</h1>
                            
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-white mb-3">Biography</h3>
                                <p class="text-gray-300 text-sm leading-relaxed whitespace-pre-line max-h-60 overflow-y-auto pr-2 custom-scroll">${bio}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-white mb-4">Known For</h3>
                                <div id="actor-credits-grid" class="results-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (uniqueCredits.length > 0) {
                renderTMDBGrid('actor-credits-grid', uniqueCredits, null, false, true);
            } else {
                document.getElementById('actor-credits-grid').innerHTML = '<p class="text-gray-500">No known credits.</p>';
            }

            loader.hide();
        }

        async function openVoiceActorDetails(id) {
            router('actor');
            const container = document.getElementById('actor-content');
            container.innerHTML = '';
            loader.show();

            const query = `query ($id: Int) {
                Staff(id: $id) {
                    id
                    name { full native }
                    image { large }
                    description
                    gender
                    dateOfBirth { year month day }
                    homeTown
                    age
                    primaryOccupations
                    characterMedia(page: 1, perPage: 50, sort: POPULARITY_DESC) {
                        nodes {
                            id
                            title { romaji english }
                            coverImage { extraLarge }
                            format
                            averageScore
                            status
                            seasonYear
                            startDate { year }
                        }
                    }
                }
            }`;

            const data = await fetchAnilist(query, { id });
            if (!data || !data.Staff) {
                container.innerHTML = '<div class="text-center text-text-muted mt-20">Error loading voice actor details.</div>';
                loader.hide();
                return;
            }

            const staff = data.Staff;
            const profile = staff.image ? staff.image.large : 'https://placehold.co/300x450/333/FFF?text=No+Image';
            const name = staff.name.full;
            const nativeName = staff.name.native || '';

            // --- PARSE BIO LINKS ---
            let bio = staff.description || 'No biography available.';

            // Replace markdown links [Label](URL) with Icon + Label
            bio = bio.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, label, url) => {
                let iconClass = 'fas fa-link';
                const lowerUrl = url.toLowerCase();

                if (lowerUrl.includes('twitter.com') || lowerUrl.includes('x.com')) iconClass = 'fab fa-twitter';
                else if (lowerUrl.includes('instagram.com')) iconClass = 'fab fa-instagram';
                else if (lowerUrl.includes('facebook.com')) iconClass = 'fab fa-facebook';
                else if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be')) iconClass = 'fab fa-youtube';
                else if (lowerUrl.includes('wikipedia')) iconClass = 'fab fa-wikipedia-w';
                else if (lowerUrl.includes('tiktok.com')) iconClass = 'fab fa-tiktok';
                else if (lowerUrl.includes('ameblo.jp') || lowerUrl.includes('blog')) iconClass = 'fas fa-blog';
                else if (lowerUrl.includes('website')) iconClass = 'fas fa-globe';

                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:text-white inline-flex items-center gap-1 mx-1 font-semibold transition-colors"><i class="${iconClass}"></i> ${label}</a>`;
            });

            // Basic Markdown formatting
            bio = bio.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>');

            let birthday = 'N/A';
            if (staff.dateOfBirth && staff.dateOfBirth.year) {
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const m = staff.dateOfBirth.month ? months[staff.dateOfBirth.month - 1] : '';
                const d = staff.dateOfBirth.day || '';
                const y = staff.dateOfBirth.year || '';
                birthday = `${m} ${d}, ${y}`.replace(/^ ,/, '').trim();
            }

            const place = staff.homeTown || 'N/A';
            const occupations = staff.primaryOccupations && staff.primaryOccupations.length > 0
                ? staff.primaryOccupations.join(', ')
                : 'Voice Actor';

            container.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <button onclick="router(appState.lastView || 'home')" class="mb-6 text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-angles-left mr-2"></i> Back</button>
                    
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[300px] flex-shrink-0">
                            <img src="${profile}" class="w-[200px] md:w-full mx-auto md:mx-0 rounded-lg shadow-2xl border border-border-color mb-6">
                            <h1 class="text-3xl md:text-5xl block md:hidden text-center font-extrabold text-white mb-6">${name}</h1>
                            
                            <div class="bg-card-bg p-5 rounded-lg border border-border-color space-y-4">
                                <h3 class="font-bold text-lg text-white border-b border-border-color pb-2">Personal Info</h3>
                                <div><span class="text-text-muted text-xs block">Occupations</span><span class="text-sm font-medium">${occupations}</span></div>
                                <div><span class="text-text-muted text-xs block">Gender</span><span class="text-sm font-medium">${staff.gender || 'Unknown'}</span></div>
                                <div><span class="text-text-muted text-xs block">Birthday</span><span class="text-sm font-medium">${birthday}</span></div>
                                <div><span class="text-text-muted text-xs block">Hometown</span><span class="text-sm font-medium">${place}</span></div>
                                ${nativeName ? `<div><span class="text-text-muted text-xs block">Native Name</span><span class="text-sm font-medium">${nativeName}</span></div>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <h1 class="text-3xl md:text-5xl hidden md:block font-extrabold text-white mb-6">${name}</h1>
                            
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-white mb-3">Biography</h3>
                                <div class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap max-h-60 overflow-y-auto pr-2 custom-scroll">${bio}</div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-white mb-4">Known For (Voice Roles)</h3>
                                <div id="actor-credits-grid" class="results-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (staff.characterMedia && staff.characterMedia.nodes && staff.characterMedia.nodes.length > 0) {
                const mappedMedia = staff.characterMedia.nodes.map(mapAnilistToShared);
                renderAnilistGrid('actor-credits-grid', mappedMedia, false, false);
            } else {
                document.getElementById('actor-credits-grid').innerHTML = '<p class="text-gray-500">No known credits.</p>';
            }

            loader.hide();
        }

        function updatePlayerSource(sourceObj, id, type, s = 1, e = 1, poster = null, title = "", backdrop = null) {
            const iframe = document.getElementById('tmdb-player');
            if (type === 'movie') {
                iframe.src = sourceObj.url(id);
                addToHistory(id, type, title, poster, backdrop); // Save History
            } else {
                iframe.src = sourceObj.url(id, s, e);
                addToHistory(id, type, title, poster, backdrop, s, e); // Save History with S/E
            }
        }

        function toggleWatchlist(id, type, title, poster, btnId, vote = null, year = null) {
            const exists = appState.watchlist.find(i => i.id === id);
            if (exists) {
                appState.watchlist = appState.watchlist.filter(i => i.id !== id);
                showToast('Removed from Library');
            } else {
                // Store vote and year to match default card design
                appState.watchlist.push({ id, type, title, poster_path: poster, vote_average: vote, release_date: year });
                showToast('Added to Library');
            }
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            updateWatchlistButtonState(id, btnId);
        }

        function updateWatchlistButtonState(id, btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            const exists = appState.watchlist.find(i => i.id === id);
            if (exists) {
                btn.innerHTML = '<i class="material-icons">bookmark_added</i>';
            } else {
                btn.innerHTML = '<i class="material-icons">bookmark_add</i>';
                if (btnId.includes('banner')) {
                    btn.className = "bg-card-bg md:hover:bg-opacity-60 text-primary font-bold pt-4 py-2 px-3 rounded-r-md transition-colors";
                } else {
                    btn.className = "pt-4 py-2 px-3 bg-card-bg text-primary md:hover:bg-opacity-60 rounded font-bold transition-colors";
                }
            }
        }

        function renderWatchlist() {
            const grid = document.getElementById('grid-watchlist');
            grid.innerHTML = '';
            if (appState.watchlist.length === 0) { grid.innerHTML = '<p class="text-text-muted">Your Library is empty.</p>'; return; }
            appState.watchlist.forEach(item => {
                const posterUrl = getPosterUrl(item.poster_path);

                // Use standard vertical card format
                // Pass stored vote and year. If missing, pass defaults.
                const card = createCardHTML(
                    item.id,
                    item.type,
                    item.title,
                    posterUrl,
                    item.vote_average, // vote
                    item.release_date,   // year/date
                    '',   // Status unknown
                    false, // Vertical (grid) layout
                    null // Overview not needed for card
                );

                // Cleaner Remove Button: Circular, top-right, semi-transparent black
                const removeBtn = document.createElement('button');
                removeBtn.className = "absolute top-1 right-1 z-30 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 transition-colors backdrop-blur-sm shadow-md";
                removeBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                removeBtn.title = "Remove from Library";
                removeBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent card click
                    removeFromWatchlist(item.id);
                };

                card.querySelector('.relative').appendChild(removeBtn); // Append to the main wrapper
                grid.appendChild(card);
            });
        }

        function removeFromWatchlist(id) {
            appState.watchlist = appState.watchlist.filter(i => i.id !== id);
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            showToast('Removed from Library');
            renderWatchlist();
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'bg-white text-black px-6 py-3 rounded-md shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center min-w-[200px] border-l-4 border-primary';
            toast.innerHTML = `
                <i class="fas fa-info-circle text-black mr-3 text-lg"></i>
                <span class="font-semibold text-sm">${msg}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        function onDeviceReady() {
            console.log("Cordova Device Ready");
            var originalOpen = window.open;
            window.open = function (url, target, options) {
                return cordova.InAppBrowser ? cordova.InAppBrowser.open(url, '_self', options) : originalOpen(url, '_self', options);
            };
        }
        document.addEventListener('deviceready', onDeviceReady, false);

        /**
         * INSTALL & FAQ LOGIC
         */
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            showInstallButton();
        });

        function showInstallButton() {
            const btn = document.getElementById('nav-install-btn');
            if (btn) btn.classList.remove('hidden');
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            } else {
                // If no prompt available (iOS or already installed or desktop), show instructions
                toggleInstallModal();
            }
        }

        function toggleInstallModal() {
            const modal = document.getElementById('install-modal');
            modal.classList.toggle('open');
        }

        function toggleFAQ() {
            const modal = document.getElementById('faq-modal');
            modal.classList.toggle('open');
        }

        function toggleFAQs() {
            const modal = document.getElementById('faqs-modal');
            modal.classList.toggle('open');
        }

        // Close Modals on Outside Click
        window.onclick = function (event) {
            const faqModal = document.getElementById('faq-modal');
            const faqsModal = document.getElementById('faqs-modal');
            const installModal = document.getElementById('install-modal');
            if (event.target === faqModal) toggleFAQ();
            if (event.target === faqsModal) toggleFAQs();
            if (event.target === installModal) toggleInstallModal();
        }

        /**
         * ANTI-INSPECT DETECTION
         * Attempts to detect devtools via key shortcuts and right-click.
         * Redirects to blank page if detected.
         */
        function detectInspector() {
            // Disable Right Click
            document.addEventListener('contextmenu', event => event.preventDefault());

            // Disable Shortcuts
            document.addEventListener('keydown', function (e) {
                // F12
                if (e.keyCode == 123) {
                    window.location.href = 'about:blank';
                    return false;
                }
                // Ctrl+Shift+I (Inspector)
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                    window.location.href = 'about:blank';
                    return false;
                }
                // Ctrl+Shift+C (Element Selector)
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
                    window.location.href = 'about:blank';
                    return false;
                }
                // Ctrl+Shift+J (Console)
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                    window.location.href = 'about:blank';
                    return false;
                }
                // Ctrl+U (View Source)
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                    window.location.href = 'about:blank';
                    return false;
                }
            });
        }

        detectInspector();

        window.addEventListener('DOMContentLoaded', () => {
            router('home');
        });

        const copyrightSpan = document.getElementById('current-year-copyright');
        if (copyrightSpan) copyrightSpan.textContent = `${new Date().getFullYear()} GoStream`;
    </script>
</body>

</html>
