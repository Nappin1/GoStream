<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' data: gap: 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com;
        img-src 'self' data: https://image.tmdb.org https://placehold.co https://s4.anilist.co https://*.anilist.co;
        font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.googleapis.com;
        connect-src 'self' https://api.themoviedb.org https://graphql.anilist.co;
        frame-src 'self' https://vidsrc.cc https://vidsrc.icu https://vidlink.pro https://111movies.com https://vidrock.net https://player.videasy.net;
        media-src 'self';
    ">

    <title>Go Stream</title>

    <!-- Cordova script kept as requested, though it may 404 in this web preview -->
    <script src="cordova.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'nav-bp': '1025px' },
                    colors: {
                        'primary': 'var(--color-primary)',
                        'dark-bg': 'var(--bg-main)',
                        'card-bg': 'var(--bg-card)',
                        'nav-bg': 'var(--bg-nav)',
                        'border-color': 'var(--border-color)',
                        'text-main': 'var(--text-main)',
                        'text-muted': 'var(--text-muted)',
                        'input-bg': 'var(--bg-input)'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL VARIABLES & THEME --- */
        :root {
            --color-primary: #cae962;
            --bg-main: #202125;
            --bg-card: #2a2c31;
            --bg-nav: #1a1b1e;
            --bg-input: #111;
            --border-color: #333;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            outline: none;
            box-shadow: none;
            -webkit-tap-highlight-color: transparent;
        }

        button:focus {
            outline: none;
            box-shadow: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Selection */
        ::selection {
            background-color: var(--color-primary);
            color: #000;
        }

        /* Loader */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(128, 128, 128, 0.2);
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden-loader {
            display: none !important;
        }

        /* Nav Link Active State */
        .nav-link.active {
            color: var(--color-primary);
            font-weight: 700;
        }

        .nav-link {
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--color-primary);
        }

        /* Movie Card & Utilities */
        .vline {
            display: inline-block;
            width: 4px;
            background-color: var(--color-primary);
            margin-right: 10px;
            height: 1.5rem;
            vertical-align: middle;
        }

        .movie-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            overflow: hidden;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .movie-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 20px var(--shadow-color);
            border-color: var(--color-primary);
        }

        .movie-card img {
            transition: opacity 0.2s ease-in-out;
        }

        .movie-card:hover img {
            opacity: 0.8;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            scroll-behavior: smooth;
        }

        .horizontal-scroll-container .movie-card {
            min-width: 280px;
            max-width: 280px;
        }

        /* Filter Selects */
        .filter-select {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 0.875rem;
            /* Adjusted padding for better text alignment with arrow */
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 0.375rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            cursor: pointer;
            outline: none;
            /* Responsive width handling */
            width: 100%;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 640px) {
            .filter-select {
                width: auto;
                min-width: 140px;
                max-width: 200px;
            }
        }

        .filter-select:hover {
            border-color: var(--color-primary);
        }

        /* Bottom Nav Specifics */
        .bottom-nav-item {
            color: #808080;
            transition: color 0.2s, transform 0.2s;
        }

        .bottom-nav-item.active {
            color: #ffffff;
        }

        .bottom-nav-item.active i {
            transform: scale(1.1);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        /* Utilities */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="global-loader" class="hidden-loader">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-primary font-bold tracking-widest animate-pulse">LOADING</p>
        </div>
    </div>

    <nav id="navbar"
        class="fixed top-0 left-0 w-full z-50 bg-black border-b border-border-color transition-colors duration-300 pt-[env(safe-area-inset-top)]">
        <div class="px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <a onclick="router('home')" class="cursor-pointer">
                <h1 class="text-2xl outline-none tracking-tight font-extrabold text-text-main">Go<span
                        class="text-primary">Stream</span></h1>
            </a>
            <div class="hidden nav-bp:flex space-x-6 items-center outline-none">
                <a onclick="router('home')" class="nav-link text-text-main font-medium" data-target="home"><i
                        class="fas fa-house mr-2"></i>HOME</a>
                <a onclick="router('movies')" class="nav-link text-text-main font-medium" data-target="movies"><i
                        class="fas fa-clapperboard mr-2"></i>MOVIES</a>
                <a onclick="router('tv')" class="nav-link text-text-main font-medium" data-target="tv"><i
                        class="fas fa-tv mr-2"></i>TV SHOWS</a>
                <a onclick="router('anime-anilist')" class="nav-link text-text-main font-medium"
                    data-target="anime-anilist"><i class="fas fa-film mr-2"></i>ANIME</a>
                <a onclick="router('watchlist')" class="nav-link text-text-main font-medium" data-target="watchlist"><i
                        class="fas fa-layer-group mr-2"></i>LIBRARY</a>

            </div>
            <div class="flex items-center pl-3 space-x-4">
                <div class="relative block">
                    <input id="global-search-input" type="text" placeholder="Search + Enter"
                        class="bg-input-bg border border-border-color text-text-main text-sm rounded-md py-1.5 pl-8 pr-3 md:w-64 lg:w-80 w-36 sm:w-64 focus:outline-none focus:border-primary transition-colors">
                    <i class="fas fa-search text-text-muted absolute left-3 top-1/2 -translate-y-1/2 text-xs"></i>
                </div>
            </div>
        </div>
    </nav>

    <div id="bottom-nav"
        class="nav-bp:hidden fixed bottom-4 left-4 right-4 bg-black/50 backdrop-blur-xl border border-white/10 rounded-2xl z-50 flex justify-around items-center h-[60px] shadow-2xl">
        <button onclick="router('home')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1" data-target="home"><i
                class="fas fa-house"></i><span class="text-[10px] font-medium tracking-wide">Home</span></button>
        <button onclick="router('movies')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="movies"><i class="fas fa-clapperboard"></i><span
                class="text-[10px] font-medium tracking-wide">Movies</span></button>
        <button onclick="router('tv')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1" data-target="tv"><i
                class="fas fa-tv"></i><span class="text-[10px] font-medium tracking-wide">TV
                Shows</span></button>
        <button onclick="router('anime-anilist')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="anime-anilist"><i class="fas fa-film"></i><span
                class="text-[10px] font-medium tracking-wide">Anime</span></button>
        <button onclick="router('watchlist')"
            class="bottom-nav-item flex flex-col items-center justify-center w-full h-full gap-1"
            data-target="watchlist"><i class="fas fa-layer-group"></i><span
                class="text-[10px] font-medium tracking-wide">Library</span></button>
    </div>

    <main id="main-content" class="pt-16 pb-20 min-h-screen">
        <section id="shared-banner"
            class="relative h-[45vh] md:h-[60vh] flex items-end p-4 md:p-12 bg-cover bg-center bg-no-repeat transition-all duration-500 hidden">
            <div class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-dark-bg via-dark-bg/60 to-transparent"></div>
            <div id="banner-content" class="z-10 max-w-4xl relative fade-in"></div>
        </section>

        <section id="view-home" class="view-section px-4 sm:px-6 lg:px-8 py-8 space-y-8 hidden">
            <div id="continue-watching-container" class="discovery-row hidden">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center">
                    <span class="vline"></span>Continue Watching
                    <button onclick="clearHistory()"
                        class="ml-auto text-xs text-text-muted hover:text-primary underline">Clear</button>
                </h2>
                <div id="row-continue-watching" class="horizontal-scroll-container pb-4"></div>
            </div>

            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Trending Now</h2>
                <div id="row-trending" class="horizontal-scroll-container pb-4"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Top Rated Movies</h2>
                <div id="row-top-rated" class="horizontal-scroll-container pb-4"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Popular Action</h2>
                <div id="row-action" class="horizontal-scroll-container pb-4"></div>
            </div>
        </section>

        <section id="view-movies" class="view-section px-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 px-2 flex items-center">Popular Movies<sup
                        class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="movies-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-movies" class="results-grid"></div>
            <div id="pag-movies" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-tv" class="view-section px-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 px-2 flex items-center">Popular TV
                    Shows<sup class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="tv-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-tv" class="results-grid"></div>
            <div id="pag-tv" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-anime-anilist" class="view-section hidden w-full px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 px-2 flex items-center">Discover Anime <sup
                        class="text-xs text-primary ml-2">ANILIST</sup></h2>
                <div id="anilist-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-anilist" class="results-grid"></div>
            <div id="pag-anilist" class="pagination-controls mt-8 flex justify-center gap-2">
                <button onclick="changeAnilistPage(-1)"
                    class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                        class="fas fa-chevron-left"></i></button>
                <span id="anilist-page-num" class="px-3 py-1 text-primary font-bold">1</span>
                <button onclick="changeAnilistPage(1)"
                    class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                        class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section id="view-watchlist" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <h2 class="text-2xl md:text-3xl font-bold flex text-primary mb-6">Library</h2>
            <div id="grid-watchlist" class="results-grid"></div>
        </section>

        <section id="view-search" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <h2 class="text-2xl font-bold text-text-main mb-6">Search Results</h2>
            <div id="grid-search" class="results-grid"></div>
        </section>

        <section id="view-details" class="view-section hidden w-full">
            <div id="details-content" class="animate-fade-in"></div>
        </section>

        <section id="view-anilist-player" class="view-section hidden w-full bg-dark-bg">
            <div id="anilist-info-banner" class="w-full h-[300px] md:h-[400px] bg-cover bg-center relative">
                <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
            </div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                        <img id="anilist-info-img" src=""
                            class="w-[180px] hidden md:block md:w-full mx-auto md:mx-0 rounded-md shadow-2xl">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white block md:hidden flex items-center gap-2 text-sm font-medium"><i
                                class="fas fa-arrow-left"></i> Back to Browse</button>
                        <div class="mb-6 bg-gradient-to-t from-dark-bg to-transparent">
                            <h1 id="anilist-player-title"
                                class="text-2xl md:text-4xl font-extrabold text-white mb-3 leading-tight"></h1>
                            <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-6">
                                <span id="anilist-banner-score" class="text-primary font-bold"></span>
                                <span id="anilist-banner-year"
                                    class="px-2 py-0.5 border border-border-color rounded"></span>
                                <span id="anilist-banner-type" class="uppercase"></span>
                                <span><button id="anilist-watchlist-btn"
                                        class="w-full bg-primary text-black pt-4 py-3.5 px-3.5 font-bold rounded shadow-lg transition transform flex items-center justify-center gap-2"><i
                                            class="material-icons">bookmark_add</i></button></span>
                            </div>
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                                <div id="anilist-info-desc"
                                    class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto pr-2">
                                </div>
                            </div>
                        </div>
                        <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                            <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>
                            <div>
                                <p id="anilist-info-Romaji" class="text-text-main text-xs font-medium italic"></p>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Format</span>
                                    <p id="anilist-info-Type"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Episodes</span>
                                    <p id="anilist-info-Episodes"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Status</span>
                                    <p id="anilist-info-Status"
                                        class="text-primary text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Season</span>
                                    <p id="anilist-info-Season"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Start
                                        Date</span>
                                    <p id="anilist-info-Date"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Studios</span>
                                    <p id="anilist-info-Studio"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Producers</span>
                                    <p id="anilist-info-Producers"
                                        class="text-text-main text-xs font-medium text-right md:text-left line-clamp-2">
                                    </p>
                                </div>
                                <div><span class="text-text-muted text-xs">Genres</span>
                                    <div id="anilist-info-Genres" class="flex flex-wrap gap-1 mt-1"></div>
                                </div>
                            </div>
                            <div class="mb-8 border-t border-border-color pt-2">
                                <h3 class="text-lg font-bold text-text-main mb-3">Cast & Voice Actors</h3>
                                <div id="anilist-cast-grid" class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">
                                </div>
                            </div>
                        </div>
                        <div id="anilist-info-Relations-Container"
                            class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color hidden">
                            <h4 class="font-bold text-text-main border-b border-border-color pb-2">Relations</h4>
                            <div id="anilist-info-Relations" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1">
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 pt-4 md:pt-16 min-w-0">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white hidden md:block flex items-center gap-2 text-sm font-medium"><i
                                class="fas fa-arrow-left"></i> Back to Browse</button>
                        <div class="mb-8 space-y-4">
                            <div class="rounded-lg overflow-hidden border border-border-color bg-black shadow-xl">
                                <div
                                    class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                                    <div class="flex items-center gap-2 text-primary font-bold"><i
                                            class="fas fa-play-circle"></i> <span id="anilist-player-ep">Episode
                                            1</span></div>
                                    <div id="anime-server-buttons" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="aspect-video relative bg-black"><iframe id="anilist-iframe"
                                        class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe></div>
                                <div
                                    class="bg-card-bg px-4 py-3 flex justify-between items-center border-t border-border-color">
                                    <button onclick="changeAnilistEp(-1)"
                                        class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium"><i
                                            class="fas fa-backward mr-1"></i> Prev</button>
                                    <button onclick="changeAnilistEp(1)"
                                        class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">Next
                                        <i class="fas fa-forward ml-1"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-text-main mb-3">Episodes</h3>
                            <div id="anilist-episodes-grid"
                                class="grid grid-cols-5 pt-4 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-40 overflow-y-auto custom-scroll pr-2">
                            </div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-lg font-bold text-text-main mb-3">Recommendations</h3>
                            <div id="anilist-recommendations-grid" class="horizontal-scroll-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-nav-bg py-6 hidden md:block border-t border-border-color mt-auto w-full">
        <div class="container mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <h2 class="text-lg font-bold text-text-main">Go<span class="text-primary">Stream</span></h2>
            </div>
            <p class="text-xs text-text-muted">GoStream does not store any files on our server, we only linked to the
                media which is hosted on 3rd party services.</p>
            <p id="credits" class="block text-sm text-text-muted sm:text-center">Â© <span
                    id="current-year-copyright">GoStream</span>. All rights reserved.</p>
        </div>
    </footer>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <script>
        /**
         * GLOBAL CONFIGURATION & DATA
         */
        const API_KEY = 'bea92ea47a50fb9e1cd25ca8443c5718';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_URL = 'https://image.tmdb.org/t/p/original';
        const ANILIST_API_URL = 'https://graphql.anilist.co';

        const MOVIE_SOURCES = [
            { name: '1', url: (id) => `https://vidsrc.cc/v2/embed/movie/${id}?autoPlay=true` },
            { name: '2', url: (id) => `https://vidsrc.icu/embed/movie/${id}` },
            { name: '3', url: (id) => `https://vidlink.pro/movie/${id}` },
            { name: '4', url: (id) => `https://111movies.com/movie/${id}` },
            { name: '5', url: (id) => `https://vidrock.net/movie/${id}?autoplay=true&download=false` },
            { name: '6', url: (id) => `https://player.videasy.net/movie/${id}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const TV_SOURCES = [
            { name: '1', url: (id, s, e) => `https://vidsrc.cc/v2/embed/tv/${id}/${s}/${e}?autoPlay=true` },
            { name: '2', url: (id, s, e) => `https://vidsrc.icu/embed/tv/${id}/${s}/${e}` },
            { name: '3', url: (id, s, e) => `https://vidlink.pro/tv/${id}/${s}/${e}?title=true&poster=true&autoplay=true&nextbutton=true` },
            { name: '4', url: (id, s, e) => `https://111movies.com/tv/${id}/${s}/${e}` },
            { name: '5', url: (id, s, e) => `https://vidrock.net/tv/${id}/${s}/${e}?autoplay=true&download=false&episodeselector=false&enlang` },
            { name: '6', url: (id, s, e) => `https://player.videasy.net/tv/${id}/${s}/${e}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const ANIME_SOURCES = [
            { name: '1', url: (id, ep) => `https://vidsrc.cc/v2/embed/anime/ani${id}/${ep}/sub` },
            { name: '2', url: (id, ep) => `https://vidsrc.icu/embed/anime/${id}/${ep}/0` }
        ];

        // Constants for Filters
        const COUNTRIES = [
            { code: '', name: 'All Countries' }, { code: 'CN', name: 'China' }, { code: 'FR', name: 'France' },
            { code: 'HK', name: 'Hongkong' }, { code: 'IN', name: 'India' }, { code: 'JP', name: 'Japan' },
            { code: 'RU', name: 'Russia' }, { code: 'KR', name: 'South Korea' }, { code: 'ES', name: 'Spain' },
            { code: 'TH', name: 'Thailand' }, { code: 'TR', name: 'Turkey' }, { code: 'GB', name: 'United Kingdom' },
            { code: 'US', name: 'United States' }
        ];

        const TMDB_GENRES = [
            { id: '', name: 'All Genres' }, { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 14, name: 'Fantasy' }, { id: 36, name: 'History' }, { id: 27, name: 'Horror' },
            { id: 10402, name: 'Music' }, { id: 9648, name: 'Mystery' }, { id: 10749, name: 'Romance' }, { id: 878, name: 'Sci-Fi' },
            { id: 53, name: 'Thriller' }
        ];

        const MOVIE_GENRES = TMDB_GENRES;
        const TV_GENRES = [
            { id: '', name: 'All Genres' }, { id: 10759, name: 'Action & Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 10762, name: 'Kids' }, { id: 9648, name: 'Mystery' }, { id: 10763, name: 'News' },
            { id: 10764, name: 'Reality' }, { id: 10765, name: 'Sci-Fi & Fantasy' }, { id: 10766, name: 'Soap' }, { id: 10767, name: 'Talk' },
            { id: 10768, name: 'War & Politics' }, { id: 37, name: 'Western' }
        ];

        const TV_STATUS = [
            { value: '', name: 'All Status' }, { value: '0', name: 'Returning Series' }, { value: '3', name: 'Ended' },
            { value: '4', name: 'Canceled' }, { value: '2', name: 'In Production' }, { value: '5', name: 'Pilot' }
        ];

        const MOVIE_STATUS = [
            { value: '', name: 'All Status' }, { value: 'released', name: 'Released' }, { value: 'upcoming', name: 'Upcoming' }
        ];

        const ANILIST_GENRES = [
            'Action', 'Adventure', 'Comedy', 'Drama', 'Ecchi', 'Fantasy', 'Horror', 'Mecha', 'Music', 'Mystery',
            'Psychological', 'Romance', 'Sci-Fi', 'Slice of Life', 'Sports', 'Supernatural', 'Thriller'
        ];

        // Global State
        const appState = {
            currentView: 'home',
            lastView: 'home',
            watchlist: JSON.parse(localStorage.getItem('goStreamWatchlist')) || [],
            continueWatching: JSON.parse(localStorage.getItem('goStreamContinueWatching')) || [],
            tmdb: {
                movies: { page: 1, filters: { sort: 'popularity.desc', genre: '', country: '', status: '', year: '' }, data: [] },
                tv: { page: 1, filters: { sort: 'popularity.desc', genre: '', country: '', status: '', year: '' }, data: [] }
            },
            anilist: {
                page: 1,
                filters: { sort: 'TRENDING_DESC', genre: '', country: '', upcoming: '', year: '' },
                data: [],
                hero: [],
                currentAnime: null,
                currentEp: 1,
                currentServerIdx: 0
            }
        };

        /**
         * CORE UTILITIES
         */
        const loader = {
            count: 0,
            show: () => {
                loader.count++;
                document.getElementById('global-loader').classList.remove('hidden-loader');
            },
            hide: () => {
                loader.count--;
                if (loader.count <= 0) {
                    loader.count = 0;
                    document.getElementById('global-loader').classList.add('hidden-loader');
                }
            }
        };

        const getPosterUrl = (path) => {
            if (!path) return 'https://placehold.co/500x750/333/FFF?text=No+Image';
            return path.startsWith('http') ? path : IMG_URL + path;
        };

        const getBackdropUrl = (path) => {
            if (!path) return 'https://placehold.co/1920x1080/202125/FFF?text=No+Banner+available';
            return path.startsWith('http') ? path : BACKDROP_URL + path;
        };

        function router(viewName) {
            const tmdbFrame = document.getElementById('tmdb-player');
            const aniFrame = document.getElementById('anilist-iframe');
            if (tmdbFrame) tmdbFrame.src = "";
            if (aniFrame) aniFrame.src = "";

            // List of top-level navigation pages
            const mainViews = ['home', 'movies', 'tv', 'anime-anilist', 'watchlist'];

            // 1. Update History Strategy
            // If we are currently on a main view, and we are navigating AWAY to a sub-view (details/search/player)
            // OR simply navigating to another main view, update logic.
            // Actually, simpler: If the *current* view before switching IS a main view, save it as lastView.
            if (mainViews.includes(appState.currentView)) {
                appState.lastView = appState.currentView;
            }

            // 2. Determine Active Tab Highlighting
            // Default target is the view we are going to
            let activeTarget = viewName;

            // If the destination is NOT a main view (e.g. details, search, player),
            // fallback to highlighting the last visited main view.
            if (!mainViews.includes(viewName)) {
                activeTarget = appState.lastView || 'home';
            }

            // Apply classes
            document.querySelectorAll('.nav-link').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.bottom-nav-item').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('shared-banner').classList.add('hidden');

            appState.currentView = viewName;
            window.scrollTo(0, 0);

            switch (viewName) {
                case 'home':
                    document.getElementById('view-home').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    loadHomeData();
                    break;
                case 'movies':
                    document.getElementById('view-movies').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    renderFilters('movies');
                    loadTMDBSection('movies', '/discover/movie');
                    break;
                case 'tv':
                    document.getElementById('view-tv').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    renderFilters('tv');
                    loadTMDBSection('tv', '/discover/tv');
                    break;
                case 'anime-anilist':
                    document.getElementById('view-anime-anilist').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    renderFilters('anilist');
                    loadAnilistSection();
                    break;
                case 'watchlist':
                    document.getElementById('view-watchlist').classList.remove('hidden');
                    renderWatchlist();
                    break;
                case 'search':
                    document.getElementById('view-search').classList.remove('hidden');
                    break;
                case 'details':
                    document.getElementById('view-details').classList.remove('hidden');
                    break;
                case 'anilist-player':
                    document.getElementById('view-anilist-player').classList.remove('hidden');
                    break;
            }
        }

        /**
         * FEATURE: Continue Watching
         */
        function addToHistory(id, type, title, poster, backdrop, season = null, episode = null) {
            // Remove if exists
            appState.continueWatching = appState.continueWatching.filter(i => i.id !== id);
            // Add to top
            appState.continueWatching.unshift({
                id, type, title, poster, backdrop, season, episode, timestamp: new Date().getTime()
            });
            // Limit to 20
            if (appState.continueWatching.length > 20) appState.continueWatching.pop();

            localStorage.setItem('goStreamContinueWatching', JSON.stringify(appState.continueWatching));
        }

        function clearHistory() {
            appState.continueWatching = [];
            localStorage.removeItem('goStreamContinueWatching');
            renderContinueWatching();
        }

        function renderContinueWatching() {
            const container = document.getElementById('row-continue-watching');
            const wrapper = document.getElementById('continue-watching-container');

            container.innerHTML = '';

            if (appState.continueWatching.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }

            wrapper.classList.remove('hidden');

            appState.continueWatching.forEach(item => {
                // Use backdrop if available, otherwise poster
                let imgUrl;
                if (item.backdrop) {
                    imgUrl = getBackdropUrl(item.backdrop);
                } else {
                    imgUrl = getPosterUrl(item.poster);
                }

                const card = document.createElement('div');
                card.className = 'movie-card cursor-pointer relative group';

                let badge = '';
                if (item.type === 'tv' && item.season) {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">S${item.season} E${item.episode}</div>`;
                } else if (item.type === 'anime') {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">EP ${item.episode}</div>`;
                }

                // Use aspect-video (landscape) to match other home rows
                card.innerHTML = `
                    <div class="aspect-video overflow-hidden relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        ${badge}
                        <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                            <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg"></i>
                        </div>
                        <div class="absolute bottom-0 w-full bg-black/80 p-2">
                            <div class="h-1 bg-gray-600 rounded-full overflow-hidden">
                                <div class="h-full bg-primary w-1/2"></div> </div>
                        </div>
                    </div>
                    <div class="p-3 bg-card-bg">
                        <h3 class="text-text-main text-sm font-semibold truncate">${item.title}</h3>
                        <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                            <span class="uppercase text-[10px]">Resume</span>
                        </div>
                    </div>
                `;

                card.onclick = () => {
                    if (item.type === 'anime') {
                        // Pre-load specific anime episode (needs slight mod to openAnilistPlayer)
                        openAnilistPlayer(item.id, item.episode);
                    } else {
                        openDetails(item.id, item.type, item.season, item.episode);
                    }
                };
                container.appendChild(card);
            });
        }


        /**
         * FILTER LOGIC
         */
        function renderFilters(section) {
            const containerId = section === 'anilist' ? 'anilist-filters' : `${section}-filters`;
            const container = document.getElementById(containerId);
            if (!container || container.innerHTML !== '') return;

            // Apply responsive layout classes: Grid on mobile (2 cols), Flex on desktop
            container.className = 'grid grid-cols-2 sm:flex sm:flex-wrap gap-2 w-full sm:w-auto';

            const isAnilist = section === 'anilist';
            const stateRef = isAnilist ? appState.anilist.filters : appState.tmdb[section].filters;

            const sortSelect = document.createElement('select');
            sortSelect.className = 'filter-select';
            if (isAnilist) {
                sortSelect.innerHTML = `
                <option value="TRENDING_DESC">Trending</option>
                <option value="POPULARITY_DESC">Popular</option>
                <option value="SCORE_DESC">Top Rated</option>`;
            } else {
                sortSelect.className = 'hidden';
            }
            sortSelect.value = stateRef.sort;
            sortSelect.onchange = (e) => {
                stateRef.sort = e.target.value;
                resetAndLoad(section);
            };

            const genreSelect = document.createElement('select');
            genreSelect.className = 'filter-select';
            if (isAnilist) {
                genreSelect.innerHTML = `<option value="">All Genres</option>` + ANILIST_GENRES.map(g => `<option value="${g}">${g}</option>`).join('');
            } else if (section === 'movies') {
                genreSelect.innerHTML = MOVIE_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            } else {
                genreSelect.innerHTML = TV_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            }

            genreSelect.value = stateRef.genre;
            genreSelect.onchange = (e) => {
                stateRef.genre = e.target.value;
                resetAndLoad(section);
            };

            const statusSelect = document.createElement('select');
            statusSelect.className = 'filter-select';
            if (section === 'movies') {
                statusSelect.innerHTML = MOVIE_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else if (!isAnilist) {
                statusSelect.innerHTML = TV_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else {
                statusSelect.classList.add('hidden');
            }
            if (!isAnilist) {
                statusSelect.value = stateRef.status;
                statusSelect.onchange = (e) => {
                    stateRef.status = e.target.value;
                    resetAndLoad(section);
                };
            }

            const countrySelect = document.createElement('select');
            countrySelect.className = 'filter-select';
            countrySelect.innerHTML = COUNTRIES.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            countrySelect.value = stateRef.country;
            countrySelect.onchange = (e) => {
                stateRef.country = e.target.value;
                resetAndLoad(section);
            };

            container.append(sortSelect, genreSelect);
            if (!isAnilist) container.append(statusSelect, countrySelect);

            if (isAnilist) {
                const upcomingSelect = document.createElement('select');
                upcomingSelect.className = 'filter-select';
                upcomingSelect.innerHTML = `
                    <option value="">Upcoming: Off</option>
                    <option value="POPULARITY_DESC">Upcoming: Popularity</option>
                    <option value="TRENDING_DESC">Upcoming: Trending</option>
                    <option value="START_DATE">Upcoming: Release Date</option>
                `;
                upcomingSelect.value = stateRef.upcoming;
                upcomingSelect.onchange = (e) => {
                    stateRef.upcoming = e.target.value;
                    resetAndLoad(section);
                };
                container.append(upcomingSelect);
            }

            // --- ADDED YEAR FILTER (Global for Movies/TV/Anime) ---
            const yearSelect = document.createElement('select');
            yearSelect.className = 'filter-select';

            const currentYear = new Date().getFullYear() + 1; // Allow next year for upcoming
            let yearOptions = '<option value="">All Years</option>';
            for (let y = currentYear; y >= 1970; y--) {
                yearOptions += `<option value="${y}">${y}</option>`;
            }
            yearSelect.innerHTML = yearOptions;

            yearSelect.value = stateRef.year;
            yearSelect.onchange = (e) => {
                stateRef.year = e.target.value;
                resetAndLoad(section);
            };
            container.append(yearSelect);
        }

        function resetAndLoad(section) {
            if (section === 'anilist') {
                appState.anilist.page = 1;
                loadAnilistSection();
            } else {
                appState.tmdb[section].page = 1;
                const endpoint = section === 'movies' ? '/discover/movie' : '/discover/tv';
                loadTMDBSection(section, endpoint);
            }
        }

        /**
         * TMDB API
         */
        async function fetchTMDB(endpoint, params = {}, showLoader = true) {
            if (showLoader) loader.show();
            params.api_key = API_KEY;
            const qs = new URLSearchParams(params).toString();
            try {
                const res = await fetch(`${TMDB_BASE_URL}${endpoint}?${qs}`);
                const data = await res.json();
                if (showLoader) loader.hide();
                return data;
            } catch (e) {
                console.error("TMDB Error", e);
                if (showLoader) loader.hide();
                return null;
            }
        }

        async function loadHomeData() {
            // Render Continue Watching first
            renderContinueWatching();

            const container = document.getElementById('row-trending');
            if (container.innerHTML !== '') return;
            const trending = await fetchTMDB('/trending/all/day');
            if (trending) renderTMDBGrid('row-trending', trending.results, null, true);
            if (trending && trending.results.length > 0) updateSharedBanner(trending.results[0]);
            const topRated = await fetchTMDB('/movie/top_rated');
            if (topRated) renderTMDBGrid('row-top-rated', topRated.results, null, true);
            const action = await fetchTMDB('/discover/movie', { with_genres: 28 });
            if (action) renderTMDBGrid('row-action', action.results, null, true);
        }

        async function loadTMDBSection(key, endpoint, extraParams = {}) {
            const stateRef = appState.tmdb[key];
            const gridId = `grid-${key}`;
            const grid = document.getElementById(gridId);

            loader.show();

            const params = {
                page: stateRef.page,
                sort_by: stateRef.filters.sort,
                language: 'en-US',
                'vote_count.gte': 0,
                ...extraParams
            };

            const today = new Date().toISOString().split('T')[0];

            if (stateRef.filters.status) {
                if (key === 'movies') {
                    if (stateRef.filters.status === 'upcoming') {
                        params['primary_release_date.gte'] = today;
                    } else if (stateRef.filters.status === 'released') {
                        params['primary_release_date.lte'] = today;
                    }
                } else {
                    params.with_status = stateRef.filters.status;
                }
            }

            if ((stateRef.filters.sort.includes('date') || stateRef.filters.sort.includes('first_air_date'))) {
                if (stateRef.filters.status !== 'upcoming') {
                    if (key === 'movies') params['primary_release_date.lte'] = today;
                    else params['first_air_date.lte'] = today;
                }
                delete params['vote_count.gte'];
                params['vote_count.gte'] = 0;
            }

            if (stateRef.filters.genre) params.with_genres = stateRef.filters.genre;
            if (stateRef.filters.country) params.with_origin_country = stateRef.filters.country;

            // --- ADDED YEAR FILTER LOGIC ---
            if (stateRef.filters.year) {
                if (key === 'movies') params.primary_release_year = stateRef.filters.year;
                else params.first_air_date_year = stateRef.filters.year;
            }

            const data = await fetchTMDB(endpoint, params, false);

            grid.innerHTML = '';
            if (data && data.results && data.results.length > 0) {
                const bannerItem = data.results[Math.floor(Math.random() * Math.min(5, data.results.length))];
                bannerItem.media_type = key === 'movies' ? 'movie' : 'tv';
                updateSharedBanner(bannerItem);

                await renderTMDBGrid(gridId, data.results, key === 'movies' ? 'movie' : 'tv');

                renderPagination(`pag-${key}`, stateRef.page, data.total_pages, (p) => {
                    stateRef.page = p;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    loadTMDBSection(key, endpoint, extraParams);
                });
            } else {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No results found.</p>';
            }
            loader.hide();
        }

        /**
         * ANILIST API
         */
        async function fetchAnilist(query, variables = {}) {
            loader.show();
            try {
                const res = await fetch(ANILIST_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });
                const json = await res.json();
                loader.hide();
                return json.data;
            } catch (e) {
                console.error("Anilist Error", e);
                loader.hide();
                return null;
            }
        }

        function mapAnilistToShared(anime) {
            return {
                id: anime.id,
                title: anime.title.english || anime.title.romaji,
                name: anime.title.english || anime.title.romaji,
                overview: anime.description,
                backdrop_path: anime.bannerImage || anime.coverImage.extraLarge,
                poster_path: anime.coverImage.extraLarge,
                vote_average: (anime.averageScore || 0) / 10,
                media_type: 'anime',
                release_date: anime.seasonYear ? String(anime.seasonYear) : 'N/A',
                status: anime.status
            };
        }

        async function loadAnilistSection() {
            const state = appState.anilist;
            const gridId = 'grid-anilist';

            // --- MODIFIED: Added $year variable ---
            const query = `
            query ($page: Int, $sort: [MediaSort], $genre: String, $country: CountryCode, $status: MediaStatus, $year: Int) {
                Page(page: $page, perPage: 24) {
                    pageInfo { hasNextPage }
                    media(sort: $sort, genre: $genre, countryOfOrigin: $country, status: $status, seasonYear: $year, type: ANIME, isAdult: false) {
                        id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear
                    }
                }
            }`;

            const vars = { page: state.page };

            if (state.filters.upcoming) {
                vars.status = 'NOT_YET_RELEASED';
                vars.sort = state.filters.upcoming;
            } else {
                vars.sort = state.filters.sort;
            }

            if (state.filters.genre) vars.genre = state.filters.genre;
            if (state.filters.country) vars.country = state.filters.country;
            if (state.filters.year) vars.year = parseInt(state.filters.year); // --- ADDED YEAR FILTER ---

            const data = await fetchAnilist(query, vars);
            if (data && data.Page.media) {
                state.data = data.Page.media;
                const mappedData = state.data.map(mapAnilistToShared);

                if (mappedData.length > 0) {
                    updateSharedBanner(mappedData[Math.floor(Math.random() * mappedData.length)]);
                }

                renderAnilistGrid(gridId, mappedData);
                document.getElementById('anilist-page-num').innerText = state.page;
            }
        }

        function changeAnilistPage(dir) {
            const currentPage = parseInt(appState.anilist.page) || 1;
            const next = currentPage + dir;
            if (next > 0) {
                appState.anilist.page = next;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                loadAnilistSection();
            }
        }

        // Updated to accept an optional startEpisode
        async function openAnilistPlayer(id, startEpisode = 1) {
            router('anilist-player');
            const state = appState.anilist;

            const query = `query ($id: Int) { Media(id: $id) { id title { romaji english } 
            description 
            coverImage { extraLarge } 
            bannerImage
            episodes
                    nextAiringEpisode { episode }
                    averageScore
                    format
                    duration
                    status
                    season
                    seasonYear
                    studios { nodes { name isAnimationStudio } }
                    startDate { year month day }
                    genres
                    description
                    relations { edges { relationType node { id title { romaji } format status coverImage { medium } } } }
                    recommendations(sort: RATING_DESC, perPage: 10) {
                        nodes {
                            mediaRecommendation {
                                id
                                title { romaji english }
                                coverImage { extraLarge }
                                bannerImage
                                format
                                averageScore
                                status
                                seasonYear
                            }
                        }
                    }
                    characters(page: 1, perPage: 25, sort: [ROLE, FAVOURITES_DESC]) {
                    edges {
                    role
                    voiceActors(language: JAPANESE, sort: [FAVOURITES_DESC]) {
                    id
                    name { full } image { medium } }
                    node { id name { userPreferred } image { medium }
                    }
                    }
                }
            } }`;

            const data = await fetchAnilist(query, { id });
            if (!data || !data.Media) return;
            const anime = data.Media;
            state.currentAnime = anime;
            state.currentEp = startEpisode; // Use provided start episode

            const bannerUrl = getBackdropUrl(anime.bannerImage || anime.coverImage.extraLarge);
            document.getElementById('anilist-info-banner').style.backgroundImage = `url(${bannerUrl})`;
            document.getElementById('anilist-player-title').innerText = anime.title.english || anime.title.romaji;
            document.getElementById('anilist-info-img').src = anime.coverImage.extraLarge;
            document.getElementById('anilist-banner-score').innerText = (anime.averageScore || '??') + '% Score';
            document.getElementById('anilist-banner-type').innerText = anime.format || 'TV';
            document.getElementById('anilist-banner-year').innerText = anime.seasonYear || 'N/A';
            document.getElementById('anilist-info-desc').innerHTML = anime.description;
            document.getElementById('anilist-info-Romaji').innerText = anime.title.romaji;
            document.getElementById('anilist-info-Type').innerText = anime.format;
            document.getElementById('anilist-info-Status').innerText = anime.status ? anime.status.replace(/_/g, ' ') : 'Unknown';
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            document.getElementById('anilist-info-Date').innerText = anime.startDate && anime.startDate.year ? `${months[anime.startDate.month - 1]} ${anime.startDate.day} ${anime.startDate.year}` : '?';

            const currentAired = anime.nextAiringEpisode ? anime.nextAiringEpisode.episode - 1 : (anime.episodes || '?');
            const totalEps = anime.episodes || '?';
            document.getElementById('anilist-info-Episodes').innerText = `${currentAired} / ${totalEps}`;

            const seas = anime.season ? anime.season.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : '';
            document.getElementById('anilist-info-Season').innerText = `${seas} ${anime.seasonYear || ''}`;

            const studios = [];
            const producers = [];
            if (anime.studios && anime.studios.nodes) {
                anime.studios.nodes.forEach(s => {
                    if (s.isAnimationStudio) studios.push(s.name);
                    else producers.push(s.name);
                });
            }
            document.getElementById('anilist-info-Studio').innerText = studios.join(', ') || 'N/A';
            document.getElementById('anilist-info-Producers').innerText = producers.slice(0, 4).join(', ') || 'N/A';

            const genreContainer = document.getElementById('anilist-info-Genres');
            genreContainer.innerHTML = '';
            if (anime.genres) {
                anime.genres.forEach(g => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-0.5 bg-input-bg border border-border-color rounded text-[10px] text-text-muted";
                    span.innerText = g;
                    genreContainer.appendChild(span);
                });
            }

            const relContainer = document.getElementById('anilist-info-Relations-Container');
            const relList = document.getElementById('anilist-info-Relations');
            relList.innerHTML = '';

            if (anime.relations && anime.relations.edges && anime.relations.edges.length > 0) {
                const validRelations = anime.relations.edges.filter(r => r.node.format !== 'MANGA' && r.node.format !== 'NOVEL' && r.node.format !== 'MUSIC' && r.node.format !== 'ONE_SHOT');

                if (validRelations.length > 0) {
                    relContainer.classList.remove('hidden');
                    validRelations.forEach(edge => {
                        const div = document.createElement('div');
                        div.className = 'cursor-pointer hover:bg-nav-bg p-1.5 rounded flex gap-3 items-center transition-colors group border border-transparent hover:border-border-color';
                        const imgUrl = edge.node.coverImage?.medium || 'https://placehold.co/50x75?text=No+Img';
                        const relationType = edge.relationType.replace(/_/g, ' ').toLowerCase();

                        div.innerHTML = `
                            <div class="flex-shrink-0 w-10 h-14 overflow-hidden rounded shadow-sm relative">
                                <img src="${imgUrl}" class="w-full h-full object-cover md:group-hover:scale-110 transition-transform duration-300">
                            </div>
                            <div class="flex flex-col min-w-0 flex-1">
                                <span class="text-[10px] text-primary uppercase font-bold tracking-wider mb-0.5">${relationType}</span>
                                <span class="text-xs text-text-main font-medium truncate md:group-hover:text-primary transition-colors" title="${edge.node.title.romaji}">${edge.node.title.romaji}</span>
                                <span class="text-[10px] text-text-muted truncate">${edge.node.format || 'TV'} Â· ${edge.node.status ? edge.node.status.replace(/_/g, ' ') : '?'}</span>
                            </div>
                        `;
                        div.onclick = () => openAnilistPlayer(edge.node.id);
                        relList.appendChild(div);
                    });
                } else {
                    relContainer.classList.add('hidden');
                }
            } else {
                relContainer.classList.add('hidden');
            }

            const watchlistBtn = document.getElementById('anilist-watchlist-btn');
            watchlistBtn.onclick = () => toggleWatchlist(anime.id, 'anime', anime.title.english || anime.title.romaji, anime.coverImage.extraLarge, 'anilist-watchlist-btn');
            updateWatchlistButtonState(anime.id, 'anilist-watchlist-btn');

            const serverBtnContainer = document.getElementById('anime-server-buttons');
            serverBtnContainer.innerHTML = '';
            ANIME_SOURCES.forEach((src, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === state.currentServerIdx ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                btn.innerHTML = `<i class="fas fa-server mr-2"></i> ${src.name.split(/\s+/).slice(0, 2).join(" ")}`;
                btn.onclick = () => {
                    state.currentServerIdx = idx;
                    Array.from(serverBtnContainer.children).forEach(b => {
                        b.classList.remove('bg-primary', 'text-black');
                        b.classList.add('bg-input-bg', 'text-text-muted');
                    });
                    btn.classList.remove('bg-input-bg', 'text-text-muted');
                    btn.classList.add('bg-primary', 'text-black');
                    playAnilistEp(state.currentEp);
                };
                serverBtnContainer.appendChild(btn);
            });

            const castGrid = document.getElementById('anilist-cast-grid');
            castGrid.className = 'flex overflow-x-auto space-x-4 pb-4';
            castGrid.innerHTML = '';

            if (anime.characters && anime.characters.edges) {
                anime.characters.edges.forEach(charEdge => {
                    if (charEdge.voiceActors && charEdge.voiceActors.length > 0) {
                        charEdge.voiceActors.forEach(va => {
                            const el = document.createElement('div');
                            el.className = "flex flex-col gap-2 min-w-[80px]";
                            const roleDisplay = charEdge.role.charAt(0).toUpperCase() + charEdge.role.slice(1).toLowerCase();
                            el.innerHTML = `
                            <div class="aspect-square rounded-full overflow-hidden border border-border-color w-20 h-20 mx-auto">
                                <img src="${va.image.medium}" class="w-full h-full object-cover" alt="Voice Actor Image">
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-text-main font-semibold truncate" title="${va.name.full}">${va.name.full}</p>
                                <p class="text-[10px] text-text-muted truncate" title="${charEdge.node.name.userPreferred} (${roleDisplay})">
                                    ${charEdge.node.name.userPreferred} | ${roleDisplay}
                                </p>
                            </div>
                        `;
                            castGrid.appendChild(el);
                        });
                    }
                });
            }

            const recsGrid = document.getElementById('anilist-recommendations-grid');
            recsGrid.innerHTML = '';
            if (anime.recommendations && anime.recommendations.nodes) {
                const recItems = anime.recommendations.nodes
                    .map(n => n.mediaRecommendation)
                    .filter(m => m)
                    .map(mapAnilistToShared);
                renderAnilistGrid('anilist-recommendations-grid', recItems, true);
            }
            if (recsGrid.children.length === 0) recsGrid.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';

            const epGrid = document.getElementById('anilist-episodes-grid');
            epGrid.innerHTML = '';

            if (anime.status === 'NOT_YET_RELEASED') {
                epGrid.innerHTML = '<p class="text-xs text-gray-500">Not Yet Aired</p>';
                return;
            }

            let maxEps = anime.episodes || 12;
            if (anime.nextAiringEpisode) {
                maxEps = anime.nextAiringEpisode.episode - 1;
            }

            if (maxEps === 0) epGrid.innerHTML = '<p class="text-xs text-gray-500">No aired episodes yet.</p>';

            for (let i = 1; i <= maxEps; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative group';
                const btn = document.createElement('button');
                btn.className = `w-full p-2 rounded border border-border-color text-xs md:hover:border-primary md:hover:text-primary ${i === 1 ? 'bg-primary text-black' : 'bg-input-bg text-text-muted'}`;
                btn.innerText = i;
                btn.onclick = () => playAnilistEp(i);
                wrapper.appendChild(btn);

                if (anime.status === 'RELEASING' && i === maxEps) {
                    const badge = document.createElement('sup');
                    badge.className = "absolute -top-0.5 -right-0.5 text-[9px] text-primary font-bold bg-black rounded z-10 shadow-sm";
                    badge.innerText = "NEW";
                    wrapper.appendChild(badge);
                }
                epGrid.appendChild(wrapper);
            }
            if (maxEps > 0) playAnilistEp(state.currentEp); // Play the requested episode
        }

        function playAnilistEp(ep) {
            appState.anilist.currentEp = ep;
            document.getElementById('anilist-player-ep').innerText = `Episode ${ep}`;
            const source = ANIME_SOURCES[appState.anilist.currentServerIdx];
            const url = source.url(appState.anilist.currentAnime.id, ep);

            document.getElementById('anilist-iframe').src = url;

            // SAVE HISTORY
            addToHistory(
                appState.anilist.currentAnime.id,
                'anime',
                appState.anilist.currentAnime.title.english || appState.anilist.currentAnime.title.romaji,
                appState.anilist.currentAnime.coverImage.extraLarge,
                appState.anilist.currentAnime.bannerImage, // backdrop
                null,
                ep
            );

            const wrappers = document.getElementById('anilist-episodes-grid').children;
            Array.from(wrappers).forEach(wrapper => {
                const b = wrapper.querySelector('button');
                if (!b) return;
                const btnEpNum = parseInt(b.innerText);
                if (btnEpNum === ep) {
                    b.classList.remove('bg-input-bg', 'text-text-muted');
                    b.classList.add('bg-primary', 'text-black');
                } else {
                    b.classList.add('bg-input-bg', 'text-text-muted');
                    b.classList.remove('bg-primary', 'text-black');
                }
            });
        }

        function changeAnilistEp(dir) {
            const next = appState.anilist.currentEp + dir;
            if (next > 0) playAnilistEp(next);
        }

        /**
         * SEARCH
         */
        const searchInput = document.getElementById('global-search-input');
        const handleSearch = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (val.length > 0) {
                    performSearch(val);
                    e.target.value = '';
                }
            }
        }
        searchInput.addEventListener('keypress', handleSearch);

        async function performSearch(query) {
            router('search');
            const grid = document.getElementById('grid-search');
            grid.innerHTML = '<p class="text-gray-400">Searching...</p>';

            const anilistQuery = `query ($search: String) { Page(page: 1, perPage: 10) { media(search: $search, type: ANIME, isAdult: false) { id title { romaji english } coverImage { extraLarge } format averageScore episodes } } }`;
            const anilistPromise = fetchAnilist(anilistQuery, { search: query });
            const tmdbPromise = fetchTMDB('/search/multi', { query });

            const [anilistRes, tmdbRes] = await Promise.all([anilistPromise, tmdbPromise]);

            searchInput.value = '';
            grid.innerHTML = '';

            if (anilistRes && anilistRes.Page.media) {
                const animeItems = anilistRes.Page.media.map(mapAnilistToShared);
                renderAnilistGrid('grid-search', animeItems, false, true);
            }

            if (tmdbRes && tmdbRes.results) {
                const filtered = tmdbRes.results.filter(i => {
                    const isMedia = i.media_type === 'movie' || i.media_type === 'tv';
                    const isAnime = i.genre_ids && i.genre_ids.includes(16) && i.origin_country && i.origin_country.includes('JP');
                    return isMedia && !isAnime;
                });
                await renderTMDBGrid('grid-search', filtered, null, false, true);
            }

            if (grid.children.length === 0) grid.innerHTML = '<p class="text-gray-400">No results found.</p>';
        }

        /**
         * RENDERERS
         */
        function updateSharedBanner(item) {
            const banner = document.getElementById('shared-banner');
            const bgUrl = getBackdropUrl(item.backdrop_path);

            banner.style.backgroundImage = `url(${bgUrl})`;
            const title = item.title || item.name;
            const desc = item.overview || 'No description available.';
            const type = item.media_type || 'movie';

            document.getElementById('banner-content').innerHTML = `
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 drop-shadow-xl text-white">${title}</h1>
                <p class="text-gray-300 text-sm md:text-lg mb-6 drop-shadow-md line-clamp-3">${desc}</p>
                <div class="flex">
                    <button class="bg-red-600 md:hover:bg-opacity-60 text-white font-bold py-2 px-5 rounded-l-md transition-colors" onclick="openDetailsWrapper(${item.id}, '${type}')">
                        <i class="fas fa-play mr-2"></i> Play Now
                    </button>
                    <button id="banner-watchlist-btn-${item.id}" class="md:hover:bg-opacity-60 pt-4 py-2 px-3 bg-primary text-black font-bold rounded-r-md transition-colors" onclick="toggleWatchlist(${item.id}, '${type}', '${title.replace(/'/g, "")}', '${item.poster_path}', 'banner-watchlist-btn-${item.id}')">
                        <i class="material-icons">bookmark_add</i>
                    </button>
                </div>
            `;
            updateWatchlistButtonState(item.id, `banner-watchlist-btn-${item.id}`);
        }

        function openDetailsWrapper(id, type) {
            if (type === 'anime') openAnilistPlayer(id);
            else openDetails(id, type);
        }

        async function fetchAndDetermineStatus(type, id) {
            try {
                const details = await fetchTMDB(`/${type}/${id}`, {}, false);
                return details.status;
            } catch (error) {
                console.error(`Error fetching status for ${type} ID ${id}:`, error);
                return null;
            }
        }

        async function renderTMDBGrid(containerId, items, typeOverride, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            for (const item of items) {
                if (!item.poster_path) continue;
                const title = item.title || item.name;
                if (/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f\u3131-\uD79D\uAC00-\uD7A3]/.test(title)) continue;

                const type = typeOverride || (item.media_type || 'movie');
                const date = item.release_date || item.first_air_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(item.poster_path);
                }

                const tmdbStatus = await fetchAndDetermineStatus(type, item.id);
                let displayStatus = tmdbStatus || item.status;

                if (!displayStatus && (item.release_date || item.first_air_date)) {
                    const releaseDate = new Date(item.release_date || item.first_air_date);
                    const now = new Date();
                    displayStatus = releaseDate > now ? 'Upcoming' : 'Released';
                }

                const statusBadge = displayStatus ? `<div class="absolute top-2 left-2 bg-primary text-black text-[10px] font-bold px-2 py-0.5 rounded uppercase shadow-md z-10">${displayStatus.replace(/_/g, ' ')}</div>` : '';
                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal);
                container.appendChild(card);
            }
        }

        function renderAnilistGrid(containerId, items, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            items.forEach(item => {
                if (!item.poster_path) return;
                const title = item.title || item.name;
                const type = 'anime';
                const date = item.release_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Banner/Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(item.poster_path);
                }

                const statusBadge = item.status ? `<div class="absolute top-2 left-2 bg-primary text-black text-[10px] font-bold px-2 py-0.5 rounded uppercase shadow-md z-10">${item.status.replace(/_/g, ' ')}</div>` : '';
                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal);
                container.appendChild(card);
            });
        }

        function createCardHTML(id, type, title, posterUrl, vote, year, statusBadge, isHorizontal) {
            const card = document.createElement('div');
            card.className = 'movie-card cursor-pointer relative group';

            // --- MODIFIED: Switch aspect ratio class based on isHorizontal flag ---
            const aspectClass = isHorizontal ? 'aspect-video' : 'aspect-[2/3]';

            card.innerHTML = `
            <div class="${aspectClass} overflow-hidden relative">
                <img src="${posterUrl}" class="w-full h-full object-cover">
                ${statusBadge}
                <div class="absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded font-bold border border-[#333] z-10">
                    ${vote ? vote.toFixed(1) : 'NR'}
                </div>
                <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                    <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg"></i>
                </div>
            </div>
            <div class="p-3 bg-card-bg">
                <h3 class="text-text-main text-sm font-semibold truncate md:hover:text-primary transition-colors">${title}</h3>
                <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                    <span>${year}</span>
                    <span class="uppercase border border-border-color px-1 rounded text-[10px]">${type}</span>
                </div>
            </div>
        `;
            card.onclick = () => openDetailsWrapper(id, type);
            return card;
        }

        function renderPagination(containerId, current, total, callback) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const max = Math.min(total, 500);
            if (max <= 1) return;

            const prev = document.createElement('button');
            prev.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.disabled = current === 1;
            prev.onclick = () => callback(current - 1);

            const next = document.createElement('button');
            next.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.disabled = current === max;
            next.onclick = () => callback(current + 1);

            const pageSpan = document.createElement('span');
            pageSpan.className = "px-3 py-1 text-primary font-bold";
            pageSpan.innerText = `${current} / ${max}`;

            container.append(prev, pageSpan, next);
        }

        // Updated openDetails to accept season/episode args for history resume
        async function openDetails(id, type, startSeason = 1, startEpisode = 1) {
            router('details');
            const container = document.getElementById('details-content');
            container.innerHTML = '';
            loader.show();

            const [details, credits, recommendations] = await Promise.all([
                fetchTMDB(`/${type}/${id}`),
                fetchTMDB(`/${type}/${id}/credits`),
                fetchTMDB(`/${type}/${id}/recommendations`)
            ]);

            if (!details) { container.innerHTML = 'Error loading'; return; }

            // Collection logic...
            let collectionHtml = '';
            if (type === 'movie' && details.belongs_to_collection) {
                const collectionData = await fetchTMDB(`/collection/${details.belongs_to_collection.id}`);
                if (collectionData && collectionData.parts && collectionData.parts.length > 0) {
                    const sortedParts = collectionData.parts.sort((a, b) => {
                        return new Date(a.release_date || '9999-12-31') - new Date(b.release_date || '9999-12-31');
                    });
                    collectionHtml = `
                        <div class="mt-6 border-t border-border-color pt-4">
                            <h4 class="font-bold text-text-main mb-3">Collection</h4>
                            <div class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-1 custom-scroll">`;
                    sortedParts.forEach(part => {
                        const partDate = part.release_date ? part.release_date.split('-')[0] : 'N/A';
                        const partImg = part.poster_path ? IMG_URL + part.poster_path : 'https://placehold.co/50x75?text=No+Img';
                        const isActive = part.id === id ? 'border-primary bg-nav-bg' : 'border-transparent';
                        collectionHtml += `
                            <div class="cursor-pointer hover:bg-nav-bg p-1.5 rounded flex gap-3 items-center transition-colors group border ${isActive} hover:border-border-color" onclick="openDetailsWrapper(${part.id}, 'movie')">
                                <div class="flex-shrink-0 w-10 h-14 overflow-hidden rounded shadow-sm relative">
                                    <img src="${partImg}" class="w-full h-full object-cover md:group-hover:scale-110 transition-transform duration-300">
                                </div>
                                <div class="flex flex-col min-w-0 flex-1">
                                    <span class="text-xs text-text-main font-medium truncate md:group-hover:text-primary transition-colors" title="${part.title}">${part.title}</span>
                                    <span class="text-[10px] text-text-muted truncate">${partDate}</span>
                                </div>
                            </div>`;
                    });
                    collectionHtml += `</div></div>`;
                }
            }

            const title = details.title || details.name;
            const backdrop = getBackdropUrl(details.backdrop_path);
            const poster = getPosterUrl(details.poster_path);
            const runtime = details.runtime || (details.episode_run_time ? details.episode_run_time[0] : '?') + 'm';

            const cast = credits && credits.cast ? credits.cast.slice(0, 15) : [];
            let castHtml = '<div class="flex overflow-x-auto gap-4 pb-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">';
            if (cast.length > 0) {
                castHtml += cast.map(c => {
                    const profile = c.profile_path ? `${IMG_URL}${c.profile_path}` : 'https://placehold.co/100x100/333/555?text=No+Img';
                    return `
                        <div class="flex-shrink-0 w-24 text-center">
                            <img src="${profile}" alt="${c.name}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 border-2 border-border-color">
                            <p class="text-xs font-semibold text-text-main truncate" title="${c.name}">${c.name}</p>
                            <p class="text-[10px] text-text-muted truncate" title="${c.character}">${c.character}</p>
                        </div>
                    `;
                }).join('');
            } else {
                castHtml += '<p class="text-text-muted text-sm">No cast information available.</p>';
            }
            castHtml += '</div>';

            const releaseDate = details.release_date || details.first_air_date || 'N/A';
            const rawDateString = details.release_date || details.first_air_date || null;
            let relDate = 'N/A';
            if (rawDateString) {
                const dateObject = new Date(rawDateString);
                relDate = dateObject.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
            const status = details.status || 'N/A';
            let genresHtml = '';
            if (details.genres) {
                genresHtml = details.genres.map(g => `<span class="px-2 py-0.5 bg-input-bg border border-border-color rounded text-[10px] text-text-muted">${g.name}</span>`).join('');
            }
            const tagline = details.tagline ? `"${details.tagline}"` : '';

            container.innerHTML = `
                <div class="w-full h-[300px] md:h-[400px] bg-cover bg-center relative" style="background-image: url('${backdrop}')">
                    <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
                </div>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                            <button onclick="router(appState.lastView || 'home')" class="mb-4 block md:hidden text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-arrow-left"></i> Back to Browse</button>
                            <img src="${poster}" class="w-[180px] md:w-full mx-auto md:mx-0 hidden md:block rounded-md shadow-2xl">
                            <div class="mb-6">
                                <h1 class="text-2xl md:text-4xl font-extrabold text-white mb-3 leading-tight">${title}</h1>
                                <p class="text-gray-400 italic text-sm mb-4">${tagline}</p>
                                <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-6">
                                    <span class="text-primary font-bold"><i class="fas fa-star mr-1"></i> ${details.vote_average.toFixed(1)}</span>
                                    <span class="px-2 py-0.5 border border-border-color rounded">${releaseDate.split('-')[0]}</span>
                                    <span class="uppercase">${type}</span>
                                    <span><button id="tmdb-watchlist-btn" onclick="toggleWatchlist(${id}, '${type}', '${title.replace(/'/g, "")}', '${details.poster_path}', 'tmdb-watchlist-btn')" class="w-full bg-primary pt-4 py-3.5 px-3.5 text-black rounded shadow-lg transition transform flex items-center justify-center gap-2"><i class="material-icons">bookmark_add</i></button></span>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                                    <p class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto">${details.overview}</p>
                                </div>
                            </div>
                            <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                                <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Type</span><p class="text-text-main text-xs font-medium text-right md:text-left uppercase">${type}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Status</span><p class="text-primary text-xs font-medium text-right md:text-left">${status}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Released</span><p class="text-text-main text-xs font-medium text-right md:text-left">${relDate}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Runtime</span><p class="text-text-main text-xs font-medium text-right md:text-left">${runtime}</p></div>
                                    <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Production</span><p class="text-text-main text-xs font-medium text-right md:text-left">${details.production_companies?.[0]?.name || 'N/A'}</p></div>
                                    <div class=" border-b border-border-color pb-2"><span class="text-text-muted text-xs">Genres</span><div class="flex flex-wrap gap-1 mt-1">${genresHtml}</div></div>
                                </div>
                                <div class="mb-0"><h3 class="text-lg font-bold text-text-main mb-3">Cast</h3><div class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">${castHtml}</div></div>
                                ${collectionHtml}
                            </div>
                        </div>
                        <div class="flex-1 pt-4 md:pt-16 min-w-0">
                            <button onclick="router(appState.lastView || 'home')" class="mb-4 hidden md:block text-gray-300 hover:text-white flex items-center gap-2 text-sm font-medium"><i class="fas fa-arrow-left"></i> Back to Browse</button>
                            <div class="mb-8 space-y-4">
                                <div class="rounded-lg overflow-hidden border border-border-color bg-black shadow-xl">
                                    <div class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                                        <span class="text-primary font-bold"><i class="fas fa-play-circle"></i> Player</span>
                                        <div class="flex gap-2" id="server-buttons"></div>
                                    </div>
                                    ${type === 'tv' ? `<div class="p-3 bg-nav-bg flex gap-4 border-b border-border-color"><select id="season-select" class="bg-input-bg text-text-main p-2 rounded text-sm w-full outline-none border border-border-color cursor-pointer"></select><select id="ep-select" class="bg-input-bg text-text-main p-2 rounded text-sm w-full outline-none border border-border-color cursor-pointer"></select></div>` : ''}
                                    <div class="aspect-video relative bg-black"><iframe id="tmdb-player" src="" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>
                                </div>
                            </div>
                            <div class="mb-8"><h3 class="text-lg font-bold text-text-main mb-3">You may also like</h3><div id="tmdb-recommendations" class="horizontal-scroll-container"></div></div>
                        </div>
                    </div>
                </div>
            `;

            updateWatchlistButtonState(id, 'tmdb-watchlist-btn');
            if (recommendations && recommendations.results) {
                renderTMDBGrid('tmdb-recommendations', recommendations.results, type, true);
            }

            let season = startSeason;
            let ep = startEpisode;

            const serverContainer = document.getElementById('server-buttons');
            const SOURCES = type === 'movie' ? MOVIE_SOURCES : TV_SOURCES;

            SOURCES.forEach((src, idx) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<i class="fas fa-server mr-1"></i> ${src.name}`;
                btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === 0 ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                btn.onclick = () => {
                    Array.from(serverContainer.children).forEach(b => {
                        b.className = 'px-3 py-1 rounded text-xs font-bold bg-input-bg text-text-muted hover:text-white transition-colors';
                    });
                    btn.className = 'px-3 py-1 rounded-sm text-xs font-bold bg-primary text-black transition-colors';
                    updatePlayerSource(src, id, type, season, ep, details.poster_path, title, details.backdrop_path);
                }
                serverContainer.appendChild(btn);
            });

            if (type === 'tv') {
                const sSelect = document.getElementById('season-select');
                const eSelect = document.getElementById('ep-select');

                details.seasons.forEach(s => {
                    if (s.season_number > 0) {
                        const opt = document.createElement('option');
                        opt.value = s.season_number;
                        opt.text = s.name;
                        sSelect.add(opt);
                    }
                });

                const updateEps = async () => {
                    loader.show();
                    season = sSelect.value;
                    const seasonData = await fetchTMDB(`/tv/${id}/season/${season}`);
                    eSelect.innerHTML = '';
                    if (seasonData && seasonData.episodes) {
                        const today = new Date();
                        const validEps = seasonData.episodes.filter(e => {
                            if (!e.air_date) return false;
                            return new Date(e.air_date) <= today;
                        });
                        if (validEps.length === 0) {
                            eSelect.innerHTML = '<option>No aired episodes</option>';
                        } else {
                            validEps.forEach(e => {
                                const opt = document.createElement('option');
                                opt.value = e.episode_number;
                                opt.text = `Episode ${e.episode_number}: ${e.name}`;
                                eSelect.add(opt);
                            });
                        }
                    } else {
                        eSelect.innerHTML = '<option>Error loading episodes</option>';
                    }
                    loader.hide();

                    // Set specific episode if provided, otherwise default to first
                    if (eSelect.options.length > 0) {
                        // If the requested episode exists in this season, select it
                        const optionExists = [...eSelect.options].some(o => o.value == startEpisode);
                        if (season == startSeason && optionExists) {
                            eSelect.value = startEpisode;
                            ep = startEpisode;
                        } else {
                            ep = eSelect.options[0].value;
                        }

                        updatePlayerSource(SOURCES[0], id, 'tv', season, ep, details.poster_path, title, details.backdrop_path);
                    }
                };

                sSelect.value = startSeason; // Select the resume season
                sSelect.onchange = updateEps;
                eSelect.onchange = () => {
                    ep = eSelect.value;
                    updatePlayerSource(SOURCES[0], id, 'tv', season, ep, details.poster_path, title, details.backdrop_path);
                };
                if (sSelect.options.length > 0) updateEps();
            } else {
                updatePlayerSource(SOURCES[0], id, 'movie', 1, 1, details.poster_path, title, details.backdrop_path);
            }
            loader.hide();
        }

        function updatePlayerSource(sourceObj, id, type, s = 1, e = 1, poster = null, title = "", backdrop = null) {
            const iframe = document.getElementById('tmdb-player');
            if (type === 'movie') {
                iframe.src = sourceObj.url(id);
                addToHistory(id, type, title, poster, backdrop); // Save History
            } else {
                iframe.src = sourceObj.url(id, s, e);
                addToHistory(id, type, title, poster, backdrop, s, e); // Save History with S/E
            }
        }

        function toggleWatchlist(id, type, title, poster, btnId) {
            const exists = appState.watchlist.find(i => i.id === id);
            if (exists) {
                appState.watchlist = appState.watchlist.filter(i => i.id !== id);
                showToast('Removed from Library');
            } else {
                appState.watchlist.push({ id, type, title, poster_path: poster });
                showToast('Added to Library');
            }
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            updateWatchlistButtonState(id, btnId);
        }

        function updateWatchlistButtonState(id, btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            const exists = appState.watchlist.find(i => i.id === id);
            if (exists) {
                btn.innerHTML = '<i class="material-icons">bookmark_added</i>';
                btn.className = btn.className.replace('bg-white', 'bg-primary').replace('bg-white', 'bg-primary');
                if (!btn.className.includes('bg-primary')) btn.classList.add('bg-primary', 'text-black');
            } else {
                btn.innerHTML = '<i class="material-icons">bookmark_add</i>';
                if (btnId.includes('banner')) {
                    btn.className = "bg-primary md:hover:bg-opacity-60 text-black font-bold pt-4 py-2 px-3 rounded-r-md transition-colors";
                } else {
                    btn.className = "pt-4 py-2 px-3 bg-primary text-black md:hover:bg-opacity-60 rounded font-bold transition-colors";
                }
            }
        }

        function renderWatchlist() {
            const grid = document.getElementById('grid-watchlist');
            grid.innerHTML = '';
            if (appState.watchlist.length === 0) { grid.innerHTML = '<p class="text-text-muted">Your Library is empty.</p>'; return; }
            appState.watchlist.forEach(item => {
                const posterUrl = getPosterUrl(item.poster_path);
                const card = document.createElement('div');
                card.className = 'movie-card cursor-pointer relative';
                card.innerHTML = `
                    <div class="aspect-[2/3] overflow-hidden"><img src="${posterUrl}" class="w-full h-full object-cover"></div>
                    <div class="p-2">
                        <h4 class="truncate text-center text-text-main">${item.title}</h4>
                        <button onclick="event.stopPropagation(); removeFromWatchlist(${item.id})" class="absolute top-1 right-1 z-20 flex items-center rounded-sm shadow-xl h-8 w-8 bg-primary text-black md:hover:bg-red-400 justify-center transition-all">   
                        <i class="material-icons">bookmark_remove</i></i>     
                        </button>
                    </div>
                `;
                card.onclick = () => openDetailsWrapper(item.id, item.type);
                grid.appendChild(card);
            });
        }

        function removeFromWatchlist(id) {
            appState.watchlist = appState.watchlist.filter(i => i.id !== id);
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            renderWatchlist();
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'bg-white text-black px-6 py-3 rounded-md shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center min-w-[200px] border-l-4 border-primary';
            toast.innerHTML = `
                <i class="fas fa-info-circle text-black mr-3 text-lg"></i>
                <span class="font-semibold text-sm">${msg}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        function onDeviceReady() {
            console.log("Cordova Device Ready");
            var originalOpen = window.open;
            window.open = function (url, target, options) {
                return cordova.InAppBrowser ? cordova.InAppBrowser.open(url, '_self', options) : originalOpen(url, '_self', options);
            };
        }
        document.addEventListener('deviceready', onDeviceReady, false);

        window.addEventListener('DOMContentLoaded', () => {
            router('home');
        });

        const copyrightSpan = document.getElementById('current-year-copyright');
        if (copyrightSpan) copyrightSpan.textContent = `${new Date().getFullYear()} GoStream`;
    </script>
</body>

</html>
