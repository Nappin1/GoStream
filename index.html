<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" type="image/png" href="images/G-icon.png">

    <!-- Relaxed CSP to prevent 'Failed to fetch' errors in preview environments -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src * 'unsafe-inline' 'unsafe-eval' data: gap:;
        style-src * 'unsafe-inline';
        script-src * 'unsafe-inline' 'unsafe-eval';
        img-src * data:;
        font-src * data:;
        connect-src *;
        frame-src *;
        media-src *;
    ">

    <title>Go Stream</title>

    <!-- Cordova script kept as requested, though it may 404 in this web preview -->
    <script src="cordova.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'nav-bp': '1025px' },
                    colors: {
                        'primary': 'var(--color-primary)',
                        'dark-bg': 'var(--bg-main)',
                        'card-bg': 'var(--bg-card)',
                        'nav-bg': 'var(--bg-nav)',
                        'border-color': 'var(--border-color)',
                        'text-main': 'var(--text-main)',
                        'text-muted': 'var(--text-muted)',
                        'input-bg': 'var(--bg-input)'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL VARIABLES & THEME --- */
        :root {
            --color-primary: #cae962;
            --bg-main: #202125;
            --bg-card: #2a2c31;
            --bg-nav: #1a1b1e;
            --bg-input: #111;
            --border-color: #333;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        button {
            outline: none;
            box-shadow: none;
            -webkit-tap-highlight-color: transparent;
        }

        button:focus {
            outline: none;
            box-shadow: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Selection */
        ::selection {
            background-color: var(--color-primary);
            color: #000;
        }

        /* Loader */
        #global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(128, 128, 128, 0.2);
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden-loader {
            display: none !important;
        }

        /* Nav Link Active State */
        .nav-link {
            cursor: pointer;
            transition: all 0.2s ease;
            /* Reserve space for active border */
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.05);
            border-left-color: var(--color-primary);
            color: white;
            font-weight: 700;
        }

        .nav-link.active i {
            color: var(--color-primary);
        }

        @media (min-width: 768px) {
            .nav-link:hover {
                color: white;
                background-color: rgba(255, 255, 255, 0.02);
            }
        }

        /* Movie Card & Utilities */
        .vline {
            border-radius: 10px;
            display: inline-block;
            width: 4px;
            background-color: var(--color-primary);
            margin-right: 10px;
            height: 2rem;
            vertical-align: middle;
        }

        .movie-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            overflow: hidden;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        /* Hover effects only for devices that support hover and larger screens */
        @media (hover: hover) and (min-width: 768px) {
            .movie-card:hover {
                transform: scale(1.03);
                box-shadow: 0 10px 20px var(--shadow-color);
                border-color: var(--color-primary);
            }

            .movie-card:hover img {
                opacity: 0.8;
            }

            /* General button hover opacity if not handled by tailwind classes */
            button:hover {
                opacity: 0.9;
            }
        }

        .movie-card img {
            transition: opacity 0.2s ease-in-out;
            width: 100%;
            height: 100%;
        }

        /* Global Pop-out Hover Card */
        #global-hover-card {
            position: fixed;
            z-index: 9999;
            width: 320px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.50rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }

        #global-hover-card.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #global-hover-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .card-info {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 20%, rgba(0, 0, 0, 0));
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            scroll-behavior: smooth;
        }

        /* Fade Mask for Horizontal Scroll */
        .mask-linear-fade {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        .horizontal-scroll-container .movie-card {
            flex-shrink: 0;
            width: 160px;
        }

        .horizontal-scroll-container .movie-card.landscape-card {
            width: 280px;
            min-width: 280px;
            max-width: 280px;
        }

        /* Filter Selects */
        .filter-select {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 9999px;
            /* Chip style */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            cursor: pointer;
            outline: none;
            width: auto;
            min-width: auto;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        /* Focus only for global (keyboard nav) but Remove Hover for mobile */
        .filter-select:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--color-primary);
            color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cae962'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }

        .filter-select option {
            background-color: var(--bg-card);
            color: white;
        }

        /* Scrollbar Hide Utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @media (min-width: 640px) {
            .filter-select {
                width: auto;
                min-width: 140px;
                max-width: 200px;
            }
        }

        @media (min-width: 768px) {

            /* Desktop Hover Effects */
            .filter-select:hover {
                border-color: var(--color-primary);
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cae962'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            }
        }

        /* Bottom Nav Specifics */
        .bottom-nav-item {
            color: #808080;
            transition: color 0.2s, transform 0.2s;
        }

        .bottom-nav-item.active {
            color: var(--color-primary);
        }

        .bottom-nav-item.active i {
            text-shadow: 0 0 10px rgba(202, 233, 98, 0.3);
        }



        /* Utilities */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .line-clamp-2 {
            line-clamp: 2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            line-clamp: 3;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            padding: 1.5rem;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }

        /* Carousel Styles */
        .banner-bg-wrapper {
            position: absolute;
            inset: 0;
            transition: opacity 0.8s ease-in-out;
            opacity: 0;
            background-size: cover;
            background-position: center;
        }

        .banner-bg-wrapper.active {
            opacity: 1;
        }

        .carousel-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .carousel-indicator.active {
            background-color: var(--color-primary);
            width: 24px;
            border-radius: 4px;
        }

        .carousel-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        @media (min-width: 768px) {
            .carousel-btn:hover {
                background-color: var(--color-primary);
                color: black;
            }
        }
    </style>
</head>

<body>
    <div id="global-loader" class="hidden-loader">
        <div class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-primary font-bold tracking-widest animate-pulse">LOADING</p>
        </div>
    </div>





    <!-- DESKTOP SIDEBAR -->
    <aside id="sidebar"
        class="fixed top-0 left-0 z-50 h-screen w-64 bg-black border-r border-border-color hidden lg:flex flex-col pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] transition-all duration-300">
        <div class="h-16 flex items-center justify-center px-6 border-b border-border-color flex-shrink-0 transition-all duration-300"
            id="sidebar-header">
            <a onclick="router('home')" class="cursor-pointer flex items-center gap-2 overflow-hidden">
                <i class="fas fa-play-circle text-2xl text-primary visible-collapsed hidden"></i>
                <h1 id="sidebar-logo-text"
                    class="text-2xl font-extrabold text-white tracking-tight whitespace-nowrap transition-opacity duration-300">
                    Go<span class="text-primary">Stream</span>
                </h1>
            </a>
        </div>




        <button onclick="toggleSidebar()"
            class="absolute top-1/2 -right-4 -translate-y-1/2 z-50 bg-input-bg rounded p-2 shadow-md hover:text-white hover:bg-gray-700 transition-transform duration-300 transform"
            id="sidebar-toggle-btn" title="Collapse Sidebar">
            <i class="fas fa-chevron-left text-lg"></i>
        </button>

        <div class="flex-1 overflow-y-auto pt-2 px-3 space-y-1 custom-scroll overflow-x-hidden">
            <a onclick="router('home')" data-target="home" title="Home"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-house w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Home</span>
            </a>
            <a onclick="router('search')" data-target="search" title="Search"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-search w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Search</span>
            </a>
            <div class="pt-1 mt-2 mb-2 mx-2 transition-all duration-300 uppercase text-text-muted text-xs"
                id="sidebar-divider">
                Media</div>
            <a onclick="router('movies')" data-target="movies" title="Movies"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-clapperboard w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Movies</span>
            </a>
            <a onclick="router('tv')" data-target="tv" title="TV Shows"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-tv w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">TV Shows</span>
            </a>
            <a onclick="router('anime-anilist')" data-target="anime-anilist" title="Anime"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-dragon w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Anime</span>
            </a>
            <a onclick="router('watchlist')" data-target="watchlist" title="Library"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-lines-leaning w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Library</span>
            </a>
            <a onclick="router('history')" data-target="history" title="History"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-history w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">History</span>
            </a>
        </div>

        <div class="p-4 border-t border-border-color flex-shrink-0 flex flex-col items-center">
            <a onclick="router('legal')" data-target="legal" title="Legal/DMCA"
                class="nav-link flex items-center px-3 py-3 text-sm font-bold rounded-lg text-text-muted hover:bg-white/5 hover:text-white transition-all group whitespace-nowrap">
                <i
                    class="fas fa-scale-balanced w-8 text-center text-lg group-hover:text-primary transition-colors flex-shrink-0 mr-2"></i>
                <span class="sidebar-label transition-opacity duration-300 uppercase">Legal/DMCA</span>
            </a>
        </div>
    </aside>

    <!-- MOBILE BOTTOM NAV -->
    <div id="bottom-nav"
        class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#0a0a0a]/90 backdrop-blur-2xl border-t border-white/5 z-50 flex justify-around items-center h-[70px] pb-[env(safe-area-inset-bottom)] transition-all duration-300">
        <button onclick="router('home')" data-target="home" title="Home"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 w-full h-full text-gray-400 hover:text-white transition-all group">
            <i class="fas fa-house group-[.active]:text-primary transition-colors"></i>
            <span
                class="text-[10px] font-bold tracking-wide opacity-70 group-[.active]:opacity-100 group-[.active]:text-primary">Home</span>
        </button>
        <button onclick="router('search')" data-target="search" title="Search"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 w-full h-full text-gray-400 hover:text-white transition-all group">
            <i class="fas fa-search group-[.active]:text-primary transition-colors"></i>
            <span
                class="text-[10px] font-bold tracking-wide opacity-70 group-[.active]:opacity-100 group-[.active]:text-primary">Search</span>
        </button>
        <button onclick="toggleMoreMenu()" id="more-btn" title="More"
            class="bottom-nav-item flex flex-col items-center justify-center gap-1.5 w-full h-full text-gray-400 hover:text-white transition-all group">
            <i class="fas fa-bars transition-colors"></i>
            <span class="text-[10px] font-bold tracking-wide opacity-70">More</span>
        </button>
    </div>

    <!-- MORE MENU OVERLAY (Mobile) -->
    <div id="more-menu-modal"
        class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden flex flex-col justify-end transition-opacity duration-300"
        onclick="toggleMoreMenu()">
        <div class="mb-24 mx-4 bg-[#1e1e1e] border border-border-color rounded-2xl overflow-hidden shadow-2xl transform transition-transform duration-300 translate-y-full"
            id="more-menu-content" onclick="event.stopPropagation()">
            <div class="p-4 grid grid-cols-4 gap-4">
                <button onclick="router('movies'); toggleMoreMenu()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-clapperboard text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">Movies</span>
                </button>
                <button onclick="router('tv'); toggleMoreMenu()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-tv text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">TV Shows</span>
                </button>
                <button onclick="router('anime-anilist'); toggleMoreMenu()"
                    class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-dragon text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">Anime</span>
                </button>

                <button onclick="router('watchlist'); toggleMoreMenu()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-lines-leaning text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">Library</span>
                </button>

                <button onclick="router('history'); toggleMoreMenu()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-history text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">History</span>
                </button>

                <button onclick="router('legal'); toggleMoreMenu()" class="flex flex-col items-center gap-2 group">
                    <div
                        class="w-12 h-12 rounded-full bg-white/5 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                        <i class="fas fa-scale-balanced text-white group-hover:text-primary text-xl"></i>
                    </div>
                    <span class="text-xs text-gray-300 group-hover:text-white">Legal</span>
                </button>
            </div>
            <!-- Quick Actions -->
            <div class="border-t border-white/5 p-2 bg-black/20 flex justify-between">
                <!-- Removed FAQ/Install buttons -->
            </div>
        </div>
    </div>



    <!-- Trailer Modal -->
    <div id="trailer-modal" class="modal-overlay z-[1100] flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-black rounded-lg overflow-hidden shadow-2xl flex flex-col">
            <!-- Modal Header with Close Button -->
            <div class="flex flex-col bg-[#1a1a1a] border-b border-gray-800">
                <div class="flex justify-between items-center p-3">
                    <span class="text-white font-semibold ml-2"><i
                            class="fab fa-youtube text-red-500 mr-2"></i>Trailer</span>
                    <button onclick="closeTrailerModal()" class="text-gray-400 hover:text-white transition-colors p-1">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <!-- Tabs Container -->
                <div id="trailer-tabs" class="flex overflow-x-auto px-2 space-x-2 hidden pb-2 scrollbar-thin"></div>
            </div>
            <!-- Video Container -->
            <div class="aspect-video w-full bg-black relative">
                <iframe id="trailer-iframe" class="absolute inset-0 w-full h-full" frameborder="0"
                    allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Main Content: Added Padding for Sidebar -->
    <main id="main-content" class="lg:pl-64 lg:pt-0 pb-24 min-h-screen flex flex-col transition-all duration-300">
        <section id="shared-banner"
            class="relative h-[50vh] md:h-[65vh] flex items-end p-0 bg-dark-bg transition-all duration-500 hidden overflow-hidden group">
            <!-- Banner Background Layers -->
            <div id="banner-bg-container" class="absolute inset-0">
                <!-- JS will inject .banner-bg-wrapper divs here -->
            </div>

            <!-- Gradients -->
            <div
                class="absolute inset-0 bg-gradient-to-t from-dark-bg via-transparent to-transparent z-10 pointer-events-none">
            </div>
            <div
                class="absolute inset-0 bg-gradient-to-r from-dark-bg via-dark-bg/60 to-transparent z-10 pointer-events-none">
            </div>

            <!-- Carousel Controls -->
            <div
                class="absolute inset-0 z-30 flex justify-between items-center px-4 md:px-8 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                <button onclick="prevBanner()" class="carousel-btn pointer-events-auto"><i
                        class="fas fa-chevron-left"></i></button>
                <button onclick="nextBanner()" class="carousel-btn pointer-events-auto"><i
                        class="fas fa-chevron-right"></i></button>
            </div>

            <!-- Banner Content -->
            <div class="z-20 w-full max-w-4xl relative p-4 md:p-12 mb-8 md:mb-0 fade-in">
                <div id="banner-content" class="transition-opacity duration-500"></div>
                <!-- Indicators -->
                <div id="banner-indicators" class="flex gap-2 mt-6"></div>
            </div>
        </section>



        <section id="view-home" class="view-section px-4 sm:px-6 lg:px-8 py-8 space-y-8 hidden">
            <div id="continue-watching-container" class="discovery-row hidden">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center">
                    <span class="vline"></span>Continue Watching
                    <button onclick="clearHistory()"
                        class="ml-auto text-xs text-text-muted hover:text-primary underline">Clear</button>
                </h2>
                <div id="row-continue-watching" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>

            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Trending Now</h2>
                <div id="row-trending" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Top Rated Movies</h2>
                <div id="row-top-rated" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
            <div class="discovery-row">
                <h2 class="text-xl md:text-2xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Popular Action Movies</h2>
                <div id="row-action" class="horizontal-scroll-container pb-4 p-2"></div>
            </div>
        </section>

        <section id="view-movies" class="view-section px-4 mt-8 mb-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Movies<sup class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="movies-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-movies" class="results-grid"></div>
            <div id="pag-movies" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-tv" class="view-section px-4 mt-8 mb-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>TV<sup class="text-xs text-primary ml-2">TMDB</sup></h2>
                <div id="tv-filters" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="grid-tv" class="results-grid"></div>
            <div id="pag-tv" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-anime-anilist" class="view-section hidden w-full px-4 mt-8 mb-4 sm:px-6 lg:px-8">
            <!-- TABS -->
            <div class="flex items-center space-x-6 mb-6 border-b border-white/10 pb-1">
                <button onclick="switchAnilistTab('anime')" id="tab-btn-anime"
                    class="text-lg font-bold text-primary border-b-2 border-primary pb-2 transition-colors">Anime</button>
                <button onclick="switchAnilistTab('va')" id="tab-btn-va"
                    class="text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors">Voice
                    Actors</button>
            </div>

            <!-- TAB CONTENT: ANIME (Existing) -->
            <!-- TAB CONTENT: ANIME (Modified for 3-Col Layout) -->
            <div id="anilist-tab-anime" class="flex flex-col lg:flex-row gap-6">
                <!-- LEFT SIDEBAR: Top 10 Airing -->
                <div class="w-full lg:w-64 flex-shrink-0 order-2 lg:order-1">
                    <h3 class="text-lg font-bold text-primary mb-4 border-l-4 border-primary pl-3">Top 10 Airing</h3>
                    <div id="anilist-top-airing" class="space-y-4">
                        <!-- Items rendered here -->
                        <div class="animate-pulse space-y-4">
                            <div class="h-16 bg-white/5 rounded"></div>
                            <div class="h-16 bg-white/5 rounded"></div>
                            <div class="h-16 bg-white/5 rounded"></div>
                        </div>
                    </div>
                </div>

                <!-- CENTER: Main Content -->
                <div class="flex-grow min-w-0 order-1 lg:order-2">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-xl md:text-3xl font-bold text-text-main flex items-center"><span
                                class="vline"></span>Anime<sup class="text-xs text-primary ml-2">ANILIST</sup></h2>
                        <div id="anilist-filters" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="grid-anilist" class="results-grid"></div>
                    <div id="pag-anilist" class="pagination-controls mt-8 flex justify-center gap-2">
                        <button onclick="changeAnilistPage(-1)"
                            class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                                class="fas fa-chevron-left"></i></button>
                        <span id="anilist-page-num" class="px-3 py-1 text-primary font-bold">1</span>
                        <button onclick="changeAnilistPage(1)"
                            class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- RIGHT SIDEBAR: Top 10 Popular -->
                <div class="w-full lg:w-64 flex-shrink-0 order-3 lg:order-3">
                    <h3 class="text-lg font-bold text-primary mb-4 border-l-4 border-primary pl-3">Top 10 Most Popular
                    </h3>
                    <div id="anilist-top-popular" class="space-y-4">
                        <!-- Items rendered here -->
                        <div class="animate-pulse space-y-4">
                            <div class="h-16 bg-white/5 rounded"></div>
                            <div class="h-16 bg-white/5 rounded"></div>
                            <div class="h-16 bg-white/5 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: VOICE ACTORS (New) -->
            <div id="anilist-tab-va" class="hidden w-full">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl md:text-3xl font-bold text-text-main flex items-center"><span
                            class="vline"></span>Voice Actors<sup class="text-xs text-primary ml-2">ANILIST</sup></h2>
                    <div class="relative w-full md:w-64">
                        <input id="va-search-input" type="text" placeholder="Search Voice Actors..."
                            class="bg-input-bg border border-border-color text-text-main text-sm rounded-md py-2 pl-8 pr-3 w-full focus:outline-none focus:border-primary transition-colors">
                        <i class="fas fa-search text-text-muted absolute left-3 top-1/2 -translate-y-1/2 text-xs"></i>
                    </div>
                </div>
                <div id="grid-anilist-va" class="results-grid"></div>
                <div id="pag-anilist-va" class="pagination-controls mt-8 flex justify-center gap-2">
                    <button onclick="changeAnilistVAPage(-1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-left"></i></button>
                    <span id="anilist-va-page-num" class="px-3 py-1 text-primary font-bold">1</span>
                    <button onclick="changeAnilistVAPage(1)"
                        class="px-3 py-1 bg-card-bg border border-border-color text-text-main rounded md:hover:bg-primary md:hover:text-black font-bold"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <section id="view-watchlist" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main mb-4 flex items-center"><span
                        class="vline"></span>Library<sup class="text-xs text-primary ml-2">TMDB | ANILIST</sup></h2>
            </div>
            <div id="grid-watchlist" class="results-grid"></div>
        </section>

        <section id="view-history" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl md:text-3xl font-bold text-text-main flex items-center"><span
                        class="vline"></span>History</h2>
            </div>

            <!-- TABS -->
            <div class="flex items-center space-x-6 mb-8 border-b border-white/10 pb-1 overflow-x-auto scrollbar-hide">
                <button onclick="switchHistoryTab('all')" id="hist-tab-all"
                    class="text-sm md:text-lg font-bold text-primary border-b-2 border-primary pb-2 transition-colors whitespace-nowrap">All
                    Content</button>
                <button onclick="switchHistoryTab('movie')" id="hist-tab-movie"
                    class="text-sm md:text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors whitespace-nowrap">Movies</button>
                <button onclick="switchHistoryTab('tv')" id="hist-tab-tv"
                    class="text-sm md:text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors whitespace-nowrap">TV
                    Shows</button>
                <button onclick="switchHistoryTab('anime')" id="hist-tab-anime"
                    class="text-sm md:text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors whitespace-nowrap">Anime</button>
            </div>

            <div id="history-content" class="space-y-8 animate-fade-in"></div>
        </section>

        <section id="view-search" class="view-section px-4 sm:px-6 lg:px-8 py-8 hidden">
            <!-- Mobile Search Input (visible on lg:hidden, or always if we want) -->

            <div class="relative w-full mb-6">
                <input id="mobile-search-input" type="text" placeholder="Search movies, tv, people..."
                    class="w-full bg-input-bg border border-border-color text-white text-sm rounded-lg py-3 pl-10 pr-3 focus:outline-none focus:border-primary transition-all shadow-sm">
                <i class="fas fa-search absolute left-3 top-3.5 text-text-muted text-sm"></i>
            </div>
            <h2 id="search-header" class="text-2xl font-bold text-text-main mb-6">Search Results</h2>
            <div id="grid-search" class="results-grid"></div>
            <div id="pag-search" class="pagination-controls mt-8 flex justify-center gap-2"></div>
        </section>

        <section id="view-tmdb-details" class="view-section hidden w-full">
            <div id="tmdb-details-content" class="animate-fade-in">
                <!-- Content injected by JS -->
            </div>
        </section>

        <section id="view-tmdb-player" class="view-section hidden w-full">
            <div id="tmdb-player-content" class="animate-fade-in">
                <!-- Content injected by JS -->
            </div>
        </section>

        <section id="view-actor" class="view-section hidden w-full">
            <div id="actor-content" class="animate-fade-in"></div>
        </section>

        <section id="view-anilist-details" class="view-section hidden w-full bg-dark-bg">
            <div id="anilist-details-banner" class="w-full h-[300px] md:h-[400px] bg-cover bg-top bg-center relative">
                <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
            </div>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                        <img id="anilist-details-img" src=""
                            class="w-[180px] hidden md:block md:w-full mx-auto md:mx-0 rounded shadow-2xl">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white block md:hidden flex items-center gap-2 text-lg font-medium"><i
                                class="fas fa-angles-left text-lg mr-2"></i> Back
                        </button>

                        <!-- WATCH NOW BUTTON SECTION -->
                        <div class="mb-8 flex items-center gap-4">
                            <button id="anilist-details-watchlist-btn"
                                class="bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center gap-2">
                                <i class="material-icons">bookmark_add</i> Watchlist
                            </button>
                        </div>
                        <button id="anilist-watch-now-btn"
                            class="w-full bg-white text-black font-bold py-3 px-8 rounded hover:bg-primary transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(255,255,255,0.3)] flex items-center justify-center flex-grow">
                            <i class="fas fa-play text-lg group-hover:scale-110 transition-transform"></i> PLAY NOW
                        </button>
                    </div>
                    <div class="flex-1 pt-4 md:pt-16 min-w-0">
                        <button onclick="router('anime-anilist')"
                            class="mb-4 text-gray-300 hover:text-white hidden md:block flex items-center gap-2 text-lg font-medium"><i
                                class="fas fa-angles-left text-lg mr-2"></i> Back
                        </button>
                        <div>
                            <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-3">
                                <span id="anilist-details-score" class="text-primary font-bold"></span>
                                <span id="anilist-details-year"
                                    class="px-2 py-0.5 border border-border-color rounded"></span>
                                <span id="anilist-details-type" class="uppercase"></span>
                            </div>
                        </div>
                        <h1 id="anilist-details-title"
                            class="text-2xl md:text-4xl font-extrabold text-white mb-2 leading-tight"></h1>
                        <div>
                            <p id="anilist-info-Romaji" class="text-text-main text-xs mb-5 font-medium italic"></p>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                            <div id="anilist-info-desc"
                                class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto pr-2">
                            </div>
                        </div>
                        <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                            <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                                <div class="flex justify-between md:hidden"><span
                                        class="text-text-muted text-xs">Format</span>
                                    <p id="anilist-info-Type"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Status</span>
                                    <p id="anilist-info-Status"
                                        class="text-primary text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Episodes</span>
                                    <p id="anilist-info-Episodes"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Season</span>
                                    <p id="anilist-info-Season"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Start
                                        Date</span>
                                    <p id="anilist-info-Date"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Studios</span>
                                    <p id="anilist-info-Studio"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Producers</span>
                                    <p id="anilist-info-Producers"
                                        class="text-text-main text-xs font-medium text-right md:text-left line-clamp-2">
                                    </p>
                                </div>
                                <div class="flex justify-between md:block"><span
                                        class="text-text-muted text-xs">Genres</span>
                                    <p id="anilist-info-Genres"
                                        class="text-text-main text-xs font-medium text-right md:text-left"></p>
                                </div>
                            </div>
                            <div class="mb-8 border-t border-border-color pt-2">
                                <h3 class="text-lg font-bold text-text-main mb-3">Cast & Voice Actors</h3>
                                <div id="anilist-cast-grid" class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <section id="view-anilist-player" class="view-section hidden w-full bg-dark-bg">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-12">
                <button id="anilist-player-back-btn"
                    class="flex items-center gap-3 text-gray-300 mb-4 hover:text-white transition-colors duration-200">

                    <i class="fas fa-angles-left text-lg"></i>

                    <span id="anilist-player-title" class="text-xl md:text-2xl font-extrabold text-white leading-none">
                        /* Title Text Appears Here */
                    </span>

                </button>

                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Player Container -->
                    <div
                        class="w-full lg:w-3/4 rounded overflow-hidden border border-border-color bg-black shadow-xl mb-8 lg:mb-0">
                        <div
                            class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                            <div class="flex items-center gap-2 text-primary font-bold"><i
                                    class="fas fa-play-circle"></i>
                                <span id="anilist-player-ep">Episode 1</span>
                            </div>
                            <div id="anime-server-buttons" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="aspect-video relative bg-black"><iframe id="anilist-iframe" class="w-full h-full"
                                src="" frameborder="0" allowfullscreen></iframe></div>
                        <div
                            class="bg-card-bg px-4 py-3 flex justify-between items-center border-t border-border-color">
                            <button onclick="changeAnilistEp(-1)"
                                class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">
                                <i class="fas fa-backward mr-1"></i> Prev</button>
                            <button onclick="changeAnilistEp(1)"
                                class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">Next
                                <i class="fas fa-forward ml-1"></i></button>
                        </div>
                    </div>

                    <!-- Episodes List Container -->
                    <div
                        class="w-full lg:w-1/4 bg-card-bg border border-border-color rounded overflow-hidden relative min-h-0">
                        <div class="w-full h-full flex flex-col lg:absolute lg:inset-0">
                            <div class="p-3 border-b border-border-color bg-input-bg flex-shrink-0">
                                <h3 class="text-base font-bold text-text-main">Episodes</h3>
                            </div>
                            <div id="anilist-episodes-grid"
                                class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-3 gap-2 p-3 overflow-y-auto custom-scroll flex-1 content-start max-h-96 lg:max-h-full">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="anilist-info-Relations-Container" class="text-sm pt-4 space-y-3 hidden">
                    <h4 class="text-lg font-bold text-text-main mb-3">Relations</h4>
                    <div id="anilist-info-Relations" class="horizontal-scroll-container p-2">
                    </div>
                </div>
                <div class="mt-3 text-sm space-y-3">
                    <h3 class="text-lg font-bold text-text-main mb-3">You may also like</h3>
                    <div id="anilist-recommendations-grid" class="horizontal-scroll-container p-2"></div>
                </div>
            </div>
        </section>

        <section id="view-legal" class="view-section px-4 mt-8 mb-4 w-full sm:px-6 lg:px-8 hidden">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-extrabold text-white mb-2 flex items-center"><span class="vline"></span>Legal
                    Stuff</h2>
                <p class="text-text-muted mb-8 text-lg">Third-Party Hosting & Copyright Disclaimer</p>

                <div class="grid gap-6">
                    <div
                        class="bg-card-bg p-6 rounded-xl border border-border-color shadow-lg hover:border-primary transition-colors duration-300">
                        <div class="flex items-start gap-4">
                            <div class="bg-primary/10 p-3 rounded-full shrink-0">
                                <i class="fas fa-database text-primary text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">No Content Hosting</h3>
                                <p class="text-gray-400 leading-relaxed text-sm">
                                    <span class="font-bold text-primary">GoStream</span> acts strictly as a search index
                                    and information retrieval tool.
                                    The Website does not host, upload, manage, or store any video, audio, or media files
                                    on its own servers.
                                    All media content accessible through this Website is embedded from external,
                                    third-party services.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-card-bg p-6 rounded-xl border border-border-color shadow-lg hover:border-primary transition-colors duration-300">
                        <div class="flex items-start gap-4">
                            <div class="bg-primary/10 p-3 rounded-full shrink-0">
                                <i class="fas fa-network-wired text-primary text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">Third-Party Control</h3>
                                <p class="text-gray-400 leading-relaxed text-sm mb-3">
                                    Since the Website does not control the underlying media files, we cannot guarantee
                                    the availability, accuracy, or permanence of any content. Issues such as:
                                </p>
                                <ul class="list-disc list-inside text-gray-400 text-sm space-y-1 ml-1">
                                    <li>Broken or dead links (404 errors).</li>
                                    <li>Incorrect video titles or metadata.</li>
                                    <li>Content removal due to DMCA takedowns or inactivity.</li>
                                </ul>
                                <p class="text-gray-400 leading-relaxed text-sm mt-3">
                                    ...are entirely outside the control of <span
                                        class="font-bold text-primary">GoStream</span>. These technical issues originate
                                    from the third-party file hosts (e.g., vidsrc).
                                </p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-card-bg p-6 rounded-xl border border-border-color shadow-lg hover:border-primary transition-colors duration-300">
                        <div class="flex items-start gap-4">
                            <div class="bg-primary/10 p-3 rounded-full shrink-0">
                                <i class="fas fa-copyright text-primary text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">Copyright & Removal Requests</h3>
                                <p class="text-gray-400 leading-relaxed text-sm">
                                    If you have legal concerns regarding copyright, please contact the original file
                                    host where the media is stored.
                                    <span class="font-bold text-primary">GoStream</span> does not possess the files and
                                    therefore cannot remove them from the internet.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 text-center border-t border-border-color pt-8">
                    <p class="text-text-muted text-sm">
                        &copy; 2024 GoStream. All rights reserved. <br>
                    </p>
                </div>
            </div>
        </section>

    </main>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>
    <div id="global-hover-card"></div>

    <script>
        /**
         * GLOBAL CONFIGURATION & DATA
         */
        // UPDATED API KEY - The previous one was likely revoked or invalid
        const API_KEY = '3fd2be6f0c70a2a598f084ddfb75487c';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_URL = 'https://image.tmdb.org/t/p/original';
        const ANILIST_API_URL = 'https://graphql.anilist.co';

        const MOVIE_SOURCES = [
            { name: '1', url: (id) => `https://vidsrc.cc/v2/embed/movie/${id}?autoPlay=true` },
            { name: '2', url: (id) => `https://vidsrc.icu/embed/movie/${id}` },
            { name: '3', url: (id) => `https://vidlink.pro/movie/${id}` },
            { name: '4', url: (id) => `https://111movies.com/movie/${id}` },
            { name: '5', url: (id) => `https://vidrock.net/movie/${id}?autoplay=true&download=false` },
            { name: '6', url: (id) => `https://player.videasy.net/movie/${id}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const TV_SOURCES = [
            { name: '1', url: (id, s, e) => `https://vidsrc.cc/v2/embed/tv/${id}/${s}/${e}?autoPlay=true` },
            { name: '2', url: (id, s, e) => `https://vidsrc.icu/embed/tv/${id}/${s}/${e}` },
            { name: '3', url: (id, s, e) => `https://vidlink.pro/tv/${id}/${s}/${e}?title=true&poster=true&autoplay=true&nextbutton=true` },
            { name: '4', url: (id, s, e) => `https://111movies.com/tv/${id}/${s}/${e}` },
            { name: '5', url: (id, s, e) => `https://vidrock.net/tv/${id}/${s}/${e}?autoplay=true&download=false&episodeselector=false&enlang` },
            { name: '6', url: (id, s, e) => `https://player.videasy.net/tv/${id}/${s}/${e}?color=B20710&colour=B20710&autoPlay=true&primarycolor=B20710&autoNext=true&nextButton=true&poster=true&autoplayNextEpisode=true&nextEpisode=true&adFree=true` }
        ];

        const ANIME_SOURCES = [
            { name: '1', url: (id, ep) => `https://vidsrc.cc/v2/embed/anime/ani${id}/${ep}/sub` },
            { name: '2', url: (id, ep) => `https://vidsrc.icu/embed/anime/${id}/${ep}/0` },
            { name: '3', url: (id, ep) => `https://vidnest.fun/animepahe/${id}/${ep}/SUB` },
            { name: '4', url: (id, ep) => `https://vidnest.fun/anime/${id}/${ep}/sub` }
        ];

        // Constants for Filters
        const COUNTRIES = [
            { code: '', name: 'All Countries' }, { code: 'CN', name: 'China' }, { code: 'FR', name: 'France' },
            { code: 'HK', name: 'Hongkong' }, { code: 'IN', name: 'India' }, { code: 'JP', name: 'Japan' },
            { code: 'RU', name: 'Russia' }, { code: 'KR', name: 'South Korea' }, { code: 'ES', name: 'Spain' },
            { code: 'TH', name: 'Thailand' }, { code: 'TR', name: 'Turkey' }, { code: 'GB', name: 'United Kingdom' },
            { code: 'US', name: 'United States' }
        ];

        const TMDB_GENRES = [
            { id: '', name: 'All Genres' }, { id: 28, name: 'Action' }, { id: 12, name: 'Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 14, name: 'Fantasy' }, { id: 36, name: 'History' }, { id: 27, name: 'Horror' },
            { id: 10402, name: 'Music' }, { id: 9648, name: 'Mystery' }, { id: 10749, name: 'Romance' }, { id: 878, name: 'Sci-Fi' },
            { id: 53, name: 'Thriller' }
        ];

        const MOVIE_GENRES = TMDB_GENRES;
        const TV_GENRES = [
            { id: '', name: 'All Genres' }, { id: 10759, name: 'Action & Adventure' }, { id: 16, name: 'Animation' },
            { id: 35, name: 'Comedy' }, { id: 80, name: 'Crime' }, { id: 99, name: 'Documentary' }, { id: 18, name: 'Drama' },
            { id: 10751, name: 'Family' }, { id: 10762, name: 'Kids' }, { id: 9648, name: 'Mystery' }, { id: 10763, name: 'News' },
            { id: 10764, name: 'Reality' }, { id: 10765, name: 'Sci-Fi & Fantasy' }, { id: 10766, name: 'Soap' }, { id: 10767, name: 'Talk' },
            { id: 10768, name: 'War & Politics' }, { id: 37, name: 'Western' }
        ];

        const TV_STATUS = [
            { value: '', name: 'All Status' }, { value: '0', name: 'Returning Series' }, { value: '3', name: 'Ended' },
            { value: '4', name: 'Canceled' }, { value: '2', name: 'In Production' }, { value: '5', name: 'Pilot' }
        ];

        const MOVIE_STATUS = [
            { value: '', name: 'All Status' }, { value: 'released', name: 'Released' }, { value: 'upcoming', name: 'Upcoming' }
        ];

        const ANILIST_GENRES = [
            'Action', 'Adventure', 'Comedy', 'Drama', 'Ecchi', 'Fantasy', 'Horror', 'Mecha', 'Music', 'Mystery',
            'Psychological', 'Romance', 'Sci-Fi', 'Slice of Life', 'Sports', 'Supernatural', 'Thriller'
        ];



        // Global State
        const appState = {
            currentView: 'home',
            lastView: 'home',
            historyTab: 'all',
            watchlist: (function () { try { return JSON.parse(localStorage.getItem('goStreamWatchlist')) || []; } catch (e) { return []; } })(),
            continueWatching: (function () { try { return JSON.parse(localStorage.getItem('goStreamContinueWatching')) || []; } catch (e) { return []; } })(),
            bannerInterval: null,
            bannerItems: [],
            bannerIndex: 0,
            tmdb: {
                movies: { page: 1, filters: { sort: 'trending', genre: '', country: '', status: '', year: '' }, data: [] },
                tv: { page: 1, filters: { sort: 'trending', genre: '', country: '', status: '', year: '' }, data: [] }
            },
            anilist: {
                currentTab: 'anime', // anime or va
                page: 1,
                filters: { sort: 'TRENDING_DESC', genre: '', country: '', upcoming: '', year: '' },
                data: [],
                hero: [],
                currentAnime: null,
                currentEp: 1,
                currentServerIdx: 0,
                // Voice Actor State
                vaPage: 1,
                vaSearch: '',
                vaData: []
            },
            search: {
                query: '',
                page: 1,
                totalPages: 1
            }
        };

        /**
         * CORE UTILITIES
         */
        const loader = {
            count: 0,
            show: () => {
                loader.count++;
                document.getElementById('global-loader').classList.remove('hidden-loader');
            },
            hide: () => {
                loader.count--;
                if (loader.count <= 0) {
                    loader.count = 0;
                    document.getElementById('global-loader').classList.add('hidden-loader');
                }
            }
        };

        const getPosterUrl = (path) => {
            if (!path) return 'https://placehold.co/500x750/333/FFF?text=No+Image';
            return path.startsWith('http') ? path : IMG_URL + path;
        };

        const getBackdropUrl = (path) => {
            if (!path) return 'https://placehold.co/1920x1080/202125/FFF?text=No+Banner+available';
            return path.startsWith('http') ? path : BACKDROP_URL + path;
        };

        function stopBannerRotation() {
            if (appState.bannerInterval) {
                clearInterval(appState.bannerInterval);
                appState.bannerInterval = null;
            }
        }

        function router(viewName) {
            const tmdbFrame = document.getElementById('tmdb-player');
            const aniFrame = document.getElementById('anilist-iframe');
            if (tmdbFrame) tmdbFrame.src = "";
            if (aniFrame) aniFrame.src = "";

            stopBannerRotation();

            // List of top-level navigation pages
            const mainViews = ['home', 'movies', 'tv', 'anime-anilist', 'watchlist', 'history', 'search', 'legal'];

            // 1. Update History Strategy
            // If we are currently on a main view, and we are navigating AWAY to a sub-view (details/search/player)
            // OR simply navigating to another main view, save it as lastView.
            if (mainViews.includes(appState.currentView)) {
                appState.lastView = appState.currentView;
            }

            // 2. Determine Active Tab Highlighting
            // Default target is the view we are going to
            let activeTarget = viewName;

            // If the destination is NOT a main view (e.g. details, search, player, actor),
            // fallback to highlighting the last visited main view.
            if (!mainViews.includes(viewName)) {
                activeTarget = appState.lastView || 'home';
            }

            // Apply classes
            document.querySelectorAll('.nav-link').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.bottom-nav-item').forEach(l => {
                if (l.dataset.target === activeTarget) l.classList.add('active');
                else l.classList.remove('active');
            });

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('shared-banner').classList.add('hidden');

            appState.currentView = viewName;
            window.scrollTo(0, 0);

            switch (viewName) {
                case 'home':
                    document.getElementById('view-home').classList.remove('hidden');
                    document.getElementById('shared-banner').classList.remove('hidden');
                    loadHomeData();
                    break;
                case 'movies':
                    document.getElementById('view-movies').classList.remove('hidden');
                    appState.tmdb.movies.page = 1; // Reset pagination
                    renderFilters('movies');
                    loadTMDBSection('movies', '/discover/movie');
                    break;
                case 'tv':
                    document.getElementById('view-tv').classList.remove('hidden');
                    appState.tmdb.tv.page = 1; // Reset pagination
                    renderFilters('tv');
                    loadTMDBSection('tv', '/discover/tv');
                    break;
                case 'anime-anilist':
                    document.getElementById('view-anime-anilist').classList.remove('hidden');
                    renderFilters('anilist');
                    switchAnilistTab(appState.anilist.currentTab); // Load current active tab
                    break;
                case 'watchlist':
                    document.getElementById('view-watchlist').classList.remove('hidden');
                    renderWatchlist();
                    break;
                case 'history':
                    document.getElementById('view-history').classList.remove('hidden');
                    renderHistory();
                    break;
                case 'search':
                    document.getElementById('view-search').classList.remove('hidden');
                    break;
                case 'legal':
                    document.getElementById('view-legal').classList.remove('hidden');
                    break;
                case 'details':
                    document.getElementById('view-details').classList.remove('hidden');
                    break;
                case 'anilist-player':
                    document.getElementById('view-anilist-player').classList.remove('hidden');
                    break;
                case 'anilist-details':
                    document.getElementById('view-anilist-details').classList.remove('hidden');
                    break;
                case 'tmdb-details':
                    document.getElementById('view-tmdb-details').classList.remove('hidden');
                    break;
                case 'tmdb-player':
                    document.getElementById('view-tmdb-player').classList.remove('hidden');
                    break;
                case 'actor':
                    document.getElementById('view-actor').classList.remove('hidden');
                    break;

            }
        }

        /**
         * FEATURE: Continue Watching
         */
        function addToHistory(id, type, title, poster, backdrop, season = null, episode = null, overview = '', vote = 0, year = '') {
            // Remove if exists
            appState.continueWatching = appState.continueWatching.filter(i => i.id !== id);
            // Add to top
            appState.continueWatching.unshift({
                id, type, title, poster, backdrop, season, episode, overview, vote, year, timestamp: new Date().getTime()
            });
            // Limit to 100
            if (appState.continueWatching.length > 100) appState.continueWatching.pop();

            localStorage.setItem('goStreamContinueWatching', JSON.stringify(appState.continueWatching));
        }

        function clearHistory() {
            appState.continueWatching = [];
            localStorage.removeItem('goStreamContinueWatching');
            renderContinueWatching();
        }

        function renderContinueWatching() {
            const container = document.getElementById('row-continue-watching');
            const wrapper = document.getElementById('continue-watching-container');

            container.innerHTML = '';

            if (appState.continueWatching.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }

            wrapper.classList.remove('hidden');

            appState.continueWatching.slice(0, 20).forEach(item => {
                // Use backdrop if available, otherwise poster
                let imgUrl;
                if (item.backdrop) {
                    imgUrl = getBackdropUrl(item.backdrop);
                } else {
                    imgUrl = getPosterUrl(item.poster);
                }

                const card = document.createElement('div');
                card.className = 'movie-card cursor-pointer rounded relative group';

                let badge = '';
                if (item.type === 'tv' && item.season) {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">S${item.season} E${item.episode}</div>`;
                } else if (item.type === 'anime') {
                    badge = `<div class="absolute top-2 right-2 bg-primary text-black text-[10px] font-bold px-2 py-1 rounded shadow-md z-10">EP ${item.episode}</div>`;
                }

                // Use aspect-video (landscape) to match other home rows
                card.innerHTML = `
                    <div class="aspect-video overflow-hidden relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        ${badge}
                        <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                            <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-3 card-info">
                        <h3 class="text-text-main text-sm font-semibold truncate">${item.title}</h3>
                        <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                            <span class="uppercase text-[10px]">Resume</span>
                            <span class="uppercase border border-border-color px-1 rounded text-[10px]">${item.type}</span>
                        </div>
                    </div>
                `;

                card.onclick = () => {
                    if (item.type === 'movie') openTMDBPlayer(item.id, 'movie');
                    else openDetailsWrapper(item.id, item.type, item.season, item.episode);
                };
                container.appendChild(card);
            });
        }


        /**
         * FILTER LOGIC
         */
        function renderFilters(section) {
            const containerId = section === 'anilist' ? 'anilist-filters' : `${section}-filters`;
            const container = document.getElementById(containerId);
            if (!container || container.innerHTML !== '') return;

            // Apply responsive layout classes: Horizontal scroll on mobile, Flex on desktop
            container.className = 'flex overflow-x-auto pb-2 gap-3 w-full sm:w-auto items-center scrollbar-hide mask-linear-fade';

            const isAnilist = section === 'anilist';
            const stateRef = isAnilist ? appState.anilist.filters : appState.tmdb[section].filters;

            const sortSelect = document.createElement('select');
            sortSelect.className = 'filter-select';
            if (isAnilist) {
                sortSelect.innerHTML = `
                <option value="TRENDING_DESC">Trending</option>
                <option value="POPULARITY_DESC">Popular</option>
                <option value="SCORE_DESC">Top Rated</option>
                <option value="RECENTLY_UPDATED">Recently Updated</option>`;
            } else {
                // TMDB Sort Options
                sortSelect.innerHTML = `
                <option value="trending">Trending</option>
                <option value="popularity.desc">Popular</option>
                <option value="vote_average.desc">Top Rated</option>
                <option value="${section === 'movies' ? 'primary_release_date.desc' : 'first_air_date.desc'}">New Releases</option>`;
            }
            sortSelect.value = stateRef.sort;
            sortSelect.onchange = (e) => {
                stateRef.sort = e.target.value;
                resetAndLoad(section);
            };

            const genreSelect = document.createElement('select');
            genreSelect.className = 'filter-select';
            if (isAnilist) {
                genreSelect.innerHTML = `<option value="">All Genres</option>` + ANILIST_GENRES.map(g => `<option value="${g}">${g}</option>`).join('');
            } else if (section === 'movies') {
                genreSelect.innerHTML = MOVIE_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            } else {
                genreSelect.innerHTML = TV_GENRES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            }

            genreSelect.value = stateRef.genre;
            genreSelect.onchange = (e) => {
                stateRef.genre = e.target.value;
                resetAndLoad(section);
            };

            const statusSelect = document.createElement('select');
            statusSelect.className = 'filter-select';
            if (section === 'movies') {
                statusSelect.innerHTML = MOVIE_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else if (!isAnilist) {
                statusSelect.innerHTML = TV_STATUS.map(s => `<option value="${s.value}">${s.name}</option>`).join('');
            } else {
                statusSelect.classList.add('hidden');
            }
            if (!isAnilist) {
                statusSelect.value = stateRef.status;
                statusSelect.onchange = (e) => {
                    stateRef.status = e.target.value;
                    resetAndLoad(section);
                };
            }

            const countrySelect = document.createElement('select');
            countrySelect.className = 'filter-select';
            countrySelect.innerHTML = COUNTRIES.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            countrySelect.value = stateRef.country;
            countrySelect.onchange = (e) => {
                stateRef.country = e.target.value;
                resetAndLoad(section);
            };

            container.append(sortSelect, genreSelect);
            if (!isAnilist) container.append(statusSelect, countrySelect);

            if (isAnilist) {
                const upcomingSelect = document.createElement('select');
                upcomingSelect.className = 'filter-select';
                upcomingSelect.innerHTML = `
                    <option value="">Upcoming: Off</option>
                    <option value="POPULARITY_DESC">Upcoming: Popularity</option>
                    <option value="TRENDING_DESC">Upcoming: Trending</option>
                    <option value="START_DATE">Upcoming: Release Date</option>
                `;
                upcomingSelect.value = stateRef.upcoming;
                upcomingSelect.onchange = (e) => {
                    stateRef.upcoming = e.target.value;
                    resetAndLoad(section);
                };
                container.append(upcomingSelect);
            }

            // --- ADDED YEAR FILTER (Global for Movies/TV/Anime) ---
            const yearSelect = document.createElement('select');
            yearSelect.className = 'filter-select';

            const currentYear = new Date().getFullYear() + 1; // Allow next year for upcoming
            let yearOptions = '<option value="">All Years</option>';
            for (let y = currentYear; y >= 1970; y--) {
                yearOptions += `<option value="${y}">${y}</option>`;
            }
            yearSelect.innerHTML = yearOptions;

            yearSelect.value = stateRef.year;
            yearSelect.onchange = (e) => {
                stateRef.year = e.target.value;
                resetAndLoad(section);
            };
            container.append(yearSelect);
        }

        function resetAndLoad(section) {
            if (section === 'anilist') {
                appState.anilist.page = 1;
                loadAnilistSection();
            } else {
                appState.tmdb[section].page = 1;
                const endpoint = section === 'movies' ? '/discover/movie' : '/discover/tv';
                loadTMDBSection(section, endpoint);
            }
        }

        /**
         * TMDB API
         */
        async function fetchTMDB(endpoint, params = {}, showLoader = true) {
            if (showLoader) loader.show();
            params.api_key = API_KEY;
            const qs = new URLSearchParams(params).toString();
            try {
                const res = await fetch(`${TMDB_BASE_URL}${endpoint}?${qs}`);
                const data = await res.json();
                if (showLoader) loader.hide();
                return data;
            } catch (e) {
                console.error("TMDB Error", e);
                if (showLoader) loader.hide();
                return null;
            }
        }

        async function fetchTMDBLogo(id, type) {
            try {
                // Determine correct endpoint based on type
                // Anime from Anilist might strictly be 'anime' type in our appState, 
                // but we need to know if we can find a TMDB equivalent or if wait, 
                // Anilist doesn't track TMDB IDs easily unless we mapped them.
                // For this implementation, we will primarily support Movies/TV from TMDB.
                // If the item has a 'media_type' of 'anime', we might skip or try to search. 
                // BUT, our bannerItems coming from mappedAnilist have type 'anime'.
                // For now, let's focus on 'movie' and 'tv'. 

                let tmdbType = type;
                if (type === 'anime') return null; // Skip for now unless we have a mapping

                const data = await fetchTMDB(`/${tmdbType}/${id}/images`, { include_image_language: 'en,null' }, false);
                if (data && data.logos && data.logos.length > 0) {
                    // Find the best logo: preferably English, highest vote or width
                    const englishLogos = data.logos.filter(l => l.iso_639_1 === 'en');
                    const bestLogo = englishLogos.length > 0 ? englishLogos[0] : data.logos[0];
                    return bestLogo.file_path;
                }
            } catch (e) {
                console.warn("Logo fetch failed", e);
            }
            return null;
        }

        async function loadHomeData() {
            // Render Continue Watching first
            renderContinueWatching();

            const container = document.getElementById('row-trending');
            if (container.innerHTML !== '') {
                startBannerRotation();
                return;
            }

            // Fetch TMDB Trending
            const trendingTMDBPromise = fetchTMDB('/trending/all/day');

            // Fetch Anilist Trending for Banner
            const anilistQuery = `
            query {
                Page(page: 1, perPage: 6) {
                    media(sort: TRENDING_DESC, type: ANIME, isAdult: false) {
                        id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear genres
                    }
                }
            }`;
            const anilistPromise = fetchAnilist(anilistQuery);

            const topRatedPromise = fetchTMDB('/movie/top_rated');
            const actionPromise = fetchTMDB('/discover/movie', { with_genres: 28 });

            const [trendingTMDB, anilistData, topRated, action] = await Promise.all([
                trendingTMDBPromise,
                anilistPromise,
                topRatedPromise,
                actionPromise
            ]);

            // Combine for Banner: Top 10 TMDB
            let bannerCandidates = [];
            if (trendingTMDB && trendingTMDB.results) {
                renderTMDBGrid('row-trending', trendingTMDB.results, null, true);
                bannerCandidates = [...bannerCandidates, ...trendingTMDB.results.slice(0, 10)];
            }

            // Shuffle once for randomness as requested, but then act as a carousel
            appState.bannerItems = bannerCandidates.sort(() => 0.5 - Math.random());

            // FETCH LOGOS for banner items (Concurrent)
            if (appState.bannerItems.length > 0) {
                // Fire off requests but don't block the initial render completely if possible?
                // Actually, let's just fetch them. It's only ~10 items.
                await Promise.all(appState.bannerItems.map(async (item) => {
                    // Only fetch if TMDB type
                    if (item.media_type === 'movie' || item.media_type === 'tv') {
                        item.logo_path = await fetchTMDBLogo(item.id, item.media_type);
                    }
                }));

                appState.bannerIndex = 0;
                renderBannerIndicators();
                updateSharedBanner();
                startBannerRotation();
            }

            if (topRated) renderTMDBGrid('row-top-rated', topRated.results, null, true);
            if (action) renderTMDBGrid('row-action', action.results, null, true);
        }

        function startBannerRotation() {
            if (appState.bannerInterval) clearInterval(appState.bannerInterval);
            appState.bannerInterval = setInterval(() => {
                nextBanner();
            }, 5000);
        }

        function nextBanner() {
            appState.bannerIndex = (appState.bannerIndex + 1) % appState.bannerItems.length;
            updateSharedBanner();
            startBannerRotation(); // Reset timer on manual interaction
        }

        function prevBanner() {
            appState.bannerIndex = (appState.bannerIndex - 1 + appState.bannerItems.length) % appState.bannerItems.length;
            updateSharedBanner();
            startBannerRotation(); // Reset timer
        }

        function goToBanner(index) {
            appState.bannerIndex = index;
            updateSharedBanner();
            startBannerRotation();
        }

        function renderBannerIndicators() {
            const container = document.getElementById('banner-indicators');
            container.innerHTML = '';
            appState.bannerItems.forEach((_, idx) => {
                const dot = document.createElement('div');
                dot.className = `carousel-indicator ${idx === 0 ? 'active' : ''}`;
                dot.onclick = () => goToBanner(idx);
                container.appendChild(dot);
            });
        }

        function updateSharedBanner() {
            const item = appState.bannerItems[appState.bannerIndex];
            if (!item) return;

            const bgUrl = getBackdropUrl(item.backdrop_path);
            const container = document.getElementById('banner-bg-container');

            // Background Fade Logic
            const newBg = document.createElement('div');
            newBg.className = 'banner-bg-wrapper';
            newBg.style.backgroundImage = `url(${bgUrl})`;
            container.appendChild(newBg);

            // Force reflow
            void newBg.offsetWidth;
            newBg.classList.add('active');

            // Remove old backgrounds
            if (container.children.length > 1) {
                setTimeout(() => {
                    if (container.children.length > 1) {
                        container.removeChild(container.firstElementChild);
                    }
                }, 800); // Match CSS transition duration
            }

            const title = item.title || item.name;
            const desc = item.overview || 'No description available.';
            const type = item.media_type || 'movie';
            const safeTitle = title.replace(/'/g, "");
            const vote = item.vote_average || 0;
            const date = item.release_date || item.first_air_date || '';
            const year = date.split('-')[0] || '';

            const contentDiv = document.getElementById('banner-content');

            // Check History for Resume Status & Button Action
            const historyItem = appState.continueWatching.find(i => i.id === item.id && i.type === type);
            let btnText = "Play Now";
            // Default action: Play S1 E1 immediately
            let playParams = `${item.id}, '${type}', 1, 1`;

            if (historyItem) {
                if (type === 'movie') {
                    btnText = "Resume";
                } else if (type === 'anime') {
                    const e = historyItem.episode || 1;
                    btnText = `Resume E${e}`;
                    playParams = `${item.id}, '${type}', 1, ${e}`;
                } else {
                    // TV
                    const s = historyItem.season || 1;
                    const e = historyItem.episode || 1;
                    btnText = `Resume S${s} E${e}`;
                    playParams = `${item.id}, '${type}', ${s}, ${e}`;
                }
            }

            // Fade out content slightly before changing
            contentDiv.style.opacity = '0';

            setTimeout(() => {
                // LOGO or TITLE Selection
                // Adjusted for better mobile scaling
                let titleHtml = `<h1 class="text-2xl sm:text-3xl md:text-5xl lg:text-6xl font-extrabold mb-4 drop-shadow-xl text-white line-clamp-2 break-words max-w-full">${title}</h1>`;

                if (item.logo_path) {
                    const logoUrl = IMG_URL + item.logo_path;
                    // Responsive logo constraints
                    titleHtml = `<img src="${logoUrl}" alt="${title}" class="max-h-20 sm:max-h-20 md:max-h-44 max-w-[90%] sm:max-w-[60%] mt-6 md:mt-10 object-contain mb-6 drop-shadow-lg origin-left">`;
                }


                // Determine Status and Genres for Watchlist
                let status = item.status || 'Released'; // Default for TMDB if missing
                if (!item.status && (item.release_date || item.first_air_date)) {
                    const d = new Date(item.release_date || item.first_air_date);
                    status = d > new Date() ? 'Upcoming' : 'Released';
                }

                let genres = item.genres || [];
                if (!genres.length && item.genre_ids) {
                    const list = type === 'tv' ? TV_GENRES : MOVIE_GENRES;
                    genres = item.genre_ids.map(id => list.find(g => g.id === id)?.name).filter(Boolean);
                }
                const genresStr = Array.isArray(genres) ? genres.slice(0, 3).join(', ') : 'N/A';

                contentDiv.innerHTML = `
                    ${titleHtml}
                    <div class="flex items-center gap-3 text-sm font-bold text-white mb-4 drop-shadow-md">
                        <span class="text-primary"><i class="fas fa-star text-xs"></i> ${vote.toFixed(1)}</span>
                        <span class="w-1 h-4 bg-white/30 rounded-full"></span>
                        <span>${year}</span>
                        <span class="w-1 h-4 bg-white/30 rounded-full"></span>
                        <span class="uppercase border border-white/40 px-2 py-0.5 rounded textxs">${type}</span>
                    </div>
                    <p class="text-gray-200 text-sm md:text-base mb-8 drop-shadow-md line-clamp-3 max-w-2xl text-shadow-sm font-medium leading-relaxed">${desc}</p>
                    
                    <div class="flex gap-4">
                        <button class="bg-white text-black font-bold py-3 px-8 rounded hover:bg-primary transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(255,255,255,0.3)] flex items-center gap-2 group" onclick="openDetailsWrapper(${playParams})">
                            <i class="fas fa-play text-lg group-hover:scale-110 transition-transform"></i> ${btnText}
                        </button>
                        <button id="banner-watchlist-btn-${item.id}" class="bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center group" onclick="toggleWatchlist(${item.id}, '${type}', '${safeTitle}', '${item.poster_path}', 'banner-watchlist-btn-${item.id}', ${vote}, '${year}', '${desc.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ')}', '${status}', '${genresStr}')">
                           <i class="material-icons group-hover:text-primary transition-colors">bookmark_add</i>
                        </button>
                    </div>
                `;
                contentDiv.style.opacity = '1';
                updateWatchlistButtonState(item.id, `banner-watchlist-btn-${item.id}`);
            }, 300); // Short delay for content fade

            // Update Indicators
            const dots = document.querySelectorAll('.carousel-indicator');
            dots.forEach((d, i) => {
                if (i === appState.bannerIndex) d.classList.add('active');
                else d.classList.remove('active');
            });
        }

        async function loadTMDBSection(key, endpoint, extraParams = {}) {
            const stateRef = appState.tmdb[key];
            const gridId = `grid-${key}`;
            const grid = document.getElementById(gridId);

            loader.show();

            const params = {
                language: 'en-US',
                'vote_count.gte': 0,
                ...extraParams
            };

            // Handle Sorting & Endpoints
            let finalEndpoint = endpoint;

            if (stateRef.filters.sort === 'trending') {
                const type = key === 'movies' ? 'movie' : 'tv';
                finalEndpoint = `/trending/${type}/day`;
            } else {
                params.sort_by = stateRef.filters.sort;
            }

            const today = new Date().toISOString().split('T')[0];

            if (stateRef.filters.status) {
                if (key === 'movies') {
                    if (stateRef.filters.status === 'upcoming') {
                        params['primary_release_date.gte'] = today;
                    } else if (stateRef.filters.status === 'released') {
                        params['primary_release_date.lte'] = today;
                    }
                } else {
                    params.with_status = stateRef.filters.status;
                }
            }

            if ((stateRef.filters.sort.includes('date') || stateRef.filters.sort.includes('first_air_date'))) {
                if (stateRef.filters.status !== 'upcoming') {
                    if (key === 'movies') params['primary_release_date.lte'] = today;
                    else params['first_air_date.lte'] = today;
                }
                delete params['vote_count.gte'];
                params['vote_count.gte'] = 0;
            }

            if (stateRef.filters.genre) params.with_genres = stateRef.filters.genre;
            if (stateRef.filters.country) params.with_origin_country = stateRef.filters.country;

            // --- ADDED YEAR FILTER LOGIC ---
            if (stateRef.filters.year) {
                if (key === 'movies') params.primary_release_year = stateRef.filters.year;
                else params.first_air_date_year = stateRef.filters.year;
            }

            // DOUBLE FETCH LOGIC
            const tmdbPage1 = (stateRef.page - 1) * 2 + 1;
            const tmdbPage2 = tmdbPage1 + 1;

            const p1 = { ...params, page: tmdbPage1 };
            const p2 = { ...params, page: tmdbPage2 };

            const [d1, d2] = await Promise.all([
                fetchTMDB(finalEndpoint, p1, false),
                fetchTMDB(finalEndpoint, p2, false)
            ]);

            const results = [];
            if (d1 && d1.results) results.push(...d1.results);
            if (d2 && d2.results) results.push(...d2.results);

            const totalPagesRef = d1 ? d1.total_pages : (d2 ? d2.total_pages : 0);
            const totalUIPages = Math.ceil(totalPagesRef / 2);

            grid.innerHTML = '';
            if (results.length > 0) {
                // Banner is now handled separately in loadHomeData for the Home view.

                await renderTMDBGrid(gridId, results, key === 'movies' ? 'movie' : 'tv');

                renderPagination(`pag-${key}`, stateRef.page, totalUIPages, (p) => {
                    stateRef.page = p;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    loadTMDBSection(key, endpoint, extraParams);
                });
            } else {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No results found.</p>';
            }
            loader.hide();
        }

        /**
         * ANILIST API
         */
        async function fetchAnilist(query, variables = {}) {
            loader.show();
            try {
                const res = await fetch(ANILIST_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ query, variables })
                });
                const json = await res.json();
                loader.hide();
                return json.data;
            } catch (e) {
                console.error("Anilist Error", e);
                loader.hide();
                return null;
            }
        }

        function mapAnilistToShared(anime) {
            return {
                id: anime.id,
                title: anime.title.english || anime.title.romaji,
                name: anime.title.english || anime.title.romaji,
                overview: anime.description,
                backdrop_path: anime.bannerImage || anime.coverImage.extraLarge,
                poster_path: anime.coverImage.extraLarge,
                vote_average: (anime.averageScore || 0) / 10,
                media_type: 'anime',
                release_date: anime.seasonYear ? String(anime.seasonYear) : (anime.startDate && anime.startDate.year ? String(anime.startDate.year) : 'N/A'),
                status: anime.status,
                genres: anime.genres || []
            };
        }

        // --- NEW: Tab Switching Logic for Anime Section ---
        function switchAnilistTab(tab) {
            appState.anilist.currentTab = tab;
            const animeTab = document.getElementById('anilist-tab-anime');
            const vaTab = document.getElementById('anilist-tab-va');
            const btnAnime = document.getElementById('tab-btn-anime');
            const btnVa = document.getElementById('tab-btn-va');

            if (tab === 'anime') {
                animeTab.classList.remove('hidden');
                vaTab.classList.add('hidden');

                // Active Styles
                btnAnime.classList.add('text-primary', 'border-b-2', 'border-primary');
                btnAnime.classList.remove('text-text-muted', 'hover:text-white');

                // Inactive Styles
                btnVa.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btnVa.classList.add('text-text-muted', 'hover:text-white');

                // Reset Pagination & Load Data
                appState.anilist.page = 1;
                loadAnilistSection();
                loadAnilistSidebars(); // NEW: Load sidebars

            } else {
                animeTab.classList.add('hidden');
                vaTab.classList.remove('hidden');

                // Active Styles
                btnVa.classList.add('text-primary', 'border-b-2', 'border-primary');
                btnVa.classList.remove('text-text-muted', 'hover:text-white');

                // Inactive Styles
                btnAnime.classList.remove('text-primary', 'border-b-2', 'border-primary');
                btnAnime.classList.add('text-text-muted', 'hover:text-white');

                // Reset Pagination & Load Data
                appState.anilist.vaPage = 1;
                loadAnilistVoiceActors();
            }
        }

        async function loadAnilistSection() {
            const state = appState.anilist;
            const gridId = 'grid-anilist';
            const grid = document.getElementById(gridId);

            if (state.filters.sort === 'RECENTLY_UPDATED') {
                const query = `
                query ($page: Int) {
                    Page(page: $page, perPage: 24) {
                        pageInfo { hasNextPage }
                        airingSchedules(sort: TIME_DESC, notYetAired: false) {
                            episode
                            airingAt
                            media {
                                id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear genres isAdult
                            }
                        }
                    }
                }`;
                const data = await fetchAnilist(query, { page: state.page });
                if (data && data.Page.airingSchedules) {
                    // Map AiringSchedules to shared media format
                    // We can optionally use the 'episode' data to show "Ep X" badge if we want
                    state.data = data.Page.airingSchedules.filter(s => !s.media.isAdult).map(schedule => {
                        const media = schedule.media;
                        // Inject the specific recently aired episode number so mapAnilistToShared or renderer can use it?
                        // Currently mapAnilistToShared doesn't look at it, but we can do a quick hack or just return media.
                        // Let's attach it to the media object temporarily if we want to display it.
                        // Actually, mapAnilistToShared is simple. Let's just pass media.
                        return media;
                    });
                    // Remove duplicates if any (though usually rare for consecutive airing schedules of same show in one page unless short form)
                    const uniqueData = [];
                    const seen = new Set();
                    state.data.forEach(m => {
                        if (!seen.has(m.id)) {
                            seen.add(m.id);
                            uniqueData.push(m);
                        }
                    });

                    const mappedData = uniqueData.map(mapAnilistToShared);
                    renderAnilistGrid(gridId, mappedData);
                    document.getElementById('anilist-page-num').innerText = state.page;
                }

            } else {
                const query = `
                query ($page: Int, $sort: [MediaSort], $genre: String, $country: CountryCode, $status: MediaStatus, $year: Int) {
                    Page(page: $page, perPage: 24) {
                        pageInfo { hasNextPage }
                        media(sort: $sort, genre: $genre, countryOfOrigin: $country, status: $status, seasonYear: $year, type: ANIME, isAdult: false) {
                            id title { romaji english } coverImage { extraLarge } bannerImage description averageScore status episodes seasonYear genres
                        }
                    }
                }`;

                const vars = { page: state.page };

                if (state.filters.upcoming) {
                    vars.status = 'NOT_YET_RELEASED';
                    vars.sort = state.filters.upcoming;
                } else {
                    vars.sort = state.filters.sort;
                }

                if (state.filters.genre) vars.genre = state.filters.genre;
                if (state.filters.country) vars.country = state.filters.country;
                if (state.filters.year) vars.year = parseInt(state.filters.year);

                const data = await fetchAnilist(query, vars);
                if (data && data.Page.media) {
                    state.data = data.Page.media;
                    const mappedData = state.data.map(mapAnilistToShared);

                    renderAnilistGrid(gridId, mappedData);
                    document.getElementById('anilist-page-num').innerText = state.page;
                }
            }
        }

        // --- NEW: Anime Sidebars Logic ---
        async function loadAnilistSidebars() {
            const airingContainer = document.getElementById('anilist-top-airing');
            const popularContainer = document.getElementById('anilist-top-popular');

            // Avoid refetching if already populated (simple check)
            if (airingContainer.children.length > 5 && !airingContainer.querySelector('.animate-pulse')) return;

            const query = `
            query {
                airing: Page(page: 1, perPage: 10) {
                    media(sort: TRENDING_DESC, type: ANIME, status: RELEASING, isAdult: false) {
                        id title { romaji english } coverImage { medium } averageScore format episodes
                    }
                }
                popular: Page(page: 1, perPage: 10) {
                    media(sort: POPULARITY_DESC, type: ANIME, isAdult: false) {
                        id title { romaji english } coverImage { medium } averageScore format episodes
                    }
                }
            }`;

            const data = await fetchAnilist(query);
            if (data) {
                if (data.airing && data.airing.media) {
                    renderRankedList(airingContainer, data.airing.media);
                }
                if (data.popular && data.popular.media) {
                    renderRankedList(popularContainer, data.popular.media);
                }
            }
        }

        function renderRankedList(container, items) {
            container.innerHTML = '';
            items.forEach((item, index) => {
                const title = item.title.english || item.title.romaji;
                const score = item.averageScore ? (item.averageScore / 10).toFixed(1) : '??';
                const img = item.coverImage.medium;
                const format = item.format || 'TV';

                const card = document.createElement('div');
                card.className = 'flex gap-3 items-center cursor-pointer group p-2 rounded hover:bg-white/5 transition-colors';
                card.onclick = () => openAnilistDetails(item.id);

                // Rank Color: Top 3 get special colors
                let rankColor = 'text-gray-500';
                if (index === 0) rankColor = 'text-yellow-400';
                else if (index === 1) rankColor = 'text-gray-300';
                else if (index === 2) rankColor = 'text-orange-400';

                card.innerHTML = `
                    <div class="text-2xl font-black ${rankColor} w-10 text-center flex-shrink-0 italic">#${index + 1}</div>
                    <div class="relative w-12 h-16 flex-shrink-0 rounded overflow-hidden shadow-sm">
                        <img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-xs font-bold truncate text-gray-200 group-hover:text-primary transition-colors leading-tight mb-1">${title}</h4>
                        <div class="flex items-center gap-2 text-[10px] text-gray-400">
                             <span class="text-primary"><i class="fas fa-star text-[8px]"></i> ${score}</span>
                             <span></span>
                             <span>${format}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- NEW: Voice Actor Loading Logic ---
        async function loadAnilistVoiceActors() {
            const gridId = 'grid-anilist-va';
            const grid = document.getElementById(gridId);
            const state = appState.anilist;

            const query = `
            query ($page: Int, $search: String) {
                Page(page: $page, perPage: 24) {
                    pageInfo { total perPage currentPage lastPage hasNextPage }
                    staff(search: $search, sort: [FAVOURITES_DESC]) {
                        id
                        name { full }
                        image { large }
                        primaryOccupations
                    }
                }
            }`;

            const vars = { page: state.vaPage };
            if (state.vaSearch && state.vaSearch.trim() !== '') {
                vars.search = state.vaSearch;
            }

            const data = await fetchAnilist(query, vars);

            grid.innerHTML = '';
            if (data && data.Page.staff) {
                state.vaData = data.Page.staff;

                if (state.vaData.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No voice actors found.</p>';
                } else {
                    state.vaData.forEach(staff => {
                        const imgUrl = staff.image ? staff.image.large : 'https://placehold.co/300x450/333/FFF?text=No+Image';
                        const occupations = staff.primaryOccupations ? staff.primaryOccupations[0] : 'Voice Actor';

                        // Using createCardHTML adapted for VA
                        // We use 'actor' type to trigger the round icon logic in standard card creation, 
                        // but since createCardHTML is strict about layout, we'll manually create a nice card for VAs or reuse.
                        // Actually, reusing createCardHTML with type 'actor' works well if we tweak the click handler.

                        const card = createCardHTML(
                            staff.id,
                            'actor', // Visual style
                            staff.name.full,
                            imgUrl,
                            null, // No rating 
                            occupations, // Subtext instead of year
                            '',
                            false,
                            null
                        );

                        // OVERRIDE CLICK for Voice Actor
                        card.onclick = () => openVoiceActorDetails(staff.id);

                        grid.appendChild(card);
                    });
                }

                document.getElementById('anilist-va-page-num').innerText = state.vaPage;
            }
        }

        function changeAnilistPage(dir) {
            const currentPage = parseInt(appState.anilist.page) || 1;
            const next = currentPage + dir;
            if (next > 0) {
                appState.anilist.page = next;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                loadAnilistSection();
            }
        }

        // --- NEW: Voice Actor Pagination ---
        function changeAnilistVAPage(dir) {
            const currentPage = parseInt(appState.anilist.vaPage) || 1;
            const next = currentPage + dir;
            if (next > 0) {
                appState.anilist.vaPage = next;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                loadAnilistVoiceActors();
            }
        }

        // --- NEW: Voice Actor Search Listener ---
        const vaSearchInput = document.getElementById('va-search-input');

        vaSearchInput.addEventListener('keydown', (e) => {
            // Check if the key pressed is 'Enter' (key code 13)
            if (e.key === 'Enter') {
                // Prevent the default behavior of the Enter key (like form submission)
                e.preventDefault();

                // Execute the search function immediately
                appState.anilist.vaSearch = e.target.value;
                appState.anilist.vaPage = 1;
                loadAnilistVoiceActors();
                vaSearchInput.value = '';
            }
        });

        // NEW: Open Anime Details
        async function openAnilistDetails(id) {
            router('anilist-details');
            const state = appState.anilist;
            loader.show();

            const query = `query ($id: Int) { Media(id: $id) { id title { romaji english } 
            description 
            coverImage { extraLarge } 
            bannerImage
            episodes
                    nextAiringEpisode { episode }
                    averageScore
                    format
                    duration
                    status
                    season
                    seasonYear
                    trailer { id site }
                    studios { nodes { name isAnimationStudio } }
                    startDate { year month day }
                    genres
                    description
                    relations { edges { relationType node { id title { romaji } description seasonYear averageScore format status coverImage { extraLarge } genres } } }
                    recommendations(sort: RATING_DESC, perPage: 10) {
                        nodes {
                            mediaRecommendation {
                                id
                                title { romaji english }
                                description
                                coverImage { extraLarge }
                                bannerImage
                                format
                                averageScore
                                status
                                seasonYear
                                genres
                            }
                        }
                    }
                    characters(page: 1, perPage: 25, sort: [ROLE, FAVOURITES_DESC]) {
                    edges {
                    role
                    voiceActors(language: JAPANESE, sort: [FAVOURITES_DESC]) {
                    id
                    name { full } image { medium } }
                    node { id name { userPreferred } image { medium }
                    }
                    }
                }
            } }`;

            const data = await fetchAnilist(query, { id });
            if (!data || !data.Media) { loader.hide(); return; }
            const anime = data.Media;
            state.currentAnime = anime;
            loader.hide();

            // Populate Details View
            const bannerUrl = getBackdropUrl(anime.bannerImage || anime.coverImage.extraLarge);
            document.getElementById('anilist-details-banner').style.backgroundImage = `url(${bannerUrl})`;

            const title = anime.title.english || anime.title.romaji;
            document.getElementById('anilist-details-title').innerText = title;
            document.getElementById('anilist-details-img').src = anime.coverImage.extraLarge;

            const averageScore = anime.averageScore; // Assuming anime.averageScore is a number like 85

            // Check if averageScore is a valid number before calculation
            let score;
            if (typeof averageScore === 'number' && !isNaN(averageScore)) {
                // Convert percentage (0-100) to a 0-10 scale and round to one decimal
                score = (averageScore / 10).toFixed(1);
            } else {
                // Handle cases where it's '??' or not a number
                score = '??';
            }
            document.getElementById('anilist-details-score').innerHTML = `<i class="fas fa-star mr-1"></i> ${score}`;
            document.getElementById('anilist-details-type').innerText = anime.format || 'TV';
            const yearStr = anime.seasonYear || (anime.startDate && anime.startDate.year ? anime.startDate.year : 'N/A');
            document.getElementById('anilist-details-year').innerText = yearStr;

            // Watchlist Button
            const safeTitle = title.replace(/'/g, "");
            const wlBtn = document.getElementById('anilist-details-watchlist-btn');

            // Calculate status for watchlist
            let statusForWl = anime.status ? anime.status.replace(/_/g, ' ') : 'Unknown';
            if (anime.status === 'RELEASING') statusForWl = 'Releasing';
            const genresForWl = anime.genres ? anime.genres.join(', ') : 'N/A';

            wlBtn.onclick = () => toggleWatchlist(anime.id, 'anime', safeTitle, anime.coverImage.extraLarge, 'anilist-details-watchlist-btn', (anime.averageScore || 0) / 10, yearStr, anime.description, statusForWl, genresForWl);
            updateWatchlistButtonState(anime.id, 'anilist-details-watchlist-btn');

            // TRAILER LOGIC
            const existingTrailerBtn = document.getElementById('anilist-trailer-btn');
            if (existingTrailerBtn) existingTrailerBtn.remove();

            const trailerBtn = document.createElement('button');
            trailerBtn.id = "anilist-trailer-btn";

            if (anime.trailer && (anime.trailer.site === 'youtube' || anime.trailer.site === 'YouTube')) {
                trailerBtn.className = "bg-gray-700/50 text-white font-bold py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center gap-2 flex-grow";
                trailerBtn.innerHTML = '<i class="fab fa-youtube text-red-500 text-lg"></i> Trailer';
                trailerBtn.onclick = () => openTrailerModal([{ key: anime.trailer.id, name: 'Main Trailer', site: 'YouTube' }]);
            } else {
                trailerBtn.className = "bg-gray-800/50 text-gray-500 font-bold py-3 px-4 rounded cursor-not-allowed flex items-center justify-center gap-2 flex-grow";
                trailerBtn.innerHTML = '<i class="fab fa-youtube text-gray-500 text-lg"></i> No Trailer';
                trailerBtn.disabled = true;
            }

            // Insert before watchlist button, ensuring we don't duplicate if re-opening
            // Actually the view is re-rendered usually, but `wlBtn.parentNode` is safe
            wlBtn.parentNode.insertBefore(trailerBtn, wlBtn);

            // Metadata
            document.getElementById('anilist-info-desc').innerHTML = anime.description || 'No description available.';
            document.getElementById('anilist-info-Romaji').innerText = anime.title.romaji;
            document.getElementById('anilist-info-Type').innerText = anime.format;
            let anilistStatus = anime.status ? anime.status.replace(/_/g, ' ') : 'Unknown';
            if (anime.status === 'RELEASING') anilistStatus = 'Releasing';
            document.getElementById('anilist-info-Status').innerText = anilistStatus;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            document.getElementById('anilist-info-Date').innerText = anime.startDate && anime.startDate.year ? `${months[anime.startDate.month - 1]} ${anime.startDate.day} ${anime.startDate.year}` : '?';

            const currentAired = anime.nextAiringEpisode ? anime.nextAiringEpisode.episode - 1 : (anime.episodes || '?');
            const totalEps = anime.episodes || '?';
            document.getElementById('anilist-info-Episodes').innerText = `${currentAired} / ${totalEps}`;

            const seas = anime.season ? anime.season.toLowerCase().replace(/\b\w/g, c => c.toUpperCase()) : '';
            document.getElementById('anilist-info-Season').innerText = `${seas} ${anime.seasonYear || ''}`;

            const studios = [];
            const producers = [];
            if (anime.studios && anime.studios.nodes) {
                anime.studios.nodes.forEach(s => {
                    if (s.isAnimationStudio) studios.push(s.name);
                    else producers.push(s.name);
                });
            }
            document.getElementById('anilist-info-Studio').innerText = studios.join(', ') || 'N/A';
            document.getElementById('anilist-info-Producers').innerText = producers.slice(0, 4).join(', ') || 'N/A';

            // Genres
            const genreContainer = document.getElementById('anilist-info-Genres');
            genreContainer.innerText = anime.genres ? anime.genres.join(', ') : 'N/A';

            // Cast
            const castGrid = document.getElementById('anilist-cast-grid');
            castGrid.className = 'flex overflow-x-auto space-x-4 pb-4';
            castGrid.innerHTML = '';
            if (anime.characters && anime.characters.edges) {
                anime.characters.edges.forEach(charEdge => {
                    if (charEdge.voiceActors && charEdge.voiceActors.length > 0) {
                        charEdge.voiceActors.forEach(va => {
                            const el = document.createElement('div');
                            el.className = "flex flex-col gap-2 min-w-[80px] cursor-pointer group";
                            el.onclick = () => openVoiceActorDetails(va.id);
                            const roleDisplay = charEdge.role.charAt(0).toUpperCase() + charEdge.role.slice(1).toLowerCase();
                            el.innerHTML = `
                            <div class="aspect-square rounded-full overflow-hidden border border-border-color w-20 h-20 mx-auto group-hover:border-primary transition-colors">
                                <img src="${va.image.medium}" class="w-full h-full object-cover" alt="Voice Actor Image">
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-text-main font-semibold truncate group-hover:text-primary transition-colors" title="${va.name.full}">${va.name.full}</p>
                                <p class="text-[10px] text-text-muted truncate" title="${charEdge.node.name.userPreferred} (${roleDisplay})">
                                    ${charEdge.node.name.userPreferred} | ${roleDisplay}
                                </p>
                            </div>
                        `;
                            castGrid.appendChild(el);
                        });
                    }
                });
            }
            if (castGrid.innerHTML === '') castGrid.innerHTML = '<p class="text-gray-500 text-xs">No cast info.</p>';

            // Relations
            const relContainer = document.getElementById('anilist-info-Relations-Container');
            const relList = document.getElementById('anilist-info-Relations');
            relList.innerHTML = '';

            if (anime.relations && anime.relations.edges && anime.relations.edges.length > 0) {
                const validRelations = anime.relations.edges.filter(r => r.node.format !== 'MANGA' && r.node.format !== 'NOVEL' && r.node.format !== 'MUSIC' && r.node.format !== 'ONE_SHOT');

                if (validRelations.length > 0) {
                    relContainer.classList.remove('hidden');
                    const relHeader = relContainer.querySelector('h4');
                    if (relHeader) relHeader.innerText = `${anime.title.english || anime.title.romaji} Relations`;

                    validRelations.forEach(edge => {
                        const imgUrl = edge.node.coverImage?.extraLarge || 'https://placehold.co/160x240?text=No+Img';
                        const relYear = edge.node.seasonYear || (edge.node.startDate ? edge.node.startDate.year : '');
                        const relVote = edge.node.averageScore ? edge.node.averageScore / 10 : null;
                        const card = createCardHTML(
                            edge.node.id,
                            'anime',
                            edge.node.title.romaji,
                            imgUrl,
                            relVote,
                            relYear,
                            `<div class="absolute top-2 right-2 bg-card-bg text-white text-[10px] font-bold px-2 py-0.5 rounded border border-primary uppercase shadow-md z-10">${edge.relationType.replace(/_/g, ' ')}</div>`,
                            false,
                            edge.node.description,
                            edge.node.genres ? edge.node.genres.slice(0, 3).join(', ') : '',
                            edge.node.status ? edge.node.status.replace(/_/g, ' ') : ''
                        );
                        relList.appendChild(card);
                    });
                } else relContainer.classList.add('hidden');
            } else relContainer.classList.add('hidden');

            // Recommendations
            const recsGrid = document.getElementById('anilist-recommendations-grid');
            recsGrid.innerHTML = '';
            if (anime.recommendations && anime.recommendations.nodes && anime.recommendations.nodes.length > 0) {
                const recItems = anime.recommendations.nodes
                    .map(n => n.mediaRecommendation).filter(m => m).map(mapAnilistToShared);
                renderAnilistGrid('anilist-recommendations-grid', recItems, true);
            } else {
                recsGrid.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
            }

            // Watch Now Button Action
            // Check continue watching for resume context
            const resumeItem = appState.continueWatching.find(i => i.id === id && i.type === 'anime');
            let startEp = 1;
            let btnText = "PLAY NOW";
            if (resumeItem && resumeItem.episode) {
                startEp = resumeItem.episode;
                btnText = `RESUME EP ${startEp}`;
            }

            const watchBtn = document.getElementById('anilist-watch-now-btn');
            watchBtn.innerHTML = `<i class="fas fa-play mr-2"></i> ${btnText}`;
            watchBtn.onclick = () => openAnilistPlayer(id, startEp);
        }

        // EPISODE LIST HELPERS
        function toggleEpisodeSort() {
            appState.episodeSort = appState.episodeSort === 'asc' ? 'desc' : 'asc';
            const btn = document.getElementById('ep-sort-btn');
            if (btn) btn.innerHTML = `<i class="fas fa-sort mr-1"></i> ${appState.episodeSort === 'asc' ? 'Oldest' : 'Newest'}`;
            // Re-render handled by caller or we can trigger event.
            // For simplicity, we'll just check which player is open and re-render.
            if (!document.getElementById('view-anilist-player').classList.contains('hidden')) {
                if (appState.anilist.currentAnime) openAnilistPlayer(appState.anilist.currentAnime.id, appState.anilist.currentEp);
            } else if (!document.getElementById('tmdb-player-content').innerHTML === "") {
                if (window.renderCurrentTMDBEpisodes) window.renderCurrentTMDBEpisodes();
            }
        }


        function renderEpisodeList(containerId, episodes, type, currentEp, onPlayClick) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            // Normalize episodes to array of objects { number: 1, title: '...', id: ... }
            let data = [];
            if (type === 'anilist') {
                const count = typeof episodes === 'number' ? episodes : 0;
                for (let i = 1; i <= count; i++) {
                    data.push({ number: i, title: `Episode ${i}`, id: i });
                }
            } else {
                // TMDB: episodes is array of objects
                data = episodes.map(e => ({
                    number: e.episode_number,
                    title: e.name,
                    id: e.id,
                    still: e.still_path,
                    overview: e.overview,
                    air_date: e.air_date
                }));
            }

            // SORT
            if (appState.episodeSort === 'desc') {
                data.reverse();
            }

            // Enforce Grid View always
            container.className = 'grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-3 gap-2 p-3 overflow-y-auto custom-scroll flex-1 content-start max-h-96 lg:max-h-full';

            data.forEach(ep => {
                const isCurrent = ep.number == currentEp;
                const wrapper = document.createElement('div');
                wrapper.className = 'relative group w-full';

                // GRID VIEW ONLY
                const btn = document.createElement('button');
                btn.onclick = () => onPlayClick(ep.number);
                btn.className = `w-full p-2 rounded border border-border-color text-xs transition-colors truncate ${isCurrent ? 'bg-primary text-black font-bold border-primary' : 'bg-input-bg text-text-muted hover:border-primary hover:text-primary'}`;
                btn.innerText = ep.number;
                btn.title = ep.title;
                wrapper.appendChild(btn);

                if (type === 'anilist' && appState.anilist.currentAnime && appState.anilist.currentAnime.status === 'RELEASING' && ep.number === data.length) { // Simplified NEW badge
                    // Note: 'data.length' logic only works if sorted ASC
                }
                container.appendChild(wrapper);
            });
        }

        // Updated for separated view
        async function openAnilistPlayer(id, startEpisode = 1) {
            router('anilist-player');
            const state = appState.anilist;
            const targetId = parseInt(id); // Ensure int

            // Clear sensitive UI elements immediately to prevent stale data
            document.getElementById('anilist-player-title').innerText = 'Loading...';
            document.getElementById('anilist-info-Relations').innerHTML = '';
            document.getElementById('anilist-info-Relations-Container').classList.add('hidden');
            document.getElementById('anilist-episodes-grid').innerHTML = '';

            // If we already have the data in state (from Details view), reuse it (unless ID changed)
            // But to be safe, we can re-fetch or check availability. 
            // For robustness, let's allow fetching if currentAnime is null or mismatch.
            // FIXED: Also check if relations exist, otherwise re-fetch (Continue Watching might have stale/partial state if not coming from details)
            if (!state.currentAnime || state.currentAnime.id !== targetId || !state.currentAnime.relations) {
                loader.show();
                const query = `query ($id: Int) { Media(id: $id) { 
                    id 
                    title { romaji english } 
                    coverImage { extraLarge } 
                    bannerImage 
                    episodes 
                    nextAiringEpisode { episode } 
                    status 
                    relations { edges { relationType node { id title { romaji } description seasonYear averageScore format status coverImage { extraLarge } genres } } }
                    recommendations(sort: RATING_DESC, perPage: 10) {
                        nodes {
                            mediaRecommendation {
                                id
                                title { romaji english }
                                description
                                coverImage { extraLarge }
                                bannerImage
                                format
                                averageScore
                                status
                                seasonYear
                                genres
                            }
                        }
                    }
                } }`;
                const data = await fetchAnilist(query, { id });
                if (!data || !data.Media) { loader.hide(); return; }
                state.currentAnime = data.Media;
                loader.hide();
            }

            state.currentEp = startEpisode;
            const anime = state.currentAnime;

            // Setup Player View
            const title = anime.title.english || anime.title.romaji;
            document.getElementById('anilist-player-title').innerText = title;

            // Back Button
            const backBtn = document.getElementById('anilist-player-back-btn');
            if (backBtn) backBtn.onclick = () => openAnilistDetails(id);

            // Server Buttons
            const serverBtnContainer = document.getElementById('anime-server-buttons');
            serverBtnContainer.innerHTML = '';
            ANIME_SOURCES.forEach((src, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === state.currentServerIdx ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                btn.innerHTML = `<i class="fas fa-server mr-2"></i> ${src.name.split(/\s+/).slice(0, 2).join(" ")}`;
                btn.onclick = () => {
                    state.currentServerIdx = idx;
                    Array.from(serverBtnContainer.children).forEach(b => {
                        b.classList.remove('bg-primary', 'text-black');
                        b.classList.add('bg-input-bg', 'text-text-muted');
                    });
                    btn.classList.remove('bg-input-bg', 'text-text-muted');
                    btn.classList.add('bg-primary', 'text-black');
                    playAnilistEp(state.currentEp);
                };
                serverBtnContainer.appendChild(btn);
            });

            // Episodes Grid
            const epGrid = document.getElementById('anilist-episodes-grid');
            epGrid.innerHTML = '';

            if (anime.status === 'NOT_YET_RELEASED') {
                epGrid.innerHTML = '<p class="text-xs text-gray-500">Not Yet Aired</p>';
                return;
            }

            let maxEps = anime.episodes || 12;
            if (anime.nextAiringEpisode) {
                maxEps = anime.nextAiringEpisode.episode - 1;
            }

            if (maxEps === 0) epGrid.innerHTML = '<p class="text-xs text-gray-500">No aired episodes yet.</p>';

            // Use Helper
            // Pass cover image for list view preview
            const coverForList = anime.coverImage ? anime.coverImage.extraLarge : null;
            renderEpisodeList('anilist-episodes-grid', maxEps, 'anilist', state.currentEp, (epNum) => {
                playAnilistEp(epNum);
            }, coverForList);


            // Relations
            const relContainer = document.getElementById('anilist-info-Relations-Container');
            const relList = document.getElementById('anilist-info-Relations');
            relList.innerHTML = '';

            if (anime.relations && anime.relations.edges && anime.relations.edges.length > 0) {
                const validRelations = anime.relations.edges.filter(r => r.node.format !== 'MANGA' && r.node.format !== 'NOVEL' && r.node.format !== 'MUSIC' && r.node.format !== 'ONE_SHOT');

                if (validRelations.length > 0) {
                    relContainer.classList.remove('hidden');
                    const relHeader = relContainer.querySelector('h4');
                    if (relHeader) relHeader.innerText = `${anime.title.english || anime.title.romaji} Relations`;

                    validRelations.forEach(edge => {
                        const imgUrl = edge.node.coverImage?.extraLarge || 'https://placehold.co/160x240?text=No+Img';
                        const relYear = edge.node.seasonYear || (edge.node.startDate ? edge.node.startDate.year : '');
                        const relVote = edge.node.averageScore ? edge.node.averageScore / 10 : null;
                        const card = createCardHTML(
                            edge.node.id,
                            'anime',
                            edge.node.title.romaji,
                            imgUrl,
                            relVote,
                            relYear,
                            `<div class="absolute top-2 right-2 bg-card-bg text-white text-[10px] font-bold px-2 py-0.5 rounded border border-primary uppercase shadow-md z-10">${edge.relationType.replace(/_/g, ' ')}</div>`,
                            false,
                            edge.node.description, // Added overview
                            edge.node.genres ? edge.node.genres.slice(0, 3).join(', ') : '', // Genres
                            edge.node.status ? edge.node.status.replace(/_/g, ' ') : '' // Status for hover
                        );
                        relList.appendChild(card);
                    });
                } else relContainer.classList.add('hidden');
            } else relContainer.classList.add('hidden');

            // Recommendations
            const recsGrid = document.getElementById('anilist-recommendations-grid');
            recsGrid.innerHTML = '';
            if (anime.recommendations && anime.recommendations.nodes && anime.recommendations.nodes.length > 0) {
                const recItems = anime.recommendations.nodes
                    .map(n => n.mediaRecommendation).filter(m => m).map(mapAnilistToShared);
                renderAnilistGrid('anilist-recommendations-grid', recItems, true);
            } else {
                recsGrid.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
            }
            if (maxEps > 0) playAnilistEp(state.currentEp); // Play the requested episode
        }

        function playAnilistEp(ep) {
            appState.anilist.currentEp = ep;
            document.getElementById('anilist-player-ep').innerText = `Episode ${ep}`;
            const source = ANIME_SOURCES[appState.anilist.currentServerIdx];
            const url = source.url(appState.anilist.currentAnime.id, ep);

            document.getElementById('anilist-iframe').src = url;

            // SAVE HISTORY
            // Extract enrichment data
            const overview = appState.anilist.currentAnime.description || '';
            const vote = (appState.anilist.currentAnime.averageScore / 10).toFixed(1) || 0;
            const year = appState.anilist.currentAnime.seasonYear || '';

            addToHistory(
                appState.anilist.currentAnime.id,
                'anime',
                appState.anilist.currentAnime.title.english || appState.anilist.currentAnime.title.romaji,
                appState.anilist.currentAnime.coverImage.extraLarge,
                appState.anilist.currentAnime.bannerImage, // backdrop
                null,
                ep,
                overview, vote, year
            );

            const wrappers = document.getElementById('anilist-episodes-grid').children;
            Array.from(wrappers).forEach(wrapper => {
                const b = wrapper.querySelector('button');
                if (!b) return;
                const btnEpNum = parseInt(b.innerText);
                if (btnEpNum === ep) {
                    // ACTIVE
                    b.classList.remove('bg-input-bg', 'text-text-muted', 'hover:border-primary', 'hover:text-primary');
                    b.classList.add('bg-primary', 'text-black', 'font-bold', 'border-primary');
                } else {
                    // INACTIVE
                    b.classList.add('bg-input-bg', 'text-text-muted', 'hover:border-primary', 'hover:text-primary');
                    b.classList.remove('bg-primary', 'text-black', 'font-bold', 'border-primary');
                }
            });
        }

        function changeAnilistEp(dir) {
            const next = appState.anilist.currentEp + dir;
            if (next > 0) playAnilistEp(next);
        }

        /**
         * SEARCH
         */
        /**
         * SEARCH
         */
        function setupSearchListener(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const val = e.target.value.trim();
                    if (val.length > 0) {
                        // Sync other inputs
                        const otherId = id === 'sidebar-search-input' ? 'mobile-search-input' : 'sidebar-search-input';
                        const otherEl = document.getElementById(otherId);
                        if (otherEl) otherEl.value = val;

                        appState.search.query = val;
                        appState.search.page = 1;
                        performSearch(val, 1);

                        // Close keyboard on mobile
                        el.blur();
                    }
                }
            });
        }

        setupSearchListener('sidebar-search-input');
        setupSearchListener('mobile-search-input');

        async function performSearch(query, page = 1) {
            router('search');
            const grid = document.getElementById('grid-search');
            grid.innerHTML = '<p class="text-gray-400">Searching...</p>';
            document.getElementById('pag-search').innerHTML = ''; // Clear pagination

            const anilistQuery = `query ($search: String, $page: Int) { Page(page: $page, perPage: 20) { pageInfo { lastPage } media(search: $search, type: ANIME, isAdult: false) { id title { romaji english } coverImage { extraLarge } format averageScore episodes status startDate { year } seasonYear description genres } } }`;
            const anilistPromise = fetchAnilist(anilistQuery, { search: query, page: page });
            const tmdbPromise = fetchTMDB('/search/multi', { query, page: page });

            const [anilistRes, tmdbRes] = await Promise.all([anilistPromise, tmdbPromise]);

            // Update Header
            document.getElementById('search-header').innerText = `Search Results for '${query}'`;

            // searchInput.value = ''; // Keep the text
            grid.innerHTML = '';

            let hasResults = false;
            let maxPages = 1;

            if (anilistRes && anilistRes.Page.media) {
                const animeItems = anilistRes.Page.media.map(mapAnilistToShared);
                renderAnilistGrid('grid-search', animeItems, false, true);
                if (animeItems.length > 0) hasResults = true;
                if (anilistRes.Page.pageInfo.lastPage > maxPages) maxPages = anilistRes.Page.pageInfo.lastPage;
            }

            if (tmdbRes && tmdbRes.results) {
                // Modified filter: allow Person, Movie, TV, but EXCLUDE Anime from TMDB results
                const filtered = tmdbRes.results.filter(i => {
                    const isMedia = i.media_type === 'movie' || i.media_type === 'tv' || i.media_type === 'person';
                    // TMDB Anime Detection: Genre 16 (Animation) + Country JP
                    const isAnime = i.genre_ids && i.genre_ids.includes(16) && i.origin_country && i.origin_country.includes('JP');

                    // Allow everything that is Media/Person, BUT if it is anime, block it (unless it's a person, people aren't 'anime')
                    if (i.media_type === 'person') return true;
                    return isMedia && !isAnime;
                });
                await renderTMDBGrid('grid-search', filtered, null, false, true);
                if (filtered.length > 0) hasResults = true;
                if (tmdbRes.total_pages > maxPages) maxPages = tmdbRes.total_pages;
            }

            if (!hasResults) {
                grid.innerHTML = '<p class="text-gray-400">No results found.</p>';
            } else {
                renderPagination('pag-search', page, maxPages, (newPage) => {
                    appState.search.page = newPage;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    performSearch(appState.search.query, newPage);
                });
            }
        }

        /**
         * RENDERERS
         */
        // Updated wrapper to route to new functions
        // If season or ep is provided, it implies a "Resume" or specific play action, so go to Player.
        function openDetailsWrapper(id, type, season, ep) {
            if (season !== undefined || ep !== undefined) {
                if (type === 'anime') openAnilistPlayer(id, ep || 1);
                else openTMDBPlayer(id, type, season || 1, ep || 1);
            } else {
                if (type === 'anime') openAnilistDetails(id);
                else openTMDBDetails(id, type);
            }
        }

        async function fetchAndDetermineStatus(type, id) {
            try {
                const details = await fetchTMDB(`/${type}/${id}`, {}, false);
                return details.status;
            } catch (error) {
                console.error(`Error fetching status for ${type} ID ${id}:`, error);
                return null;
            }
        }

        async function renderTMDBGrid(containerId, items, typeOverride, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            for (const item of items) {
                // If person, use profile_path, else poster_path
                const imgPath = item.poster_path || item.profile_path;
                if (!imgPath) continue;

                // --- NEW ANIME FILTER: Do not render items that are likely anime ---
                // Only check for non-person items. People don't have genre_ids.
                if (item.media_type !== 'person') {
                    if (item.genre_ids && item.genre_ids.includes(16) && item.origin_country && item.origin_country.includes('JP')) {
                        continue;
                    }
                }

                const title = item.title || item.name;
                if (/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f\u3131-\uD79D\uAC00-\uD7A3]/.test(title)) continue;

                const type = typeOverride || (item.media_type || 'movie');
                const date = item.release_date || item.first_air_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(imgPath);
                }

                // Handling for Person Type
                if (type === 'person') {
                    const card = createCardHTML(item.id, 'actor', title, posterUrl, item.popularity, '', '', false, 'Actor');
                    // Override click for actors
                    card.onclick = () => openActorDetails(item.id);
                    container.appendChild(card);
                    continue;
                }

                const tmdbStatus = await fetchAndDetermineStatus(type, item.id);
                let displayStatus = tmdbStatus || item.status;

                if (!displayStatus && (item.release_date || item.first_air_date)) {
                    const releaseDate = new Date(item.release_date || item.first_air_date);
                    const now = new Date();
                    displayStatus = releaseDate > now ? 'Upcoming' : 'Released';
                }

                // Custom Status Overrides
                if (type === 'movie' && displayStatus === 'Released') displayStatus = 'Released';
                if (type === 'tv' && displayStatus === 'Returning Series') displayStatus = 'Releasing';

                const statusBadge = displayStatus ? `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] px-2 py-1 font-bold rounded border border-primary uppercase shadow-md z-10">${displayStatus.replace(/_/g, ' ')}</div>` : '';

                // Genre Mapping
                const genreList = type === 'tv' ? TV_GENRES : MOVIE_GENRES;
                const genres = item.genre_ids ? item.genre_ids.map(id => genreList.find(g => g.id === id)?.name).filter(Boolean).slice(0, 3).join(', ') : '';

                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal, item.overview, genres, displayStatus);
                container.appendChild(card);
            }
        }

        function renderAnilistGrid(containerId, items, isHorizontal = false, append = false) {
            const container = document.getElementById(containerId);
            if (!append) container.innerHTML = '';

            items.forEach(item => {
                if (!item.poster_path) return;
                const title = item.title || item.name;
                const type = 'anime';
                const date = item.release_date || 'N/A';
                const year = date !== 'N/A' ? date.split('-')[0] : '';

                // --- MODIFIED: Use Banner/Backdrop if Horizontal (Landscape) ---
                let posterUrl;
                if (isHorizontal && item.backdrop_path) {
                    posterUrl = item.backdrop_path.startsWith('http') ? item.backdrop_path : IMG_URL + item.backdrop_path;
                } else {
                    posterUrl = getPosterUrl(item.poster_path);
                }

                let aniStatus = item.status ? item.status.replace(/_/g, ' ') : '';
                if (item.status === 'RELEASING') aniStatus = 'Releasing';
                const statusBadge = aniStatus ? `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] px-2 py-1 font-bold rounded border border-primary uppercase shadow-md z-10">${aniStatus}</div>` : '';

                const genres = item.genres ? item.genres.slice(0, 3).join(', ') : '';

                const card = createCardHTML(item.id, type, title, posterUrl, item.vote_average, year, statusBadge, isHorizontal, item.overview, genres, aniStatus);
                container.appendChild(card);
            });
        }

        function createCardHTML(id, type, title, posterUrl, vote, year, statusBadge, isHorizontal, overview, genres, statusText) {
            const card = document.createElement('div');
            const widthClass = isHorizontal ? 'landscape-card' : '';
            card.className = `movie-card rounded cursor-pointer relative group ${widthClass}`;

            const aspectClass = isHorizontal ? 'aspect-video' : 'aspect-[2/3]';

            // Normalize vote
            const numericVote = vote !== null && vote !== undefined && !isNaN(vote) ? Number(vote) : null;
            const voteDisplay = numericVote !== null && numericVote > 0 ? numericVote.toFixed(1) : '0';

            // Safe strings
            const safeTitle = (title || '').replace(/'/g, "");
            const safeYear = year || '';
            const safeOverview = overview ? overview.replace(/"/g, '&quot;') : 'No description available.';
            const isWatchlisted = appState.watchlist.some(i => i.id == id);

            // Generate a unique ID for the watchlist button in this specific card instance
            const btnId = `wl-${id}-${Math.random().toString(36).substr(2, 6)}`;

            card.innerHTML = `
                <div class="${aspectClass} overflow-hidden relative">
                    <img src="${posterUrl}" class="w-full h-full object-cover">
                    
                    ${type !== 'actor' ? statusBadge || '' : ''}

                    <!-- HOVER PLAY ICON OVERLAY -->
                    ${type !== 'actor' ? `
                    <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-20">
                         <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg transform scale-90 group-hover:scale-100 transition-transform duration-300"></i>
                    </div>` : ''}

                     ${type !== 'actor' ? ` <div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-2 py-1 border border-primary rounded font-bold z-10 flex items-center gap-1">
                    ${type === 'season' ? '' : ''} <i class="fas fa-star text-[8px] text-primary"></i> ${voteDisplay} </div> ` : `
                    <div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-2 py-1 border border-primary rounded font-bold z-10">
                        <i class="fas fa-user"></i>
                    </div> ` }

                    <div class="absolute bottom-0 left-0 w-full p-3 card-info">
                        <h3 class="text-text-main text-sm font-semibold truncate md:hover:text-primary transition-colors" title="${title}">
                            ${title}
                        </h3>
                        <div class="flex justify-between items-center text-xs text-text-muted mt-1">
                            <span>${safeYear}</span>
                            <span class="uppercase border border-border-color px-1 rounded text-[10px] truncate max-w-[80px]">
                            ${type}
                            </span>
                        </div>
                    </div>
                </div> `;

            // Main card click
            card.onclick = () => openDetailsWrapper(id, type);

            // HOVER EVENTS FOR GLOBAL CARD
            if (type !== 'actor') {
                const data = { id, type, title, posterUrl, vote: voteDisplay, year: safeYear, overview: safeOverview, numericVote, genres: genres || 'N/A', status: statusText || 'N/A' };
                card.onmouseenter = (e) => {
                    // Clear any pending hide timer
                    if (hoverTimer) clearTimeout(hoverTimer);
                    // Delay opening to prevent flickering on fast scroll
                    hoverTimer = setTimeout(() => showHoverCard(card, data), 400);
                };
                card.onmouseleave = () => {
                    if (hoverTimer) clearTimeout(hoverTimer);
                    hoverTimer = setTimeout(hideHoverCard, 100);
                };
            }

            return card;
        }

        // GLOBAL HOVER CARD LOGIC
        let hoverTimer = null;
        let isHoveringCard = false;

        // Initialize listeners for the global card once DOM is ready (or here if at end of body)
        // Since this script is at end of body, element should exist now.
        const ghCard = document.getElementById('global-hover-card');
        if (ghCard) {
            ghCard.onmouseenter = () => {
                if (hoverTimer) clearTimeout(hoverTimer);
                isHoveringCard = true;
            };
            ghCard.onmouseleave = () => {
                isHoveringCard = false;
                hoverTimer = setTimeout(hideHoverCard, 100);
            };
        }

        function showHoverCard(targetElem, data) {
            // Disable on small screens
            if (window.innerWidth < 1024) return;

            const card = document.getElementById('global-hover-card');
            if (!card) return;

            const rect = targetElem.getBoundingClientRect();
            const cardWidth = 320;
            const cardHeight = 350; // Approx height, will adjust naturally but used for calculation
            const margin = 15;

            // --- POSITIONAL LOGIC ---
            // Preference: Right > Left > Top > Bottom
            // Ensure it touches the side of the card if possible, acting like a tooltip

            let top, left;
            let transformOrigin = 'center';

            const spaceRight = window.innerWidth - rect.right;
            const spaceLeft = rect.left;
            const spaceBottom = window.innerHeight - rect.bottom;
            const spaceTop = rect.top;

            // Vertical Center by default
            let idealTop = rect.top + (rect.height / 2) - (cardHeight / 2);

            // Clamp vertical to viewport
            if (idealTop < margin) idealTop = margin;
            if (idealTop + cardHeight > window.innerHeight - margin) idealTop = window.innerHeight - cardHeight - margin;

            // 1. Try Right
            if (spaceRight >= cardWidth + margin) {
                left = rect.right + margin;
                top = idealTop;
                transformOrigin = 'left center';
            }
            // 2. Try Left
            else if (spaceLeft >= cardWidth + margin) {
                left = rect.left - cardWidth - margin;
                top = idealTop;
                transformOrigin = 'right center';
            }
            // 3. Fallback: Center over the card (Pop-out style) if no side space
            // Or try Top/Bottom? Let's just center it on screen or over card if mobile/tight
            else {
                // If really tight, center horizontally on screen
                left = (window.innerWidth / 2) - (cardWidth / 2);

                // Try Top
                if (spaceTop > cardHeight + margin) {
                    top = rect.top - cardHeight - margin;
                    transformOrigin = 'bottom center';
                }
                // Try Bottom
                else {
                    top = rect.bottom + margin;
                    transformOrigin = 'top center';
                }
            }

            // Final horizontal clamp just in case
            if (left < margin) left = margin;
            if (left + cardWidth > window.innerWidth - margin) left = window.innerWidth - cardWidth - margin;

            // Apply
            card.style.top = `${top}px`;
            card.style.left = `${left}px`;
            card.style.transformOrigin = transformOrigin;

            // Populate Content - NO IMAGE, TEXT ONLY LAYOUT
            const isWatchlisted = appState.watchlist.some(i => i.id == data.id);
            const btnId = `gh-wl-${data.id}`;
            const titleId = `gh-title-${data.id}`;

            // Add click handler to the entire card
            card.onclick = (e) => {
                openDetailsWrapper(data.id, data.type);
            };

            card.innerHTML = `
                <div class="p-5 flex flex-col h-full bg-[#2a2c31] border border-[#444] rounded-lg shadow-2xl relative overflow-hidden">
                    <!-- Background accent (optional) -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-primary/5 blur-[50px] rounded-full -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                    <div id="${titleId}" class="mb-2 z-10 min-h-[40px] flex items-center">
                         <h4 class="text-white font-extrabold text-lg leading-tight line-clamp-2">${data.title}</h4>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs font-semibold text-gray-300 mb-3 z-10">
                        <span class="text-primary flex items-center gap-1"><i class="fas fa-star text-[10px]"></i> ${data.vote}</span>
                        <span class="bg-white/10 px-1.5 py-0.5 rounded text-[10px]">${data.year}</span>
                        <span class="uppercase border border-white/20 px-1.5 py-0.5 rounded text-[10px]">${data.type}</span>
                        <span class="text-gray-400 capitalize">${data.status.toLowerCase().replace(/_/g, ' ')}</span>
                    </div>

                     <div class="text-xs text-text-muted mb-4 z-10">
                        <span class="font-bold text-gray-400">Genre:</span> <span class="text-gray-300">${data.genres}</span>
                    </div>

                    <p class="text-xs text-gray-400 line-clamp-4 leading-relaxed flex-grow z-10 border-t border-white/5 pt-2">${data.overview}</p>
                    
                    <div class="flex gap-2 pt-3 mt-auto z-10">
                         <button onclick="event.stopPropagation(); openDetailsWrapper(${data.id}, '${data.type}', 1, 1)" class="flex-1 bg-white text-black py-2 rounded text-xs font-bold hover:bg-primary hover:text-black transition-colors flex items-center justify-center gap-2 shadow-sm">
                            <i class="fas fa-play"></i> Watch
                        </button>
                        <button id="${btnId}" onclick="event.stopPropagation(); toggleWatchlist(${data.id}, '${data.type}', '${data.title.replace(/'/g, "")}', '${data.posterUrl}', '${btnId}', ${data.numericVote}, '${data.year}', '${data.overview ? data.overview.replace(/'/g, "") : ""}', '${data.status}', '${data.genres}')" class="px-3 py-2 bg-black/40 border border-white/10 text-white rounded hover:bg-white/10 transition-colors flex items-center justify-center" title="Add to Library">
                            ${isWatchlisted ? '<i class="material-icons text-primary">bookmark_added</i>' : '<i class="material-icons">bookmark_add</i>'}
                        </button>
                    </div>
                </div>
            `;

            card.classList.add('visible');
        }

        function hideHoverCard() {
            if (!isHoveringCard) {
                const card = document.getElementById('global-hover-card');
                card.classList.remove('visible');
            }
        }

        function renderPagination(containerId, current, total, callback) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const max = Math.min(total, 500);
            if (max <= 1) return;

            const prev = document.createElement('button');
            prev.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.disabled = current === 1;
            prev.onclick = () => callback(current - 1);

            const next = document.createElement('button');
            next.className = "px-3 py-1 bg-card-bg border border-border-color rounded md:hover:bg-primary md:hover:text-black disabled:opacity-50 text-text-main";
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.disabled = current === max;
            next.onclick = () => callback(current + 1);

            const pageSpan = document.createElement('span');
            pageSpan.className = "px-3 py-1 text-primary font-bold";
            pageSpan.innerText = `${current} / ${max}`;

            container.append(prev, pageSpan, next);
        }

        // NEW: Open TMDB Details View
        async function openTMDBDetails(id, type) {
            try {
                router('tmdb-details');
                const container = document.getElementById('tmdb-details-content');
                container.innerHTML = '';
                loader.show();

                const [details, credits] = await Promise.all([
                    fetchTMDB(`/${type}/${id}`, {}, false),
                    fetchTMDB(`/${type}/${id}/credits`, {}, false)
                ]);

                if (!details) { container.innerHTML = 'Error loading'; loader.hide(); return; }

                // Check history for resume context
                const historyItem = appState.continueWatching.find(i => i.id === id && i.type === type);
                let resumeSeason = 1;
                let resumeEp = 1;
                let btnText = "PLAY NOW";
                if (historyItem && historyItem.season) {
                    resumeSeason = historyItem.season;
                    resumeEp = historyItem.episode;
                    if (type === 'tv') btnText = `RESUME S${resumeSeason} E${resumeEp}`;
                    else btnText = "RESUME";
                }

                const title = details.title || details.name;
                const backdrop = getBackdropUrl(details.backdrop_path);
                const poster = getPosterUrl(details.poster_path);
                const runtime = details.runtime || (details.episode_run_time ? details.episode_run_time[0] : '?') + 'm';

                const cast = credits && credits.cast ? credits.cast.slice(0, 15) : [];
                let castHtml = '<div class="flex overflow-x-auto gap-4 pb-2 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent">';
                if (cast.length > 0) {
                    castHtml += cast.map(c => {
                        const profile = c.profile_path ? `${IMG_URL}${c.profile_path}` : 'https://placehold.co/100x100/333/555?text=No+Img';
                        const safeName = c.name.replace(/['"]/g, '');
                        const safeChar = c.character ? c.character.replace(/['"]/g, '') : '';
                        return `
                            <div class="flex-shrink-0 w-24 text-center cursor-pointer group" onclick="openActorDetails(${c.id})">
                                <img src="${profile}" alt="${safeName}" class="w-20 h-20 rounded-full object-cover mx-auto mb-2 border-2 border-border-color group-hover:border-primary transition-colors">
                                <p class="text-xs font-semibold text-text-main truncate group-hover:text-primary transition-colors" title="${safeName}">${safeName}</p>
                                <p class="text-[10px] text-text-muted truncate" title="${safeChar}">${safeChar}</p>
                            </div>
                        `;
                    }).join('');
                } else {
                    castHtml += '<p class="text-text-muted text-sm">No cast information available.</p>';
                }
                castHtml += '</div>';

                const releaseDate = details.release_date || details.first_air_date || 'N/A';
                const rawDateString = details.release_date || details.first_air_date || null;
                let relDate = 'N/A';
                if (rawDateString) {
                    const dateObject = new Date(rawDateString);
                    relDate = dateObject.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                }
                let status = details.status || 'N/A';
                if (type === 'movie' && status === 'Released') status = 'Released';
                if (type === 'tv' && status === 'Returning Series') status = 'Releasing';
                let genresHtml = details.genres ? details.genres.map(g => g.name).join(', ') : 'N/A';
                const tagline = details.tagline ? `"${details.tagline.replace(/"/g, '&quot;')}"` : '';
                const overview = details.overview ? details.overview.replace(/</g, "&lt;") : 'No overview available.';
                const safeTitle = title.replace(/['"]/g, "");

                container.innerHTML = `
                    <div class="w-full h-[300px] md:h-[600px] bg-cover bg-top bg-center relative" style="background-image: url('${backdrop}')">
                        <div class="absolute inset-0 md:p-12 bg-gradient-to-t from-dark-bg to-transparent"></div>
                    </div>
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-12 -mt-32 md:-mt-48">
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="w-full md:w-[220px] lg:w-[260px] flex-shrink-0 space-y-4">
                                <button onclick="router(appState.lastView || 'home')" class="mb-4 block md:hidden text-gray-300 hover:text-white flex items-center gap-2 text-lg font-medium"><i class="fas fa-angles-left text-lg mr-2"></i> Back</button>
                                <img src="${poster}" class="w-[180px] md:w-full mx-auto md:mx-0 hidden md:block rounded shadow-2xl">
                                
                                    
                                <!-- WATCH NOW BUTTON -->
                                <div class="mb-8 flex items-center gap-4">
                                    <button id="tmdb-watchlist-btn" onclick="toggleWatchlist(${id}, '${type}', '${safeTitle}', '${details.poster_path}', 'tmdb-watchlist-btn', ${details.vote_average}, '${releaseDate.split('-')[0]}', '${overview.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ')}', '${status}', '${genresHtml.replace(/'/g, "\\'")}')" class="bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center"><i class="material-icons">bookmark_add</i></button>
                                </div>
                                    <button id="tmdb-watch-now-btn" class="w-full bg-white text-black font-bold py-3 px-8 rounded hover:bg-primary transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(255,255,255,0.3)] flex items-center justify-center gap-2 flex-grow">
                                        <i class="fas fa-play text-lg group-hover:scale-110 transition-transform"></i> ${btnText}
                                    </button>
                            </div>
                            <div class="flex-1 pt-4 md:pt-16 min-w-0">
                                <button onclick="router(appState.lastView || 'home')" class="mb-4 hidden md:block text-gray-300 hover:text-white flex items-center gap-2 text-lg font-medium"><i class="fas fa-angles-left text-lg mr-2"></i> Back</button>
                                    <div class="flex flex-wrap items-center gap-4 text-sm font-medium text-text-muted mb-4">
                                        <span class="text-primary font-bold"><i class="fas fa-star mr-1"></i> ${details.vote_average.toFixed(1)}</span>
                                        <span class="px-2 py-0.5 border border-border-color rounded">${releaseDate.split('-')[0]}</span>
                                        <span class="uppercase">${type}</span>
                                    </div>
                                    <h1 class="text-2xl md:text-4xl font-extrabold text-white mb-3 leading-tight">${title}</h1>
                                    <p class="text-gray-400 italic text-sm mb-5">${tagline}</p>
                                    <div class="mb-6">
                                        <h3 class="text-lg font-bold text-text-main mb-2">Overview</h3>
                                        <p class="text-text-muted text-sm leading-relaxed whitespace-pre-line max-h-40 overflow-y-auto">${overview}</p>
                                    </div>
                                <div class="bg-card-bg p-4 rounded-md shadow-md text-sm space-y-3 border border-border-color">
                                    <h4 class="font-bold text-text-main border-b border-border-color pb-2">Information</h4>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Type</span><p class="text-text-main text-xs font-medium text-right md:text-left uppercase">${type}</p></div>
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Status</span><p class="text-primary text-xs font-medium text-right md:text-left">${status}</p></div>
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Released</span><p class="text-text-main text-xs font-medium text-right md:text-left">${relDate}</p></div>
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Runtime</span><p class="text-text-main text-xs font-medium text-right md:text-left">${runtime}</p></div>
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Production</span><p class="text-text-main text-xs font-medium text-right md:text-left">${details.production_companies?.[0]?.name || 'N/A'}</p></div>
                                        <div class="flex justify-between md:block"><span class="text-text-muted text-xs">Genres</span><p class="text-text-main text-xs font-medium text-right md:text-left">${genresHtml}</p></div>
                                    </div>
                                    <div class="mb-0"><h3 class="text-lg font-bold text-text-main mb-3">Cast</h3><div class="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">${castHtml}</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                updateWatchlistButtonState(id, 'tmdb-watchlist-btn');
                document.getElementById('tmdb-watch-now-btn').onclick = () => openTMDBPlayer(id, type, resumeSeason, resumeEp);

                const videos = await fetchTMDB(`/${type}/${id}/videos`, {}, false);
                let trailers = [];
                if (videos && videos.results) {
                    // Filter for YouTube trailers
                    trailers = videos.results.filter(v => v.type === 'Trailer' && v.site === 'YouTube');
                }

                const trailerBtn = document.createElement('button');
                if (trailers.length > 0) {
                    trailerBtn.className = "bg-gray-700/50 text-white font-bold py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center gap-2 flex-grow";
                    trailerBtn.innerHTML = '<i class="fab fa-youtube text-red-500 text-lg"></i> Trailer';
                    // Pass the array directly, map if necessary to ensure consistent structure if we use it elsewhere, 
                    // but TMDB result objects {key, name, site} work fine.
                    trailerBtn.onclick = () => openTrailerModal(trailers);
                } else {
                    trailerBtn.className = "bg-gray-800/50 text-gray-500 font-bold py-3 px-4 rounded cursor-not-allowed flex items-center justify-center gap-2 flex-grow";
                    trailerBtn.innerHTML = '<i class="fab fa-youtube text-gray-500 text-lg"></i> No Trailer';
                    trailerBtn.disabled = true;
                }

                // Insert before watchlist button
                const watchlistBtn = document.getElementById('tmdb-watchlist-btn');
                watchlistBtn.parentNode.insertBefore(trailerBtn, watchlistBtn);

            } catch (error) {
                console.error("Error in openTMDBDetails:", error);
                document.getElementById('tmdb-details-content').innerHTML = '<p class="text-center text-red-500 mt-10">An error occurred while loading details.</p>';
            } finally {
                loader.hide();
            }
        }

        // TRAILER MODAL FUNCTIONS
        let currentTrailerList = [];

        function openTrailerModal(videos) {
            const modal = document.getElementById('trailer-modal');
            const iframe = document.getElementById('trailer-iframe');
            const tabsContainer = document.getElementById('trailer-tabs');

            // Normalize input to array
            if (!Array.isArray(videos)) {
                // Legacy fallback if single key string passed (shouldn't happen with updated code)
                videos = [{ key: videos, name: 'Trailer', site: 'YouTube' }];
            }

            currentTrailerList = videos;
            const firstVideo = videos[0];

            if (videos.length > 1) {
                tabsContainer.classList.remove('hidden');
                tabsContainer.innerHTML = '';

                videos.forEach((video, index) => {
                    const btn = document.createElement('button');
                    // Style for active/inactive
                    const baseClass = "px-3 py-1.5 text-xs font-semibold rounded whitespace-nowrap transition-colors border border-transparent";
                    const inactiveClass = "text-gray-400 hover:text-white hover:bg-white/10";
                    const activeClass = "bg-primary text-black border-primary";

                    btn.className = `${baseClass} ${index === 0 ? activeClass : inactiveClass}`;
                    btn.innerText = video.name;

                    btn.onclick = () => {
                        // Switch video
                        iframe.src = `https://www.youtube.com/embed/${video.key}?autoplay=1`;
                        // Update active state
                        Array.from(tabsContainer.children).forEach(c => {
                            c.className = `${baseClass} ${inactiveClass}`;
                        });
                        btn.className = `${baseClass} ${activeClass}`;
                    };

                    tabsContainer.appendChild(btn);
                });
            } else {
                tabsContainer.classList.add('hidden');
            }

            // Play first video
            if (firstVideo) {
                iframe.src = `https://www.youtube.com/embed/${firstVideo.key}?autoplay=1`;
                modal.classList.add('open');
            }
        }

        function closeTrailerModal() {
            const modal = document.getElementById('trailer-modal');
            const iframe = document.getElementById('trailer-iframe');
            iframe.src = '';
            modal.classList.remove('open');
        }

        // NEW: Open TMDB Player View
        async function openTMDBPlayer(id, type, startSeason = 1, startEpisode = 1) {
            try {
                router('tmdb-player');
                const container = document.getElementById('tmdb-player-content');
                // Don't fully clear if we want to preserve state? No, better clear to avoid conflicts.
                container.innerHTML = '';
                loader.show();

                const [details, recommendations] = await Promise.all([
                    fetchTMDB(`/${type}/${id}`, {}, false),
                    fetchTMDB(`/${type}/${id}/recommendations`, {}, false)
                ]);

                if (!details) { container.innerHTML = 'Error loading'; loader.hide(); return; }

                // Check history for resume context
                // Although currently openTMDBPlayer doesn't explicitly use history to SET initial state (it respects startSeason/startEp args),
                // we might want to ensure consistency or use it if specific args aren't passed.
                // But generally, the args passed to openTMDBPlayer ARE from history if applicable.

                // Collection logic
                let collectionData = null;
                if (type === 'movie' && details.belongs_to_collection) {
                    collectionData = await fetchTMDB(`/collection/${details.belongs_to_collection.id}`);
                }

                const title = details.title || details.name;
                const overview = details.overview || '';
                const vote = details.vote_average ? Number(details.vote_average).toFixed(1) : 0;
                const year = (details.release_date || details.first_air_date || '').split('-')[0];

                container.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-12">
                     <button id="tmdb-player-back-btn" onclick="openTMDBDetails(${id}, '${type}')" class="mb-4 text-gray-300 hover:text-white flex items-center gap-2 text-lg font-medium">
    <i class="fas fa-angles-left text-lg mr-2"></i>
    <span class="text-xl md:text-2xl font-extrabold text-white whitespace-nowrap">${title}</span>
</button>

                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Player Container -->
                        <div class="${type === 'tv' ? 'w-full lg:w-3/4' : 'w-full'} rounded overflow-hidden border border-border-color bg-black shadow-xl mb-8 lg:mb-0">
                            <div class="bg-card-bg px-4 py-3 flex flex-wrap gap-3 items-center border-b border-border-color justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-primary font-bold"><i class="fas fa-play-circle mr-2"></i> ${type === 'tv' ? `<span id="tv-player-info">S${startSeason} E${startEpisode}</span>` : ''}</span>
                                </div>
                                <div class="flex gap-2" id="server-buttons"></div>
                            </div>
                            <div class="aspect-video relative bg-black"><iframe id="tmdb-player" src="" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>
                            ${type === 'tv' ? `
                            <div class="bg-card-bg px-4 py-3 flex justify-between items-center border-t border-border-color mt-0 border-x border-b">
                                <button id="btn-tv-prev" class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium"><i class="fas fa-backward mr-1"></i> Prev</button>
                                <button id="btn-tv-next" class="px-4 py-1.5 bg-input-bg hover:bg-primary hover:text-black border border-border-color rounded text-sm transition font-medium">Next <i class="fas fa-forward ml-1"></i></button>
                            </div>
                            ` : ''}
                        </div>

                        <!-- TV SHOW EPISODES SIDEBAR -->
                         ${type === 'tv' ? `
                         <div class="w-full lg:w-1/4 bg-card-bg border border-border-color rounded overflow-hidden relative min-h-0">
                            <div class="w-full h-full flex flex-col lg:absolute lg:inset-0">
                                <div class="p-3 border-b border-border-color bg-input-bg flex justify-between items-center flex-shrink-0">
                                     <div class="flex items-center gap-2">
                                         <h3 class="text-base font-bold text-text-main">Episodes</h3>
                                     </div>
                                     <div class="flex gap-1">
                                     </div>
                                     <h2 id="tv-season-title" class="text-xs font-normal text-text-muted hidden"></h2>
                                </div>
                                <div id="tv-episodes-grid" class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-3 gap-2 p-3 overflow-y-auto custom-scroll flex-1 content-start max-h-96 lg:max-h-full"></div>
                            </div>
                        </div>
                         ` : ''}
                    </div>

                    <!-- TV SHOW SEASONS & EPISODES CONTAINER -->
                     ${type === 'tv' ? `
                        <div id="tv-seasons-container" class="text-sm space-y-3 mt-8">
                            <h4 class="text-lg font-bold text-text-main mb-3">Other Seasons</h4>
                            <div id="tv-seasons-list" class="horizontal-scroll-container p-2"></div>
                        </div>
                     ` : ''}

                    <div id="tmdb-collection-container" class="text-sm space-y-3 ${collectionData ? '' : 'hidden'}">
                        <h4 class="text-lg font-bold text-text-main mb-3 ">${collectionData ? collectionData.name : 'Relations'}</h4>
                        <div id="tmdb-collection-list" class="horizontal-scroll-container p-2"></div>
                    </div>
                    <div class="mt-3 text-sm space-y-3">
                        <h3 id="tmdb-rec-title" class="text-lg font-bold text-text-main mb-3">You may also like</h3>
                        <div id="tmdb-recommendations" class="horizontal-scroll-container p-2"></div>
                    </div>
                </div>
            `;

                // Setup Player
                const iframe = document.getElementById('tmdb-player');
                const serverContainer = document.getElementById('server-buttons');
                const SOURCES = type === 'movie' ? MOVIE_SOURCES : TV_SOURCES;

                let season = startSeason;
                let ep = startEpisode;

                const updatePlayerSource = (sourceObj, id, type, s, e, poster, title, backdrop) => {
                    if (type === 'movie') {
                        iframe.src = sourceObj.url(id);
                        addToHistory(id, type, title, poster, backdrop, null, null, overview, vote, year);
                    } else {
                        iframe.src = sourceObj.url(id, s, e);
                        addToHistory(id, type, title, poster, backdrop, s, e, overview, vote, year);
                    }
                };

                const renderServerButtons = () => {
                    serverContainer.innerHTML = '';
                    SOURCES.forEach((src, idx) => {
                        const btn = document.createElement('button');
                        btn.innerHTML = `<i class="fas fa-server mr-1"></i> ${src.name}`;
                        const isActive = (iframe.src.includes(src.url(id).split('/')[2]) || idx === 0 && iframe.src === ""); // Simple check
                        btn.className = `px-3 py-1 rounded-sm text-xs font-bold transition-colors ${idx === 0 ? 'bg-primary text-black' : 'bg-input-bg text-text-muted hover:text-white'}`;
                        btn.onclick = () => {
                            Array.from(serverContainer.children).forEach(b => {
                                b.className = 'px-3 py-1 rounded text-xs font-bold bg-input-bg text-text-muted hover:text-white transition-colors';
                            });
                            btn.className = 'px-3 py-1 rounded-sm text-xs font-bold bg-primary text-black transition-colors';
                            updatePlayerSource(src, id, type, season, ep, details.poster_path, title, details.backdrop_path);
                        }
                        serverContainer.appendChild(btn);
                    });
                }
                renderServerButtons();

                // TV Logic
                if (type === 'tv') {
                    const loadSeasonData = async (seasonNum) => {
                        season = seasonNum;
                        if (document.getElementById('tv-player-info')) document.getElementById('tv-player-info').innerText = `S${seasonNum} - Episode ${ep}`;

                        renderSeasonsList(details.seasons, seasonNum);

                        loader.show();
                        const epGrid = document.getElementById('tv-episodes-grid');
                        try {
                            const seasonData = await fetchTMDB(`/tv/${id}/season/${seasonNum}`);
                            if (!seasonData) { epGrid.innerHTML = 'Error'; return; }

                            if (document.getElementById('tv-season-title')) {
                                document.getElementById('tv-season-title').innerText = seasonData.name;
                                // document.getElementById('tv-season-title').classList.remove('hidden'); // Removed to keep header clean
                            }

                            if (seasonData.episodes && seasonData.episodes.length > 0) {
                                // STORE CURRENT EPISODES FOR RE-RENDER
                                window.currentTMDBEpisodes = seasonData.episodes;
                                window.renderCurrentTMDBEpisodes = () => {
                                    renderEpisodeList('tv-episodes-grid', window.currentTMDBEpisodes, 'tmdb', ep, (newEp) => {
                                        // On Click Logic
                                        ep = newEp;
                                        if (document.getElementById('tv-player-info')) document.getElementById('tv-player-info').innerText = `S${seasonNum} - Episode ${ep}`;

                                        // Update Start Season/Episode in History to resume correctly
                                        updatePlayerSource(SOURCES[0], id, 'tv', seasonNum, ep, details.poster_path, title, details.backdrop_path);
                                        renderServerButtons();

                                        // Re-render list to update active state
                                        window.renderCurrentTMDBEpisodes();
                                    });

                                };

                                window.renderCurrentTMDBEpisodes();

                            } else epGrid.innerHTML = '<p class="text-gray-500 col-span-full">No episodes found.</p>';
                        } catch (e) { console.error(e); epGrid.innerHTML = '<p class="text-gray-500 col-span-full">Error loading episodes.</p>'; }
                        finally { loader.hide(); }
                    };

                    const renderSeasonsList = (seasons, currentSeasonNum) => {
                        const seasonsContainer = document.getElementById('tv-seasons-list');
                        seasonsContainer.innerHTML = '';
                        const wrapper = document.getElementById('tv-seasons-container');
                        const validSeasons = seasons.filter(s => s.season_number > 0 && s.season_number != currentSeasonNum);

                        if (validSeasons.length === 0) { wrapper.classList.add('hidden'); return; }
                        wrapper.classList.remove('hidden');

                        validSeasons.forEach(s => {
                            const imgUrl = s.poster_path ? IMG_URL + s.poster_path : 'https://placehold.co/160x240?text=No+Img';
                            const showGenres = details.genres ? details.genres.map(g => g.name).slice(0, 3).join(', ') : '';
                            const card = createCardHTML(id, 'season', s.name, imgUrl, s.vote_average ? s.vote_average.toFixed(1) : null, s.air_date ? s.air_date.split('-')[0] : '', `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] font-bold px-2 py-0.5 rounded border border-primary uppercase shadow-md z-10">${s.episode_count} EPS</div>`, false, s.overview, showGenres);
                            card.onclick = () => {
                                ep = 1;
                                loadSeasonData(s.season_number);
                                updatePlayerSource(SOURCES[0], id, 'tv', s.season_number, 1, details.poster_path, title, details.backdrop_path);
                                renderServerButtons();
                            }
                            seasonsContainer.appendChild(card);
                        });
                    };

                    const changeTvEpisode = (dir) => {
                        const nextEp = ep + dir;
                        // Logic simplified to just check bounds if possible, or try to click button?
                        // Better: check currentTMDBEpisodes
                        if (window.currentTMDBEpisodes) {
                            const exists = window.currentTMDBEpisodes.find(e => e.episode_number === nextEp);
                            if (exists) {
                                // Trigger play via helper
                                ep = nextEp;
                                if (document.getElementById('tv-player-info')) document.getElementById('tv-player-info').innerText = `S${season} - Episode ${ep}`;
                                updatePlayerSource(SOURCES[0], id, 'tv', season, ep, details.poster_path, title, details.backdrop_path);
                                renderServerButtons();
                                window.renderCurrentTMDBEpisodes();
                            }
                        }
                    };
                    document.getElementById('btn-tv-prev').onclick = () => changeTvEpisode(-1);
                    document.getElementById('btn-tv-next').onclick = () => changeTvEpisode(1);

                    await loadSeasonData(startSeason);
                    updatePlayerSource(SOURCES[0], id, 'tv', startSeason, startEpisode, details.poster_path, title, details.backdrop_path);
                } else {
                    updatePlayerSource(SOURCES[0], id, 'movie', 1, 1, details.poster_path, title, details.backdrop_path);
                }

                // Recommendations
                const recContainer = document.getElementById('tmdb-recommendations');
                const recTitle = document.getElementById('tmdb-rec-title');
                if (recommendations && recommendations.results && recommendations.results.length > 0) {
                    renderTMDBGrid('tmdb-recommendations', recommendations.results, type, true);
                } else {
                    if (details.genres && details.genres.length > 0) {
                        const genreIds = details.genres.slice(0, 2).map(g => g.id).join(',');
                        if (recTitle) recTitle.innerText = "Recommendation based in Genre";
                        const fbData = await fetchTMDB(`/discover/${type}`, { with_genres: genreIds });
                        if (fbData && fbData.results) renderTMDBGrid('tmdb-recommendations', fbData.results, type, true);
                        else recContainer.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                    } else recContainer.innerHTML = '<p class="text-xs text-gray-500 pl-4">No recommendations found.</p>';
                }

                // Collection
                if (collectionData && collectionData.parts && collectionData.parts.length > 0) {
                    const sortedParts = collectionData.parts.sort((a, b) => new Date(a.release_date || '9999-12-31') - new Date(b.release_date || '9999-12-31'));
                    const colContainer = document.getElementById('tmdb-collection-list');
                    sortedParts.forEach(part => {
                        const imgUrl = part.poster_path ? IMG_URL + part.poster_path : 'https://placehold.co/160x240?text=No+Img';
                        const partGenres = part.genre_ids ? part.genre_ids.map(id => MOVIE_GENRES.find(g => g.id === id)?.name).filter(Boolean).slice(0, 3).join(', ') : '';
                        const card = createCardHTML(part.id, 'movie', part.title, imgUrl, part.vote_average, part.release_date ? part.release_date.split('-')[0] : '', '', false, part.overview, partGenres);
                        colContainer.appendChild(card);
                    });
                }
            } catch (error) {
                console.error("Error in openTMDBPlayer:", error);
                document.getElementById('tmdb-player-content').innerHTML = '<p class="text-center text-red-500 mt-10">An error occurred while loading player.</p>';
            } finally {
                loader.hide();
            }
        }

        async function openActorDetails(id) {
            router('actor');
            const container = document.getElementById('actor-content');
            container.innerHTML = '';
            loader.show();

            const [person, credits, externalIds] = await Promise.all([
                fetchTMDB(`/person/${id}`),
                fetchTMDB(`/person/${id}/combined_credits`),
                fetchTMDB(`/person/${id}/external_ids`)
            ]);

            if (!person) {
                container.innerHTML = '<div class="text-center text-text-muted mt-20">Error loading actor details.</div>';
                loader.hide();
                return;
            }

            const profile = person.profile_path ? IMG_URL + person.profile_path : 'https://placehold.co/300x450/333/FFF?text=No+Image';
            const name = person.name;
            const knownf = person.known_for_department;
            const knownFor = person.known_for_department == "Acting";
            const knownas = person.also_known_as.join(', ') || person.name;
            const birthday = person.birthday;
            const displayBirthday = birthday
                ? new Date(birthday).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                })
                : 'N/A';
            const place = person.place_of_birth || 'N/A';
            const bio = person.biography || 'No biography available.';

            // Sort credits by popularity
            const sortedCredits = credits ? credits.cast.sort((a, b) => b.vote_count - a.vote_count) : [];
            // Remove duplicates
            const uniqueCredits = [];
            const seenIds = new Set();
            sortedCredits.forEach(c => {
                if (!seenIds.has(c.id)) {
                    seenIds.add(c.id);
                    uniqueCredits.push(c);
                }
            });

            // Social Media Links - UPDATED DESIGN
            let socialLinksHtml = '';

            // Changed 'h-50 w-50' to 'h-10 w-10' for a standard size, adjust as needed.
            // Changed 'rounded' to 'rounded-full' for a circular shape.
            const socialBtnClass = 'text-white border-2 border-border-color hover:border-primary text-center mt-2 inline-flex items-center justify-center m-0.5 px-3 py-2 h-10 w-10 rounded-full bg-card-bg text-xs font-bold transition-colors';

            if (externalIds) {
                if (externalIds.imdb_id) {
                    // Removed redundant classes within the specific link definitions
                    socialLinksHtml += `<a href="https://www.imdb.com/name/${externalIds.imdb_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-imdb text-lg"></i></a>`;
                }
                if (externalIds.facebook_id) {
                    socialLinksHtml += `<a href="https://facebook.com/${externalIds.facebook_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-facebook text-lg"></i></a>`;
                }
                if (externalIds.instagram_id) {
                    socialLinksHtml += `<a href="https://instagram.com/${externalIds.instagram_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-instagram text-lg"></i></a>`;
                }
                if (externalIds.twitter_id) {
                    socialLinksHtml += `<a href="https://twitter.com/${externalIds.twitter_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-twitter text-lg"></i></a>`;
                }
                if (externalIds.tiktok_id) {
                    socialLinksHtml += `<a href="https://tiktok.com/@${externalIds.tiktok_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-tiktok text-lg"></i></a>`;
                }
                if (externalIds.youtube_id) {
                    // You didn't finish the last URL, but the class application is correct.
                    socialLinksHtml += `<a href="https://youtube.com/${externalIds.youtube_id}" target="_blank" class="${socialBtnClass}"><i class="fab fa-youtube text-lg"></i></a>`;
                }
            }

            container.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <button onclick="router(appState.lastView || 'home')" class="mb-6 text-gray-300 hover:text-white flex items-center gap-2 text-lg font-medium"><i class="fas fa-angles-left text-lg mr-2"></i> Back</button>
                    
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[300px] flex-shrink-0">
                            <img src="${profile}" class="w-[200px] md:w-full mx-auto md:mx-0 rounded-lg shadow-2xl border border-border-color mb-6">
                            <h1 class="text-3xl md:text-5xl text-center block md:hidden font-extrabold text-white">${name}</h1>
                                <div class="gap-2 mb-3 text-center text-primary">${socialLinksHtml || '<span class="text-xs text-text-muted">None social accounts available</span>'}</div>
                            <div class="bg-card-bg p-5 rounded-lg border border-border-color space-y-4">
                                <h3 class="font-bold text-lg text-white border-b border-border-color pb-2">Personal Info</h3>
                                
                                <div><span class="text-text-muted text-xs block">Known For</span><span class="text-sm font-medium">${knownf}</span></div>
                                <div><span class="text-text-muted text-xs block">Gender</span><span class="text-sm font-medium">${person.gender === 1 ? 'Female' : 'Male'}</span></div>
                                <div><span class="text-text-muted text-xs block">Birthday</span><span class="text-sm font-medium">${displayBirthday}</span></div>
                                <div><span class="text-text-muted text-xs block">Place of Birth</span><span class="text-sm font-medium">${place}</span></div>
                                <div><span class="text-text-muted text-xs block">Also known as</span><span class="text-sm font-medium">${knownas}</span></div>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <h1 class="text-3xl md:text-5xl hidden md:block font-extrabold text-white border-b border-border-color mb-6">${name}</h1>
                            
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-white mb-3">Biography</h3>
                                <p class="text-gray-300 text-sm leading-relaxed whitespace-pre-line max-h-60 overflow-y-auto pr-2 custom-scroll">${bio}</p>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-white mb-4">Known For</h3>
                                <div id="actor-credits-grid" class="results-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (uniqueCredits.length > 0) {
                renderTMDBGrid('actor-credits-grid', uniqueCredits, null, false, true);
            } else {
                document.getElementById('actor-credits-grid').innerHTML = '<p class="text-gray-500">No known credits.</p>';
            }

            loader.hide();
        }

        async function openVoiceActorDetails(id) {
            router('actor');
            const container = document.getElementById('actor-content');
            container.innerHTML = '';
            loader.show();

            const query = `query ($id: Int) {
                Staff(id: $id) {
                    id
                    name { full native }
                    image { large }
                    description
                    gender
                    dateOfBirth { year month day }
                    homeTown
                    age
                    primaryOccupations
                    characterMedia(page: 1, perPage: 50, sort: POPULARITY_DESC) {
                        nodes {
                            id
                            title { romaji english }
                            description
                            coverImage { extraLarge }
                            format
                            averageScore
                            status
                            seasonYear
                            startDate { year }
                            genres
                        }
                    }
                }
            }`;

            const data = await fetchAnilist(query, { id });
            if (!data || !data.Staff) {
                container.innerHTML = '<div class="text-center text-text-muted mt-20">Error loading voice actor details.</div>';
                loader.hide();
                return;
            }

            const staff = data.Staff;
            const profile = staff.image ? staff.image.large : 'https://placehold.co/300x450/333/FFF?text=No+Image';
            const name = staff.name.full;
            const nativeName = staff.name.native || '';

            // --- PARSE BIO LINKS ---
            let bio = staff.description || 'No biography available.';

            // Replace markdown links [Label](URL) with Icon + Label
            bio = bio.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, label, url) => {
                let iconClass = 'fas fa-link';
                const lowerUrl = url.toLowerCase();

                if (lowerUrl.includes('twitter.com') || lowerUrl.includes('x.com')) iconClass = 'fab fa-twitter';
                else if (lowerUrl.includes('instagram.com')) iconClass = 'fab fa-instagram';
                else if (lowerUrl.includes('facebook.com')) iconClass = 'fab fa-facebook';
                else if (lowerUrl.includes('youtube.com') || lowerUrl.includes('youtu.be')) iconClass = 'fab fa-youtube';
                else if (lowerUrl.includes('wikipedia')) iconClass = 'fab fa-wikipedia-w';
                else if (lowerUrl.includes('tiktok.com')) iconClass = 'fab fa-tiktok';
                else if (lowerUrl.includes('ameblo.jp') || lowerUrl.includes('blog')) iconClass = 'fas fa-blog';
                else if (lowerUrl.includes('website')) iconClass = 'fas fa-globe';

                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary hover:text-white inline-flex items-center gap-1 mx-1 font-semibold transition-colors"><i class="${iconClass}"></i> ${label}</a>`;
            });

            // Basic Markdown formatting
            bio = bio.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>');

            let birthday = 'N/A';
            if (staff.dateOfBirth && staff.dateOfBirth.year) {
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const m = staff.dateOfBirth.month ? months[staff.dateOfBirth.month - 1] : '';
                const d = staff.dateOfBirth.day || '';
                const y = staff.dateOfBirth.year || '';
                birthday = `${m} ${d}, ${y}`.replace(/^ ,/, '').trim();
            }

            const place = staff.homeTown || 'N/A';
            const occupations = staff.primaryOccupations && staff.primaryOccupations.length > 0
                ? staff.primaryOccupations.join(', ')
                : 'Voice Actor';

            container.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <button onclick="router(appState.lastView || 'home')" class="mb-6 text-gray-300 hover:text-white flex items-center gap-2 text-lg font-medium"><i class="fas fa-angles-left text-lg mr-2"></i> Back</button>
                    
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-[300px] flex-shrink-0">
                            <img src="${profile}" class="w-[200px] md:w-full mx-auto md:mx-0 rounded-lg shadow-2xl border border-border-color mb-6">
                            <h1 class="text-3xl md:text-5xl block md:hidden text-center font-extrabold text-white mb-6">${name}</h1>
                            
                            <div class="bg-card-bg p-5 rounded-lg border border-border-color space-y-4">
                                <h3 class="font-bold text-lg text-white border-b border-border-color pb-2">Personal Info</h3>
                                <div><span class="text-text-muted text-xs block">Occupations</span><span class="text-sm font-medium">${occupations}</span></div>
                                <div><span class="text-text-muted text-xs block">Gender</span><span class="text-sm font-medium">${staff.gender || 'Unknown'}</span></div>
                                <div><span class="text-text-muted text-xs block">Birthday</span><span class="text-sm font-medium">${birthday}</span></div>
                                <div><span class="text-text-muted text-xs block">Hometown</span><span class="text-sm font-medium">${place}</span></div>
                                ${nativeName ? `<div><span class="text-text-muted text-xs block">Native Name</span><span class="text-sm font-medium">${nativeName}</span></div>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <h1 class="text-3xl md:text-5xl hidden md:block font-extrabold text-white mb-6">${name}</h1>
                            
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-white mb-3">Biography</h3>
                                <div class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap max-h-60 overflow-y-auto pr-2 custom-scroll">${bio}</div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold text-white mb-4">Known For (Voice Roles)</h3>
                                <div id="actor-credits-grid" class="results-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (staff.characterMedia && staff.characterMedia.nodes && staff.characterMedia.nodes.length > 0) {
                const mappedMedia = staff.characterMedia.nodes.map(mapAnilistToShared);
                renderAnilistGrid('actor-credits-grid', mappedMedia, false, false);
            } else {
                document.getElementById('actor-credits-grid').innerHTML = '<p class="text-gray-500">No known credits.</p>';
            }

            loader.hide();
        }

        function updatePlayerSource(sourceObj, id, type, s = 1, e = 1, poster = null, title = "", backdrop = null) {
            const iframe = document.getElementById('tmdb-player');
            if (type === 'movie') {
                iframe.src = sourceObj.url(id);
                addToHistory(id, type, title, poster, backdrop); // Save History
            } else {
                iframe.src = sourceObj.url(id, s, e);
                addToHistory(id, type, title, poster, backdrop, s, e); // Save History with S/E
            }
        }

        function toggleWatchlist(id, type, title, poster, btnId, vote = null, year = null, overview = null, status = null, genres = null) {
            const exists = appState.watchlist.find(i => i.id === id);
            if (exists) {
                appState.watchlist = appState.watchlist.filter(i => i.id !== id);
                showToast('Removed from Library');
            } else {
                // Store vote, year, status, genres to match default card design
                appState.watchlist.push({ id, type, title, poster_path: poster, vote_average: vote, release_date: year, overview: overview, status: status, genres: genres });
                showToast('Added to Library');
            }
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            updateWatchlistButtonState(id, btnId);
        }

        function updateWatchlistButtonState(id, btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            const exists = appState.watchlist.find(i => i.id === id);

            const isHoverCard = btnId.startsWith('gh-wl-');
            const iconClass = isHoverCard ? "material-icons" : "material-icons";

            if (exists) {
                btn.innerHTML = `<i class="${iconClass}">bookmark_added</i>`;
            } else {
                btn.innerHTML = `<i class="${iconClass}">bookmark_add</i>`;
                if (btnId.includes('banner')) {
                    btn.className = "bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center";
                } else {
                    // This else block seems redundant if the class is already set, but preserving logic
                    // Actually, if it's NOT banner, it might be hover card or sidebar or details.
                    // Hover card already has classes set in showHoverCard.
                    // If we overwrite className here, we might break hover card layout if we are not careful.
                    // But the original code was: 
                    // else { btn.className = "bg-gray-700/50 ..."; }
                    // This looks like it was setting the same class for everything else? 
                    // Wait, lines 3845-3846 set the SAME class as banner? 
                    // "bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center"
                    // That class has `p-4` (padding). The hover card button is `px-3 py-2`. 
                    // If this runs, it will break the hover card button style!

                    // Let's protect hover card styles from being overwritten
                    if (!isHoverCard) {
                        btn.className = "bg-gray-700/50 text-white font-bold pt-4 py-3 px-4 rounded shadow-lg hover:bg-gray-600 transition-all flex items-center justify-center";
                    }
                }
            }
        }

        function renderWatchlist() {
            const grid = document.getElementById('grid-watchlist');
            grid.innerHTML = '';
            if (appState.watchlist.length === 0) { grid.innerHTML = '<p class="text-text-muted">Your Library is empty.</p>'; return; }
            appState.watchlist.forEach(item => {
                const posterUrl = getPosterUrl(item.poster_path);

                // Use standard vertical card format
                // Pass stored vote, year, status, genres. If missing, pass defaults.
                let statusBadge = '';
                if (item.status) {
                    const s = item.status.replace(/_/g, ' ');
                    statusBadge = `<div class="absolute top-1.5 right-1.5 bg-black/60 text-white text-[10px] px-2 py-1 font-bold rounded border border-primary uppercase shadow-md z-10">${s}</div>`;
                }

                const card = createCardHTML(
                    item.id,
                    item.type,
                    item.title,
                    posterUrl,
                    item.vote_average, // vote
                    item.release_date,   // year/date
                    statusBadge,   // Status badge
                    false, // Vertical (grid) layout
                    item.overview, // Pass overview
                    item.genres, // Pass genres
                    item.status // Pass raw status text
                );

                // Cleaner Remove Button: Circular, top-right, semi-transparent black
                const removeBtn = document.createElement('button');
                removeBtn.className = "absolute top-1 right-1 z-30 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 transition-colors backdrop-blur-sm shadow-md";
                removeBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                removeBtn.title = "Remove from Library";
                removeBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent card click
                    removeFromWatchlist(item.id);
                };

                card.querySelector('.relative').appendChild(removeBtn); // Append to the main wrapper
                grid.appendChild(card);
            });
        }

        function removeFromWatchlist(id) {
            appState.watchlist = appState.watchlist.filter(i => i.id !== id);
            localStorage.setItem('goStreamWatchlist', JSON.stringify(appState.watchlist));
            showToast('Removed from Library');
            renderWatchlist();
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'bg-white text-black px-6 py-3 rounded-md shadow-xl transform transition-all duration-300 translate-y-10 opacity-0 flex items-center min-w-[200px] border-l-4 border-primary';
            toast.innerHTML = `
                <i class="fas fa-info-circle text-black mr-3 text-lg"></i>
                <span class="font-semibold text-sm">${msg}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        function onDeviceReady() {
            console.log("Cordova Device Ready");
            var originalOpen = window.open;
            window.open = function (url, target, options) {
                return cordova.InAppBrowser ? cordova.InAppBrowser.open(url, '_self', options) : originalOpen(url, '_self', options);
            };
        }
        document.addEventListener('deviceready', onDeviceReady, false);

        // Close Modals on Outside Click
        window.onclick = function (event) {
            const moreMenuModal = document.getElementById('more-menu-modal'); // Mobile More Menu
            if (event.target === moreMenuModal) toggleMoreMenu();
        }

        function toggleMoreMenu() {
            const modal = document.getElementById('more-menu-modal');
            const content = document.getElementById('more-menu-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                });
            } else {
                modal.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        /**
         * SIDEBAR COLLAPSE LOGIC
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const labels = document.querySelectorAll('.sidebar-label');
            const logoText = document.getElementById('sidebar-logo-text');
            const logoIcon = document.querySelector('.visible-collapsed');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const searchInput = document.getElementById('sidebar-search-input');
            const navLinks = document.querySelectorAll('#sidebar .nav-link');

            // Current State (check if collapsed)
            const isCollapsed = sidebar.classList.contains('w-20');

            if (isCollapsed) {
                // EXPAND
                sidebar.classList.replace('w-20', 'w-64');
                mainContent.classList.replace('lg:pl-20', 'lg:pl-64');

                logoText.classList.remove('hidden'); // Remove hidden first
                requestAnimationFrame(() => {
                    logoText.classList.remove('opacity-0', 'w-0');
                    labels.forEach(l => l.classList.remove('opacity-0', 'hidden'));
                });

                logoIcon.classList.add('hidden');
                if (searchInput) searchInput.classList.remove('opacity-0', 'pointer-events-none');

                toggleBtn.classList.remove('rotate-180');
                document.body.classList.remove('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', 'false');

                navLinks.forEach(l => l.classList.remove('justify-center'));
            } else {
                // COLLAPSE
                sidebar.classList.replace('w-64', 'w-20');
                mainContent.classList.replace('lg:pl-64', 'lg:pl-20');

                labels.forEach(l => l.classList.add('opacity-0', 'hidden'));
                logoText.classList.add('opacity-0', 'w-0', 'hidden');

                logoIcon.classList.remove('hidden');
                if (searchInput) searchInput.classList.add('opacity-0', 'pointer-events-none');

                toggleBtn.classList.add('rotate-180');
                document.body.classList.add('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', 'true');

                navLinks.forEach(l => l.classList.add('justify-center'));
            }
        }

        // Init Sidebar State
        window.addEventListener('DOMContentLoaded', () => {
            try {
                if (localStorage.getItem('sidebar-collapsed') === 'true') {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        // Disable transitions temporarily
                        sidebar.classList.add('duration-0');
                        const mainContent = document.getElementById('main-content');
                        if (mainContent) mainContent.classList.add('duration-0');

                        toggleSidebar();

                        // Re-enable transitions
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                sidebar.classList.remove('duration-0');
                                if (mainContent) mainContent.classList.remove('duration-0');
                            }, 100);
                        });
                    }
                }
            } catch (e) {
                console.warn("Sidebar init warn:", e);
            }

            // Force router home call to be safe
            setTimeout(() => {
                router('home');
            }, 50);
        });



        /**
         * HISTORY SECTION
         */
        function switchHistoryTab(tab) {
            appState.historyTab = tab;
            renderHistory();
        }

        function getRelativeDate(ts) {
            if (!ts) return 'Unknown Date';
            const date = new Date(ts);
            const now = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            const isToday = date.toDateString() === now.toDateString();
            const isYesterday = date.toDateString() === yesterday.toDateString();

            if (isToday) return 'Today';
            if (isYesterday) return 'Yesterday';

            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function showConfirmation(title, msg, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const titleEl = document.getElementById('confirm-title');
            const msgEl = document.getElementById('confirm-msg');
            const yesBtn = document.getElementById('confirm-yes');

            titleEl.innerText = title;
            msgEl.innerText = msg;

            yesBtn.onclick = () => {
                onConfirm();
                hideConfirmation();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function hideConfirmation() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
        }

        function removeFromHistory(id, event) {
            if (event) event.stopPropagation();
            appState.continueWatching = appState.continueWatching.filter(i => i.id !== id);
            localStorage.setItem('goStreamContinueWatching', JSON.stringify(appState.continueWatching));
            renderHistory();
            showToast('Item removed from history');
        }

        function clearHistory() {
            if (appState.continueWatching.length === 0) return;
            showConfirmation('Clear History', 'Are you sure you want to clear your entire history?', () => {
                appState.continueWatching = [];
                localStorage.setItem('goStreamContinueWatching', JSON.stringify([]));
                renderHistory();
                showToast('History cleared');
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-content');
            if (!container) return;
            container.innerHTML = '';

            // Update Tab Styles
            ['all', 'movie', 'tv', 'anime'].forEach(t => {
                const btn = document.getElementById(`hist-tab-${t}`);
                if (btn) {
                    if (t === appState.historyTab) {
                        btn.className = 'text-sm md:text-lg font-bold text-primary border-b-2 border-primary pb-2 transition-colors whitespace-nowrap';
                    } else {
                        btn.className = 'text-sm md:text-lg font-bold text-text-muted hover:text-white pb-2 transition-colors whitespace-nowrap';
                    }
                }
            });

            // Add Header Controls (Clear History) if not present
            // We need to inject this into the header area, but currently renderHistory only clears 'history-content'.
            // The header is static in HTML. Let's add the button there dynamically or check if we should modify HTML.
            // Modification: modifying HTML to include a container for the button or injecting it here.
            // Let's inject a "Clear History" button at the top of the content if history !empty, or rely on static HTML modification?
            // User asked for "Clear History button in History Header". The static HTML has a header. 
            // Better to update the static HTML for the header to include the button spot, OR just prepend it here.
            // Let's prepend a controls div here.

            const filter = appState.historyTab;
            // Filter and Sort (descending timestamp)
            const history = appState.continueWatching.filter(item => {
                if (filter === 'all') return true;
                return item.type === filter;
            }).sort((a, b) => b.timestamp - a.timestamp);

            const controlsConfig = document.createElement('div');
            controlsConfig.className = 'flex justify-end mb-4';
            if (history.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'flex items-center text-xs font-bold text-red-500 hover:text-red-400 border border-red-500 hover:border-red-400 rounded px-3 py-1.5 transition-colors';
                clearBtn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i> Clear History';
                clearBtn.onclick = clearHistory;
                controlsConfig.appendChild(clearBtn);
                container.appendChild(controlsConfig);
            }


            if (history.length === 0) {
                container.innerHTML += '<p class="text-gray-400">No history found.</p>';
                return;
            }

            // Group by Date
            const groups = {};
            const dateKeys = [];

            history.forEach(item => {
                const dateKey = getRelativeDate(item.timestamp);
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                    dateKeys.push(dateKey);
                }
                groups[dateKey].push(item);
            });

            // Render Groups
            dateKeys.forEach(dateLabel => {
                // Header
                const header = document.createElement('h3');
                header.className = 'text-lg font-bold text-text-main mb-4 mt-6 first:mt-0';
                header.innerText = dateLabel;
                container.appendChild(header);

                // Grid
                const grid = document.createElement('div');
                grid.className = 'results-grid';

                groups[dateLabel].forEach(item => {
                    const isAnime = item.type === 'anime';
                    const badgeText = isAnime ? `EP ${item.episode || '?'}` : (item.type === 'movie' ? '' : `S${item.season} E${item.episode}`);
                    const badge = badgeText ? `<div class="absolute top-1.5 left-1.5 bg-black/60 text-white text-[10px] px-2 py-1 border border-primary rounded font-bold z-10">${badgeText}</div>` : '';

                    const imgUrl = item.poster ? getPosterUrl(item.poster) : 'https://placehold.co/500x750?text=No+Img';

                    const card = document.createElement('div');
                    card.className = 'movie-card rounded cursor-pointer relative group aspect-[2/3] overflow-hidden'; // Match default card classes

                    // PREPARE HOVER DATA
                    // Use stored data or safe defaults
                    const hoverData = {
                        id: item.id,
                        type: item.type,
                        title: item.title,
                        posterUrl: imgUrl,
                        vote: item.vote ? Number(item.vote).toFixed(1) : 'NR',
                        year: item.year || '',
                        overview: item.overview || 'Resume watching...',
                        numericVote: item.vote ? Number(item.vote) : null
                    };

                    card.onclick = () => {
                        if (item.type === 'movie') openTMDBPlayer(item.id, 'movie');
                        else if (item.type === 'anime') openAnilistPlayer(item.id, item.episode, item.description, item.averageScore, item.year); // Updated to pass more data
                        else openDetailsWrapper(item.id, item.type, item.season, item.episode);
                    };

                    // HOVER EVENTS
                    let hoverTimer;
                    card.onmouseenter = (e) => {
                        if (hoverTimer) clearTimeout(hoverTimer);
                        hoverTimer = setTimeout(() => showHoverCard(card, hoverData), 400);
                    };
                    card.onmouseleave = () => {
                        if (hoverTimer) clearTimeout(hoverTimer);
                        hoverTimer = setTimeout(hideHoverCard, 100);
                    };

                    card.innerHTML = `
                            <img src="${imgUrl}" class="w-full h-full object-cover">
                            
                            <!-- Episode/Season Badge (Left Top) -->
                            ${badge}


                            <!-- Remove Button (Always Visible) -->
                            <button onclick="removeFromHistory(${item.id}, event)" class="absolute top-1.5 right-1.5 z-20 w-7 h-7 rounded-full bg-black/60 hover:bg-red-500 text-white flex items-center justify-center transition-colors shadow-md" title="Remove from History">
                                <i class="fas fa-times text-[12px]"></i>
                            </button>


                            <!-- Info Overlay (Bottom) -->
                            <div class="absolute bottom-0 left-0 w-full p-3 card-info">
                                <h3 class="text-text-main text-sm font-semibold truncate md:hover:text-primary transition-colors">${item.title}</h3>
                                <div class="flex justify-between items-center text-xs uppercase text-text-muted mt-1">
                                    <span class="text-[10px]">Resume</span>
                                    <span class="border border-border-color px-1 rounded text-[10px]">${item.type === 'anime' ? 'Anime' : (item.type === 'movie' ? 'Movie' : 'TV Show')}</span>
                                </div>
                            </div>
                            
                            <!-- Hover Play Overlay -->
                            <div class="absolute inset-0 bg-black/40 opacity-0 md:group-hover:opacity-100 flex items-center justify-center transition-opacity z-10 pointer-events-none">
                                <i class="mdi mdi-play-circle text-primary text-5xl drop-shadow-lg"></i>
                            </div>
                     `;
                    grid.appendChild(card);
                });
                container.appendChild(grid);
            });
        }

    </script>
</body>

</html>
